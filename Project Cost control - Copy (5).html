<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Project Resource Quantifier & Verifier (Cost Control)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for dark mode and smooth transitions */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1f2937; /* Gray-800 */
        }
        /* Hide scrollbar on modal open */
        .modal-open {
            overflow: hidden;
        }

        /* --- CONCISE PRINT REPORT STYLES --- */
        @media print {
            body {
                background-color: #fff;
                color: #000;
            }
            /* Hide non-report elements */
            #app:not(.print-mode) { display: none; }
            #app.print-mode header,
            #app.print-mode #project-manager-view, /* Hide project management form when printing */
            #app.print-mode #resource-manager-view,
            #app.print-mode #toast-container,
            #app.print-mode #delete-modal,
            #app.print-mode .action-buttons,
            #app.print-mode .page-tab,
            #app.print-mode #search-input,
            #app.print-mode .hidden-print {
                display: none !important;
            }

            /* Make report sections visible and full-width */
            #app.print-mode main {
                max-width: none !important;
                padding: 0 !important;
            }
            #app.print-mode #report-view-content {
                display: block !important;
                margin: 0;
                padding: 10mm;
            }

            /* Clean up table styles for print */
            #app.print-mode table {
                width: 100%;
                border-collapse: collapse;
                page-break-inside: auto;
            }
            #app.print-mode table thead {
                display: table-header-group;
                background-color: #f0f0f0;
            }
            #app.print-mode table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            #app.print-mode table th,
            #app.print-mode table td {
                border: 1px solid #ccc;
                padding: 8px;
                font-size: 10pt;
                color: #000; /* Ensure text is black for printing */
            }

            /* KPI and Breakdown formatting */
            #app.print-mode .kpi-card {
                background-color: #fff !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
                color: #000 !important;
                padding: 10px;
            }
            #app.print-mode h1, #app.print-mode h2, #app.print-mode h3 {
                color: #000 !important;
            }
            #app.print-mode .text-4xl, #app.print-mode .text-xl {
                color: #000 !important;
            }
        }
    </style>
</head>

<body class="h-full antialiased text-gray-100">

    <div id="app" class="min-h-full flex flex-col">

        <header class="bg-gray-800 shadow-lg sticky top-0 z-20">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold text-blue-400">Project Cost Control</h1>
                    <div id="project-context" class="text-lg font-medium text-gray-400">
                        Active Project: <span id="current-project-name" class="text-yellow-400">Loading...</span>
                    </div>
                </div>

                <div class="flex space-x-2 sm:space-x-4 border-b border-gray-700 pb-1 overflow-x-auto">
                    <button data-page="projects" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500" data-active="true">
                        <i data-lucide="layers" class="w-4 h-4 inline-block mr-1"></i> Project Manager
                    </button>
                    <button data-page="kpis" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline-block mr-1"></i> Project KPIs
                    </button>
                    <button data-page="manpower" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="users" class="w-4 h-4 inline-block mr-1"></i> Manpower
                    </button>
                    <button data-page="material" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="brick-wall" class="w-4 h-4 inline-block mr-1"></i> Material
                    </button>
                    <button data-page="vehicles" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="truck" class="w-4 h-4 inline-block mr-1"></i> V/E & Tools
                    </button>
                    <button data-page="overheads" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="trending-up" class="w-4 h-4 inline-block mr-1"></i> Overheads
                    </button>
                    <button data-page="report" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="printer" class="w-4 h-4 inline-block mr-1"></i> Print Report
                    </button>
                </div>
            </nav>
        </header>

        <main class="flex-grow max-w-7xl mx-auto p-4 sm:px-6 lg:px-8 flex flex-col gap-6">

            <section id="project-manager-view" class="w-full space-y-6 hidden">
                <h2 class="text-3xl font-bold text-gray-100 border-b border-gray-700 pb-3">Project Management Console</h2>
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl">
                    <h3 id="project-form-title" class="text-xl font-semibold mb-4 text-gray-100"><i data-lucide="plus-circle" class="w-5 h-5 inline-block mr-2 text-blue-400"></i> Add New Project</h3>
                    <form id="project-form" class="space-y-4">
                        <input type="hidden" id="project-id-input">
                        <div>
                            <label for="project-name" class="block text-sm font-medium text-gray-300">Project Name</label>
                            <input type="text" id="project-name" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Highway Bridge Phase I, Commercial Tower Fit-out" required>
                            <p id="project-name-error" class="text-sm text-red-400 mt-1 hidden"></p>
                        </div>
                        <button type="submit" id="project-submit-btn" class="w-full flex justify-center items-center py-3 px-4 rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150 disabled:bg-gray-500">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                            <span id="project-submit-text">Create Project</span>
                        </button>
                        <button type="button" id="project-cancel-btn" class="w-full flex justify-center items-center py-2 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 transition duration-150 hidden">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i> Cancel Edit
                        </button>
                    </form>
                </div>

                <div class="pt-4">
                    <h3 class="text-xl font-semibold text-gray-200 mb-4">Existing Projects</h3>
                    <div id="projects-list" class="space-y-3">
                        <p class="text-gray-500 italic text-center p-4">Loading projects...</p>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-700 space-y-3 hidden-on-print">
                    <h3 class="text-lg font-semibold text-gray-200">Global Data Management</h3>
                    <button id="export-btn" class="w-full flex justify-center items-center py-2 px-4 border border-yellow-500 rounded-lg shadow-sm text-sm font-medium text-yellow-400 bg-gray-800 hover:bg-gray-700 transition duration-150">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export ALL Data (JSON)
                    </button>
                    <label for="import-file" class="w-full flex justify-center items-center py-2 px-4 border border-green-500 rounded-lg shadow-sm text-sm font-medium text-green-400 bg-gray-800 hover:bg-gray-700 cursor-pointer transition duration-150">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import/Merge ALL Data (JSON)
                        <input type="file" id="import-file" accept=".json" class="hidden">
                    </label>
                </div>
            </section>

            <section id="kpis-view" class="w-full space-y-8 p-4 bg-gray-900 rounded-xl hidden">
                <h2 class="text-3xl font-bold text-gray-100 border-b border-gray-700 pb-3">Project Financial KPIs</h2>
                <p id="kpi-project-name" class="text-xl font-medium text-yellow-400"></p>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="kpi-card bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <div class="flex items-center space-x-3"><i data-lucide="gauge" class="w-8 h-8 text-blue-400"></i><h3 class="text-lg font-semibold text-gray-300">Total Planned Cost</h3></div>
                        <p id="kpi-planned-cost" class="text-4xl font-extrabold mt-3 text-blue-400">₹0.00</p>
                        <p class="text-sm mt-1 text-gray-400">Total Cost based on Planned Qty</p>
                    </div>
                    <div class="kpi-card bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <div class="flex items-center space-x-3"><i data-lucide="trending-up" class="w-8 h-8 text-yellow-400"></i><h3 class="text-lg font-semibold text-gray-300">Total Actual Cost</h3></div>
                        <p id="kpi-actual-cost" class="text-4xl font-extrabold mt-3 text-yellow-400">₹0.00</p>
                        <p class="text-sm mt-1 text-gray-400">Total Cost based on Actual Used</p>
                    </div>
                    <div class="kpi-card bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <div class="flex items-center space-x-3"><i data-lucide="wallet" class="w-8 h-8 text-green-400"></i><h3 class="text-lg font-semibold text-gray-300">Cost Saving / Overrun</h3></div>
                        <p id="kpi-cv" class="text-4xl font-extrabold mt-3 text-green-400">₹0.00</p>
                        <p id="kpi-cv-status" class="text-sm mt-1 text-gray-400">Planned Cost - Actual Cost</p>
                    </div>
                    <div class="kpi-card bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <div class="flex items-center space-x-3"><i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i><h3 class="text-lg font-semibold text-gray-300">Cost Performance Index (CPI)</h3></div>
                        <p id="kpi-cpi" class="text-4xl font-extrabold mt-3 text-red-400">0.00</p>
                        <p class="text-sm mt-1 text-gray-400">Measures cost efficiency (Budget / Actual)</p>
                    </div>
                </div>

                <div class="pt-6">
                    <h3 class="text-xl font-semibold text-gray-200 mb-4">Breakdown by Category (Cost)</h3>
                    <div id="category-breakdown" class="space-y-4">
                        <p class="text-gray-500 italic text-center p-4">Select a project to view breakdown.</p>
                    </div>
                </div>
            </section>

            <section id="report-view-content" class="w-full space-y-8 hidden">
                <h2 class="text-3xl font-bold text-gray-100 border-b border-gray-700 pb-3">Project Resource Summary Report</h2>
                <p id="report-project-name" class="text-xl font-medium text-yellow-400"></p>
                <div id="report-kpi-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                
                <h3 class="text-2xl font-bold text-gray-200 mt-8 mb-4">Resource Details</h3>
                <div id="report-resource-tables" class="space-y-8"></div>
                <div class="hidden-print flex justify-center mt-8">
                    <button onclick="window.print()" class="flex items-center py-3 px-6 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-150">
                        <i data-lucide="printer" class="w-5 h-5 mr-2"></i> Generate Print Report (PDF)
                    </button>
                </div>
            </section>


            <div id="resource-manager-view" class="flex flex-col md:flex-row gap-6 hidden">
                <section id="control-panel" class="md:w-full md:max-w-sm flex-shrink-0 bg-gray-800 rounded-xl shadow-2xl p-6 h-fit sticky top-20">
                    <h2 id="form-title" class="text-2xl font-semibold mb-4 text-gray-100"><i data-lucide="plus-circle" class="w-6 h-6 inline-block mr-2 text-blue-400"></i> Add New Resource</h2>
                    <form id="resource-form" class="space-y-4">
                        <input type="hidden" id="item-id">
                        <input type="hidden" id="item-page">

                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300">Resource Name</label>
                            <input type="text" id="title" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Concrete Mixer, Site Engineer, Cement Bag" maxlength="100" required>
                            <p id="title-error" class="text-sm text-red-400 mt-1 hidden"></p>
                        </div>

                        <div>
                            <label for="planned-qty" class="block text-sm font-medium text-gray-300">Planned Quantity (Qty/Hrs)</label>
                            <input type="number" id="planned-qty" min="0" step="any" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 50 (Bags), 120 (Hours), 1 (Unit)" required>
                        </div>

                        <div>
                            <label for="actual-qty" class="block text-sm font-medium text-gray-300">Actual Used Quantity</label>
                            <input type="number" id="actual-qty" min="0" step="any" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 55 (Bags), 130 (Hours), 1 (Unit)" required>
                        </div>

                        <div>
                            <label for="rate" class="block text-sm font-medium text-gray-300">Rate (Cost/Unit) - ₹</label>
                            <input type="number" id="rate" min="0" step="any" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 15.50 (per hour), 50.00 (per unit)" required>
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300">Unit / Details</label>
                            <textarea id="description" rows="3" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., M3, Tons, Hours/Day. Add any verification notes."></textarea>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-500 disabled:cursor-not-allowed">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                            <span id="submit-text">Add Resource</span>
                        </button>
                        <button type="button" id="cancel-btn" class="w-full flex justify-center items-center py-2 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-900 transition duration-150 hidden">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i> Cancel Edit
                        </button>
                    </form>
                </section>

                <section id="list-panel" class="flex-grow w-full">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div class="relative w-full sm:w-3/4">
                            <input type="text" id="search-input" placeholder="Search resources by name or unit..." class="w-full p-3 pl-10 bg-gray-800 border border-gray-700 rounded-xl text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150 placeholder-gray-500">
                            <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        </div>
                    </div>

                    <div id="items-list" class="space-y-4 custom-scrollbar overflow-x-auto">
                        <div id="loading-spinner" class="flex justify-center items-center p-8 text-blue-400">
                            <i data-lucide="loader" class="w-8 h-8 animate-spin mr-2"></i>
                            <span>Loading Resources...</span>
                        </div>
                        <p id="no-items-message" class="text-center text-gray-500 italic p-8 hidden">
                            No resources found for this category. Use the form on the left to add one!
                        </p>
                    </div>
                </section>
            </div>

        </main>

    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2">
        </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none" aria-modal="true" role="dialog">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-all duration-300">
            <div class="text-center">
                <i data-lucide="alert-triangle" class="w-10 h-10 mx-auto text-red-500 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-100 mb-2">Confirm Deletion</h3>
                <p class="text-sm text-gray-400">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">Cancel</button>
                <button id="modal-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">Delete Permanently</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS AND CONFIGURATION ---
            const CURRENCY_SYMBOL = '₹'; // Changed from '$' to '₹'
            const DB_NAME = 'ProjectManagerDB';
            const DB_VERSION = 2; 
            const RESOURCE_STORE = 'items';
            const PROJECT_STORE = 'projects';
            const RESOURCE_PAGES = ['manpower', 'material', 'vehicles', 'overheads'];
            const ALL_PAGES = ['projects', 'kpis', ...RESOURCE_PAGES, 'report'];

            let db;
            let currentProjectId = null;
            let currentProjectName = 'No Project Selected';
            let currentEditId = null; // Used for resource items
            let currentProjectEditId = null; // Used for project items
            let currentDeleteId = null; // Used for modals
            let currentPage = 'projects'; 

            // --- DOM ELEMENTS ---
            const app = document.getElementById('app');
            const projectNameDisplay = document.getElementById('current-project-name');
            const projectManagerView = document.getElementById('project-manager-view');
            const projectList = document.getElementById('projects-list');
            const kpisView = document.getElementById('kpis-view');
            const resourceManagerView = document.getElementById('resource-manager-view');
            
            // Report View elements
            const reportViewContent = document.getElementById('report-view-content');
            const reportKpiSummary = document.getElementById('report-kpi-summary');
            const reportResourceTables = document.getElementById('report-resource-tables');
            
            const itemsList = document.getElementById('items-list');
            const searchInput = document.getElementById('search-input');
            const loadingSpinner = document.getElementById('loading-spinner');
            const noItemsMessage = document.getElementById('no-items-message');

            // Project Form Elements
            const projectForm = document.getElementById('project-form');
            const projectFormTitle = document.getElementById('project-form-title');
            const projectNameInput = document.getElementById('project-name');
            const projectNameError = document.getElementById('project-name-error');
            const projectIdInput = document.getElementById('project-id-input');
            const projectSubmitBtn = document.getElementById('project-submit-btn');
            const projectSubmitText = document.getElementById('project-submit-text');
            const projectCancelBtn = document.getElementById('project-cancel-btn');

            // Resource Form Elements
            const resourceForm = document.getElementById('resource-form');
            const formTitle = document.getElementById('form-title');
            const titleInput = document.getElementById('title');
            const titleError = document.getElementById('title-error');
            const rateInput = document.getElementById('rate'); 
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const cancelBtn = document.getElementById('cancel-btn');

            // Modal Elements
            const deleteModal = document.getElementById('delete-modal');
            const modalDeleteBtn = document.getElementById('modal-delete-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');


            const pageNames = {
                'manpower': 'Manpower Resources', 
                'material': 'Material Resources', 
                'vehicles': 'Vehicles & Equipment', 
                'overheads': 'Overheads & Sundries'
            };

            // --- UI HELPER FUNCTIONS ---

            /** Displays a color-coded toast notification. */
            const showToast = (message, type) => {
                const colors = {
                    success: { bg: 'bg-green-600', icon: 'check-circle' },
                    danger: { bg: 'bg-red-600', icon: 'alert-triangle' },
                    warning: { bg: 'bg-yellow-600', icon: 'alert-circle' }
                };
                const config = colors[type] || colors.success;

                const toast = document.createElement('div');
                toast.className = `flex items-center p-4 rounded-lg shadow-xl text-white ${config.bg} transform translate-x-full transition-transform duration-300`;
                toast.innerHTML = `<i data-lucide="${config.icon}" class="w-5 h-5 mr-3 flex-shrink-0"></i><div class="text-sm font-medium">${message}</div>`;

                lucide.createIcons(); 
                document.getElementById('toast-container').appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                    toast.classList.add('translate-x-0');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-full');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };

            /** Updates the global context display. */
            const updateProjectContext = () => {
                projectNameDisplay.textContent = currentProjectName;

                // Disable resource pages if no project is selected
                const hasProject = currentProjectId !== null;
                RESOURCE_PAGES.forEach(page => {
                    document.querySelector(`[data-page="${page}"]`).disabled = !hasProject;
                });
                document.querySelector(`[data-page="kpis"]`).disabled = !hasProject;
                document.querySelector(`[data-page="report"]`).disabled = !hasProject;
            };
            
            /** Renders the resource items in a table format. */
            const renderItems = (items) => {
                itemsList.innerHTML = '';
                
                if (items.length === 0) {
                    noItemsMessage.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                
                noItemsMessage.classList.add('hidden');
                loadingSpinner.classList.add('hidden');

                // Sort by title alphabetically
                items.sort((a, b) => a.title.localeCompare(b.title));

                let tableHTML = `
                    <div class="overflow-x-auto bg-gray-800 rounded-xl shadow-lg">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Resource / Unit</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Rate (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Planned Qty</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actual Used</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Actual Amount (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Variance (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                `;

                items.forEach(item => {
                    const rate = parseFloat(item.rate) || 0;
                    const plannedQty = parseFloat(item.plannedQty) || 0;
                    const actualQty = parseFloat(item.actualQty) || 0;
                    
                    const plannedAmount = plannedQty * rate;
                    const actualAmount = actualQty * rate;
                    const varianceCost = plannedAmount - actualAmount; 

                    const isOverBudget = actualAmount > plannedAmount;
                    const varianceColor = isOverBudget ? 'text-red-400 font-bold' : 'text-green-400';

                    tableHTML += `
                        <tr class="hover:bg-gray-700 transition duration-100">
                            <td class="px-3 py-2 text-sm font-medium text-gray-100">
                                ${item.title}
                                <p class="text-xs text-gray-400 italic mt-1">${item.description ? item.description.substring(0, 50) + (item.description.length > 50 ? '...' : '') : 'No details provided'}</p>
                            </td>
                            <td class="px-3 py-2 text-sm text-right text-yellow-400">${CURRENCY_SYMBOL}${rate.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-blue-400">${plannedQty.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-gray-200">${actualQty.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right font-semibold text-yellow-300">${CURRENCY_SYMBOL}${actualAmount.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-center ${varianceColor}">${CURRENCY_SYMBOL}${varianceCost.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-center action-buttons">
                                <button data-id="${item.id}" class="edit-btn p-1 text-gray-400 hover:text-yellow-400 transition" title="Edit"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button data-id="${item.id}" class="duplicate-btn p-1 text-gray-400 hover:text-cyan-400 transition" title="Duplicate"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                <button data-id="${item.id}" data-type="resource" class="delete-btn p-1 text-gray-400 hover:text-red-400 transition" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                itemsList.innerHTML = tableHTML;
                lucide.createIcons(); // Initialize Lucide icons
            };

            /** Loads an item's data into the form for editing. */
            const populateFormForEdit = (item) => {
                currentEditId = item.id;
                formTitle.innerHTML = `<i data-lucide="edit" class="w-6 h-6 inline-block mr-2 text-yellow-400"></i> Edit Resource (ID: ${item.id})`;
                document.getElementById('item-id').value = item.id;
                document.getElementById('title').value = item.title;
                document.getElementById('description').value = item.description;
                document.getElementById('planned-qty').value = item.plannedQty;
                document.getElementById('actual-qty').value = item.actualQty;
                document.getElementById('rate').value = item.rate || 0; 
                document.getElementById('item-page').value = item.page;

                submitText.textContent = 'Update Resource';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                cancelBtn.classList.remove('hidden');
                titleInput.focus();
            };

            /** Renders the category breakdown for the KPI view. */
            const renderCategoryBreakdown = (breakdown) => {
                const breakdownDiv = document.getElementById('category-breakdown');
                breakdownDiv.innerHTML = '';
                
                RESOURCE_PAGES.forEach(page => {
                    const data = breakdown[page] || { plannedCost: 0, actualCost: 0, costVariance: 0, items: [] };
                    const costVariance = data.plannedCost - data.actualCost;
                    const varianceColor = costVariance < 0 ? 'text-red-400' : 'text-green-400';

                    breakdownDiv.innerHTML += `
                        <div class="bg-gray-800 p-5 rounded-lg shadow-xl border-l-4 ${costVariance < 0 ? 'border-red-500' : 'border-blue-500'}">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-semibold text-gray-200">${pageNames[page]} (${data.items.length} Items)</h4>
                                <span class="text-sm font-medium ${varianceColor}">Variance: ${CURRENCY_SYMBOL}${costVariance.toFixed(2)}</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 mt-3 text-center">
                                <div><p class="text-xs text-gray-400">Planned Cost</p><p class="text-xl font-bold text-blue-400">${CURRENCY_SYMBOL}${data.plannedCost.toFixed(2)}</p></div>
                                <div><p class="text-xs text-gray-400">Actual Cost</p><p class="text-xl font-bold text-gray-200">${CURRENCY_SYMBOL}${data.actualCost.toFixed(2)}</p></div>
                                <div><p class="text-xs text-gray-400">Cost CPI</p><p class="text-xl font-bold ${data.cpi > 1.05 ? 'text-green-400' : (data.cpi < 0.95 ? 'text-red-400' : 'text-blue-400')}">${data.cpi.toFixed(2)}</p></div>
                            </div>
                            ${costVariance < 0 ? `<p class="text-xs text-red-400 mt-2">❗ Running ${CURRENCY_SYMBOL}${Math.abs(costVariance).toFixed(2)} over planned budget.</p>` : ''}
                        </div>
                    `;
                });
            };

            /** Resets the Project form. */
            const resetProjectForm = () => {
                currentProjectEditId = null;
                projectForm.reset();
                projectFormTitle.innerHTML = `<i data-lucide="plus-circle" class="w-5 h-5 inline-block mr-2 text-blue-400"></i> Add New Project`;
                projectIdInput.value = '';
                projectSubmitText.textContent = 'Create Project';
                projectSubmitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                projectSubmitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                projectCancelBtn.classList.add('hidden');
                projectNameError.classList.add('hidden');
                projectNameInput.classList.remove('border-red-500');
            };

            /** Resets the Resource item form. */
            const resetResourceForm = () => {
                currentEditId = null;
                resourceForm.reset();
                formTitle.innerHTML = `<i data-lucide="plus-circle" class="w-6 h-6 inline-block mr-2 text-blue-400"></i> Add New Resource`;
                document.getElementById('item-id').value = '';
                document.getElementById('item-page').value = currentPage; 
                rateInput.value = ''; 

                submitText.textContent = 'Add Resource';
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                cancelBtn.classList.add('hidden');
                titleError.classList.add('hidden');
                titleInput.classList.remove('border-red-500');
            };


            // --- INDEXEDDB SETUP ---

            /** Initializes the IndexedDB, creating both project and item stores. */
            const initDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        showToast(`DB error: ${event.target.errorCode}`, 'danger');
                        reject('Database error');
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        console.log(`DB v${DB_VERSION} initialized successfully.`);
                        resolve();
                    };

                    // Schema migration/creation
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        
                        // 1. Create Projects Store
                        if (!db.objectStoreNames.contains(PROJECT_STORE)) {
                            db.createObjectStore(PROJECT_STORE, { keyPath: 'id', autoIncrement: true });
                            console.log("Project store created.");
                        }

                        // 2. Create/Update Resource Store
                        if (!db.objectStoreNames.contains(RESOURCE_STORE)) {
                            const itemStore = db.createObjectStore(RESOURCE_STORE, { keyPath: 'id', autoIncrement: true });
                            itemStore.createIndex('page', 'page', { unique: false });
                            itemStore.createIndex('projectId', 'projectId', { unique: false });
                            console.log("Resource store created/updated.");
                        } else {
                            const itemStore = request.transaction.objectStore(RESOURCE_STORE);
                            if (!itemStore.indexNames.contains('projectId')) {
                                itemStore.createIndex('projectId', 'projectId', { unique: false });
                                console.log("Resource store 'projectId' index added.");
                            }
                        }
                    };
                });
            };
            

            // --- PROJECT CRUD OPERATIONS ---

            /** Saves a new project or updates an existing one. */
            const saveProject = async (projectData) => {
                projectSubmitBtn.disabled = true;
                const originalText = projectSubmitText.textContent;
                projectSubmitText.textContent = currentProjectEditId ? 'Updating...' : 'Creating...';
                
                if (!projectData.name.trim()) {
                    projectNameError.textContent = 'Project Name is required.';
                    projectNameError.classList.remove('hidden');
                    projectNameInput.classList.add('border-red-500');
                    projectSubmitBtn.disabled = false;
                    projectSubmitText.textContent = originalText;
                    showToast('Validation failed: Project Name missing.', 'warning');
                    return;
                } else {
                    projectNameError.classList.add('hidden');
                    projectNameInput.classList.remove('border-red-500');
                }

                const transaction = db.transaction([PROJECT_STORE], 'readwrite');
                const store = transaction.objectStore(PROJECT_STORE);

                const project = {
                    name: projectData.name.trim(),
                    timestamp: new Date().toISOString(),
                };

                let request;
                let isUpdate = false;

                if (currentProjectEditId) {
                    project.id = currentProjectEditId;
                    request = store.put(project);
                    isUpdate = true;
                } else {
                    request = store.add(project);
                }

                request.onsuccess = (event) => {
                    const savedId = event.target.result || currentProjectEditId;
                    showToast(`Project ${isUpdate ? 'Updated' : 'Created'} successfully!`, 'success');
                    if (!isUpdate) {
                        loadProject(savedId, project.name);
                    } else if (savedId === currentProjectId) {
                        currentProjectName = project.name;
                        updateProjectContext();
                    }
                    resetProjectForm();
                    loadProjects(); 
                };

                request.onerror = (event) => {
                    console.error("Project Save error:", event.target.error);
                    showToast(`Failed to save project: ${event.target.error}`, 'danger');
                };

                transaction.oncomplete = () => {
                    projectSubmitBtn.disabled = false;
                    projectSubmitText.textContent = isUpdate ? 'Update Project' : 'Create Project';
                };
                transaction.onerror = () => {
                     projectSubmitBtn.disabled = false;
                     projectSubmitText.textContent = isUpdate ? 'Update Project' : 'Create Project';
                }
            };

            /** Loads all projects and renders the list. */
            const loadProjects = async () => {
                projectList.innerHTML = '';
                try {
                    const transaction = db.transaction([PROJECT_STORE], 'readonly');
                    const store = transaction.objectStore(PROJECT_STORE);
                    const request = store.getAll();

                    request.onsuccess = (event) => {
                        const projects = event.target.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Newest first
                        
                        if (projects.length === 0) {
                            projectList.innerHTML = `<p class="text-gray-500 italic text-center p-4">No projects found. Create one above to get started!</p>`;
                            currentProjectId = null;
                            currentProjectName = 'No Project Selected';
                        } else {
                            if (currentProjectId === null || !projects.some(p => p.id === currentProjectId)) {
                                loadProject(projects[0].id, projects[0].name);
                            }
                            renderProjectsList(projects);
                        }
                        updateProjectContext();
                    };

                    request.onerror = (event) => {
                        console.error("Load projects error:", event.target.error);
                        projectList.innerHTML = `<p class="text-red-400">Failed to load projects.</p>`;
                    };
                } catch (e) {
                    console.error("Project load critical error:", e);
                }
            };
            
            /** Renders the list of projects in the Project Manager tab. */
            const renderProjectsList = (projects) => {
                projectList.innerHTML = '';
                
                projects.forEach(project => {
                    const isActive = project.id === currentProjectId;
                    const card = document.createElement('div');
                    card.className = `bg-gray-700 p-4 rounded-lg shadow-md flex justify-between items-center transition duration-200 
                                      ${isActive ? 'border-2 border-blue-500 shadow-blue-800/50' : 'hover:bg-gray-600 border border-gray-700'}`;

                    card.innerHTML = `
                        <div class="flex-grow">
                            <h4 class="text-lg font-bold text-gray-100">${project.name} ${isActive ? '<span class="text-xs text-blue-400 font-normal">(Active)</span>' : ''}</h4>
                            <p class="text-xs text-gray-400 mt-1">
                                ID: ${project.id} | Created/Modified: ${new Date(project.timestamp).toLocaleDateString()}
                            </p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0 ml-4">
                            ${!isActive ? `<button data-id="${project.id}" data-name="${project.name}" class="activate-project-btn p-2 text-green-400 hover:text-green-300 transition" title="Set Active"><i data-lucide="play-circle" class="w-5 h-5"></i></button>` : ''}
                            <button data-id="${project.id}" class="edit-project-btn p-2 text-gray-400 hover:text-yellow-400 transition" title="Edit Project"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                            <button data-id="${project.id}" class="duplicate-project-btn p-2 text-gray-400 hover:text-cyan-400 transition" title="Duplicate Project & Resources"><i data-lucide="copy" class="w-5 h-5"></i></button>
                            <button data-id="${project.id}" data-type="project" class="delete-btn p-2 text-gray-400 hover:text-red-400 transition" title="Delete Project & ALL Resources"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                    `;
                    projectList.appendChild(card);
                });
                lucide.createIcons();
            };

            /** Sets the active project for resource and KPI operations. */
            const loadProject = (id, name) => {
                currentProjectId = id;
                currentProjectName = name;
                showToast(`Project set to: ${name}`, 'warning');
                updateProjectContext();
            };
            
            /** Loads project data into the form for editing. */
            const populateProjectFormForEdit = (project) => {
                currentProjectEditId = project.id;
                projectFormTitle.innerHTML = `<i data-lucide="edit" class="w-5 h-5 inline-block mr-2 text-yellow-400"></i> Edit Project (ID: ${project.id})`;
                projectNameInput.value = project.name;
                projectIdInput.value = project.id;
                projectSubmitText.textContent = 'Update Project';
                projectSubmitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                projectSubmitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                projectCancelBtn.classList.remove('hidden');
            };

            /** Deletes a project and all its associated resources. */
            const deleteProject = async (projectId) => {
                try {
                    // 1. Delete the project entry
                    const projTrans = db.transaction([PROJECT_STORE], 'readwrite');
                    const projStore = projTrans.objectStore(PROJECT_STORE);
                    projStore.delete(projectId);

                    // 2. Delete all linked resources using the index
                    const itemTrans = db.transaction([RESOURCE_STORE], 'readwrite');
                    const itemStore = itemTrans.objectStore(RESOURCE_STORE);
                    const index = itemStore.index('projectId');
                    const range = IDBKeyRange.only(projectId);

                    const deleteReq = index.openCursor(range);
                    deleteReq.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            itemStore.delete(cursor.primaryKey);
                            cursor.continue();
                        }
                    };
                    
                    itemTrans.oncomplete = () => {
                         showToast(`Project (ID: ${projectId}) and all associated resources deleted successfully.`, 'success');
                         closeModal();
                         loadProjects(); // Reload projects and set new context
                    };
                    itemTrans.onerror = (event) => {
                        console.error("Resource deletion error:", event.target.error);
                        showToast(`Failed to delete resources for project ${projectId}.`, 'danger');
                    };

                } catch (e) {
                    console.error("Critical project delete error:", e);
                    showToast(`Critical delete error: ${e.message}`, 'danger');
                }
            };
            
            /** Duplicates a project and all its associated resources. */
            const duplicateProject = async (projectId) => {
                try {
                    // 1. Get the original project
                    const readTrans = db.transaction([PROJECT_STORE, RESOURCE_STORE], 'readonly');
                    const projStore = readTrans.objectStore(PROJECT_STORE);
                    const itemStore = readTrans.objectStore(RESOURCE_STORE);

                    const originalProjectReq = projStore.get(projectId);
                    
                    originalProjectReq.onsuccess = async (event) => {
                        const originalProject = event.target.result;
                        if (!originalProject) {
                            showToast('Original project not found.', 'danger');
                            return;
                        }

                        // 2. Create the new project
                        const newProject = {
                            name: `COPY of ${originalProject.name}`,
                            timestamp: new Date().toISOString(),
                        };
                        
                        const writeTrans = db.transaction([PROJECT_STORE, RESOURCE_STORE], 'readwrite');
                        const writeProjStore = writeTrans.objectStore(PROJECT_STORE);
                        const writeItemStore = writeTrans.objectStore(RESOURCE_STORE);

                        const newProjectReq = writeProjStore.add(newProject);

                        newProjectReq.onsuccess = (e) => {
                            const newProjectId = e.target.result;

                            // 3. Duplicate Resources
                            const index = itemStore.index('projectId');
                            const range = IDBKeyRange.only(projectId);
                            
                            const cursorReq = index.openCursor(range);
                            cursorReq.onsuccess = (cursorEvent) => {
                                const cursor = cursorEvent.target.result;
                                if (cursor) {
                                    const originalItem = cursor.value;
                                    const newItem = {
                                        title: originalItem.title,
                                        description: originalItem.description,
                                        rate: originalItem.rate || 0, // Include rate
                                        plannedQty: originalItem.plannedQty,
                                        actualQty: originalItem.actualQty,
                                        page: originalItem.page,
                                        projectId: newProjectId, // Link to the new project ID
                                        timestamp: new Date().toISOString(),
                                    };
                                    delete newItem.id; // Ensure new auto-incremented ID
                                    writeItemStore.add(newItem);
                                    cursor.continue();
                                }
                            };

                            writeTrans.oncomplete = () => {
                                showToast(`Project duplicated successfully as ${newProject.name}.`, 'success');
                                loadProject(newProjectId, newProject.name);
                                loadProjects();
                            };

                            writeTrans.onerror = (e) => {
                                console.error("Resource duplication error:", e.target.error);
                                showToast('Failed to duplicate resources.', 'danger');
                            };
                        };

                        newProjectReq.onerror = (e) => {
                             console.error("New project save error:", e.target.error);
                             showToast('Failed to create new project entry.', 'danger');
                        };
                    };
                } catch (e) {
                    console.error("Critical project duplication error:", e);
                    showToast(`Critical duplication error: ${e.message}`, 'danger');
                }
            };


            // --- RESOURCE (ITEM) CRUD OPERATIONS (Updated to use projectId) ---

            /** Loads all items for the active project and renders them. */
            const loadItems = async () => {
                if (currentProjectId === null) {
                    itemsList.innerHTML = `<p class="text-red-400 text-center p-8">No project selected. Please select one in the Project Manager tab.</p>`;
                    return;
                }
                if (!RESOURCE_PAGES.includes(currentPage)) return; // Only run for resource pages

                try {
                    loadingSpinner.classList.remove('hidden');
                    const transaction = db.transaction([RESOURCE_STORE], 'readonly');
                    const store = transaction.objectStore(RESOURCE_STORE);
                    const index = store.index('projectId');
                    
                    // Filter by currentProjectId first
                    const projectIdRange = IDBKeyRange.only(currentProjectId);
                    const request = index.getAll(projectIdRange);

                    request.onsuccess = (event) => {
                        const allItems = event.target.result;
                        const searchTerm = searchInput.value.toLowerCase().trim();
                        
                        // Filter by page and then by search term
                        const filteredItems = allItems
                            .filter(item => item.page === currentPage)
                            .filter(item => searchTerm
                                ? (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                                  (item.description && item.description.toLowerCase().includes(searchTerm))
                                : true
                            );

                        renderItems(filteredItems);
                    };

                    request.onerror = (event) => {
                        console.error("Load resource error:", event.target.error);
                        showToast(`Failed to load items: ${event.target.error}`, 'danger');
                        loadingSpinner.classList.add('hidden');
                    };
                } catch (e) {
                    console.error("Load resource critical error:", e);
                    showToast(`Critical resource load error: ${e.message}`, 'danger');
                    loadingSpinner.classList.add('hidden');
                }
            };

            /** Saves a new item or updates an existing one. */
            const saveItem = async (itemData) => {
                if (currentProjectId === null) {
                    showToast('Error: No active project selected. Cannot save resource.', 'danger');
                    return;
                }
                
                submitBtn.disabled = true;
                const originalText = submitText.textContent;
                submitText.textContent = currentEditId ? 'Updating...' : 'Saving...';
                
                // Client-side validation
                if (!itemData.title.trim()) {
                    titleError.textContent = 'Resource Name is required.';
                    titleError.classList.remove('hidden');
                    titleInput.classList.add('border-red-500');
                    submitBtn.disabled = false;
                    submitText.textContent = originalText;
                    showToast('Validation failed: Resource Name missing.', 'warning');
                    return;
                } else {
                    titleError.classList.add('hidden');
                    titleInput.classList.remove('border-red-500');
                }

                const transaction = db.transaction([RESOURCE_STORE], 'readwrite');
                const store = transaction.objectStore(RESOURCE_STORE);

                const item = {
                    title: itemData.title.trim(),
                    description: itemData.description.trim(),
                    rate: parseFloat(itemData.rate) || 0, // NEW: Save Rate
                    plannedQty: parseFloat(itemData.plannedQty) || 0,
                    actualQty: parseFloat(itemData.actualQty) || 0,
                    page: itemData.page || currentPage,
                    projectId: currentProjectId, 
                    timestamp: new Date().toISOString(),
                };

                let request;
                let isUpdate = false;

                if (currentEditId) {
                    item.id = currentEditId; 
                    request = store.put(item);
                    isUpdate = true;
                } else {
                    request = store.add(item);
                }

                request.onsuccess = () => {
                    showToast(`Resource ${isUpdate ? 'Updated' : 'Added'} successfully!`, 'success');
                    resetResourceForm();
                    loadItems(); 
                };

                request.onerror = (event) => {
                    console.error("Save resource error:", event.target.error);
                    showToast(`Failed to save resource: ${event.target.error}`, 'danger');
                };

                transaction.oncomplete = () => {
                    submitBtn.disabled = false;
                    submitText.textContent = isUpdate ? 'Update Resource' : 'Add Resource';
                    if (!isUpdate) resetResourceForm(); 
                };
                transaction.onerror = () => {
                     submitBtn.disabled = false;
                     submitText.textContent = isUpdate ? 'Update Resource' : 'Add Resource';
                }
            };
            
            /** Deletes a single resource item. */
            const deleteResourceItem = (id) => {
                const transaction = db.transaction([RESOURCE_STORE], 'readwrite');
                const store = transaction.objectStore(RESOURCE_STORE);
                const request = store.delete(id);

                request.onsuccess = () => {
                    showToast('Resource item deleted successfully.', 'success');
                    closeModal();
                    loadItems(); 
                    if (currentEditId === id) resetResourceForm(); 
                };

                request.onerror = (event) => {
                    console.error("Delete resource error:", event.target.error);
                    showToast(`Failed to delete resource item: ${event.target.error}`, 'danger');
                    closeModal();
                };
            };
            
            /** Duplicates a single resource item. */
            const duplicateResourceItem = async (id) => {
                try {
                    const transaction = db.transaction([RESOURCE_STORE], 'readonly');
                    const store = transaction.objectStore(RESOURCE_STORE);
                    const request = store.get(id);

                    request.onsuccess = () => {
                        const originalItem = request.result;
                        if (originalItem) {
                            const newItem = {
                                title: `COPY: ${originalItem.title}`,
                                description: originalItem.description,
                                rate: originalItem.rate || 0, // Include rate
                                plannedQty: originalItem.plannedQty,
                                actualQty: originalItem.actualQty,
                                page: originalItem.page,
                                projectId: currentProjectId, 
                                timestamp: new Date().toISOString(),
                            };

                            const writeTransaction = db.transaction([RESOURCE_STORE], 'readwrite');
                            const writeStore = writeTransaction.objectStore(RESOURCE_STORE);
                            const addRequest = writeStore.add(newItem);

                            addRequest.onsuccess = () => {
                                showToast(`Resource duplicated successfully.`, 'warning');
                                loadItems();
                            };
                            addRequest.onerror = (event) => {
                                console.error("Duplicate save error:", event.target.error);
                                showToast(`Failed to duplicate: ${event.target.error}`, 'danger');
                            };
                        }
                    };
                } catch (e) {
                    console.error("Duplicate item error:", e);
                    showToast(`Critical duplication error: ${e.message}`, 'danger');
                }
            };


            // --- KPI & REPORT LOGIC (Updated for Cost Calculation) ---

            /** Fetches data for the active project, calculates KPIs, and updates the view. */
            const calculateKPIsAndRenderView = async (forReport = false) => {
                if (currentProjectId === null) {
                    document.getElementById('kpi-project-name').textContent = '';
                    document.getElementById('kpi-cv-status').textContent = 'No project selected.';
                    return { breakdown: {} };
                }

                document.getElementById('kpi-project-name').textContent = `Project: ${currentProjectName}`;
                
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = db.transaction([RESOURCE_STORE], 'readonly');
                        const store = transaction.objectStore(RESOURCE_STORE);
                        const index = store.index('projectId');
                        const projectIdRange = IDBKeyRange.only(currentProjectId);
                        const request = index.getAll(projectIdRange);

                        request.onsuccess = (event) => {
                            const allItems = event.target.result;
                            
                            let totalPlannedCost = 0;
                            let totalActualCost = 0;
                            
                            const breakdown = {};

                            const resourcePages = RESOURCE_PAGES;
                            resourcePages.forEach(page => {
                                breakdown[page] = { plannedCost: 0, actualCost: 0, cpi: 0, items: [] };
                            });

                            allItems.forEach(item => {
                                const rate = parseFloat(item.rate) || 0;
                                const plannedQty = parseFloat(item.plannedQty) || 0;
                                const actualQty = parseFloat(item.actualQty) || 0;

                                const plannedCost = plannedQty * rate;
                                const actualCost = actualQty * rate;

                                totalPlannedCost += plannedCost;
                                totalActualCost += actualCost;

                                if (breakdown[item.page]) {
                                    breakdown[item.page].plannedCost += plannedCost;
                                    breakdown[item.page].actualCost += actualCost;
                                    breakdown[item.page].items.push(item);
                                }
                            });
                            
                            // Final KPI Calculations
                            const costVariance = totalPlannedCost - totalActualCost; 
                            const costPerformanceIndex = totalActualCost === 0 ? 1.0 : totalPlannedCost / totalActualCost; 
                            
                            // Calculate CPI for each category
                            Object.keys(breakdown).forEach(page => {
                                const pageData = breakdown[page];
                                pageData.cpi = pageData.actualCost === 0 ? 1.0 : pageData.plannedCost / pageData.actualCost;
                            });


                            const kpiData = {
                                plannedCost: totalPlannedCost,
                                actualCost: totalActualCost,
                                cpi: costPerformanceIndex,
                                cv: costVariance,
                                breakdown: breakdown,
                            };

                            if (!forReport) {
                                // Render Core KPIs for KPI View
                                document.getElementById('kpi-planned-cost').textContent = `${CURRENCY_SYMBOL}${kpiData.plannedCost.toFixed(2)}`;
                                document.getElementById('kpi-actual-cost').textContent = `${CURRENCY_SYMBOL}${kpiData.actualCost.toFixed(2)}`;
                                
                                document.getElementById('kpi-cv').textContent = `${CURRENCY_SYMBOL}${kpiData.cv.toFixed(2)}`;
                                
                                const cvElement = document.getElementById('kpi-cv');
                                const cpiElement = document.getElementById('kpi-cpi');
                                const cvStatus = document.getElementById('kpi-cv-status');

                                cvElement.classList.remove('text-green-400', 'text-red-400');
                                cpiElement.classList.remove('text-blue-400', 'text-green-400', 'text-red-400');
                                
                                if (kpiData.cv >= 0) { 
                                    cvElement.classList.add('text-green-400');
                                    cvStatus.textContent = 'Project is running under budget/on target.';
                                } else { 
                                    cvElement.classList.add('text-red-400');
                                    cvStatus.textContent = 'Project is running over budget.';
                                }

                                document.getElementById('kpi-cpi').textContent = kpiData.cpi.toFixed(2);
                                if (kpiData.cpi > 1.05) { cpiElement.classList.add('text-green-400'); } 
                                else if (kpiData.cpi >= 0.95) { cpiElement.classList.add('text-blue-400'); } 
                                else { cpiElement.classList.add('text-red-400'); }

                                renderCategoryBreakdown(kpiData.breakdown);
                            }

                            resolve(kpiData);
                        };

                        request.onerror = (event) => {
                            console.error("KPI load error:", event.target.error);
                            showToast(`Failed to load KPI data: ${event.target.error}`, 'danger');
                            reject(event.target.error);
                        };

                    } catch (e) {
                        console.error("KPI calculation error:", e);
                        showToast(`Critical KPI error: ${e.message}`, 'danger');
                        reject(e);
                    }
                });
            };
            
            /** Generates the full report content (KPIs + all tables) */
            const generatePrintReport = async () => {
                 if (currentProjectId === null) {
                    reportViewContent.innerHTML = `<p class="text-red-400 text-center p-8">No active project selected to generate a report.</p>`;
                    return;
                }

                try {
                    const kpiData = await calculateKPIsAndRenderView(true);
                    
                    document.getElementById('report-project-name').textContent = `Project: ${currentProjectName}`;
                    
                    // 1. Render KPI Summary
                    reportKpiSummary.innerHTML = `
                        <div class="kpi-card bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-blue-500">
                            <p class="text-sm font-semibold text-gray-400">Planned Cost</p>
                            <p class="text-3xl font-extrabold text-blue-400">${CURRENCY_SYMBOL}${kpiData.plannedCost.toFixed(2)}</p>
                        </div>
                        <div class="kpi-card bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-yellow-500">
                            <p class="text-sm font-semibold text-gray-400">Actual Cost</p>
                            <p class="text-3xl font-extrabold text-yellow-400">${CURRENCY_SYMBOL}${kpiData.actualCost.toFixed(2)}</p>
                        </div>
                        <div class="kpi-card bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-green-500">
                            <p class="text-sm font-semibold text-gray-400">Cost Variance</p>
                            <p class="text-3xl font-extrabold ${kpiData.cv < 0 ? 'text-red-400' : 'text-green-400'}">${CURRENCY_SYMBOL}${kpiData.cv.toFixed(2)}</p>
                        </div>
                        <div class="kpi-card bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-red-500">
                            <p class="text-sm font-semibold text-gray-400">Cost CPI</p>
                            <p class="text-3xl font-extrabold ${kpiData.cpi > 1 ? 'text-green-400' : 'text-red-400'}">${kpiData.cpi.toFixed(2)}</p>
                        </div>
                    `;
                    
                    // 2. Render all Resource Tables
                    reportResourceTables.innerHTML = '';
                    RESOURCE_PAGES.forEach(page => {
                        const pageData = kpiData.breakdown[page];
                        if (pageData && pageData.items.length > 0) {
                            reportResourceTables.innerHTML += `
                                <div class="space-y-3">
                                    <h4 class="text-xl font-semibold text-gray-100">${pageNames[page]} (Total Actual Cost: ${CURRENCY_SYMBOL}${pageData.actualCost.toFixed(2)})</h4>
                                    ${renderReportTable(pageData.items)}
                                </div>
                            `;
                        } else {
                             reportResourceTables.innerHTML += `<p class="text-gray-500 italic">No data recorded for ${pageNames[page]}.</p>`;
                        }
                    });

                    lucide.createIcons();

                } catch (error) {
                    reportResourceTables.innerHTML = `<p class="text-red-400">Error generating report data.</p>`;
                    console.error("Report generation error:", error);
                }
            };
            
            /** Renders a concise HTML table for the print report. */
            const renderReportTable = (items) => {
                 items.sort((a, b) => a.title.localeCompare(b.title));

                let tableHTML = `
                    <div class="overflow-x-auto bg-gray-800 rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-700 text-gray-300">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Resource Name</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Unit / Details</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Rate (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Planned Qty</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Actual Qty</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Planned Cost (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Actual Cost (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Variance (${CURRENCY_SYMBOL})</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium uppercase tracking-wider">Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700">
                `;

                items.forEach(item => {
                    const rate = parseFloat(item.rate) || 0;
                    const plannedQty = parseFloat(item.plannedQty) || 0;
                    const actualQty = parseFloat(item.actualQty) || 0;
                    
                    const plannedCost = plannedQty * rate;
                    const actualCost = actualQty * rate;
                    const varianceCost = plannedCost - actualCost; 

                    const isOverBudget = actualCost > plannedCost;
                    const varianceColor = isOverBudget ? 'text-red-400 font-bold' : 'text-green-400';
                    const date = new Date(item.timestamp).toLocaleDateString();

                    tableHTML += `
                        <tr class="hover:bg-gray-700 transition duration-100">
                            <td class="px-3 py-2 text-sm font-medium text-gray-100">${item.title}</td>
                            <td class="px-3 py-2 text-sm text-gray-300">${item.description ? item.description.substring(0, 50) + (item.description.length > 50 ? '...' : '') : '-'}</td>
                            <td class="px-3 py-2 text-sm text-right text-yellow-400">${CURRENCY_SYMBOL}${rate.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-blue-400">${plannedQty.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-gray-200">${actualQty.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-blue-300">${CURRENCY_SYMBOL}${plannedCost.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-yellow-300">${CURRENCY_SYMBOL}${actualCost.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right ${varianceColor}">${CURRENCY_SYMBOL}${varianceCost.toFixed(2)}</td>
                            <td class="px-3 py-2 text-sm text-right text-gray-500">${date}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                return tableHTML;
            }


            // --- MODAL CONTROL ---

            /** Opens the delete confirmation modal. */
            const openModal = (id, type) => {
                currentDeleteId = { id, type };
                document.body.classList.add('modal-open');
                deleteModal.classList.remove('opacity-0', 'pointer-events-none');
                deleteModal.querySelector('div').classList.remove('scale-95');
                deleteModal.querySelector('div').classList.add('scale-100');
                
                // Update modal message based on type
                const modalH3 = deleteModal.querySelector('h3');
                const modalP = deleteModal.querySelector('p');
                if (type === 'project') {
                    modalH3.textContent = 'Confirm Project Deletion';
                    modalP.textContent = 'Are you sure you want to delete this project? ALL its resource data will be permanently deleted.';
                } else {
                    modalH3.textContent = 'Confirm Resource Deletion';
                    modalP.textContent = 'Are you sure you want to delete this resource item? This action cannot be undone.';
                }
            };

            /** Closes the delete confirmation modal. */
            const closeModal = () => {
                currentDeleteId = null;
                document.body.classList.remove('modal-open');
                deleteModal.querySelector('div').classList.remove('scale-100');
                deleteModal.querySelector('div').classList.add('scale-95');
                deleteModal.classList.add('opacity-0', 'pointer-events-none');
            };

            // --- DATA IMPORT/EXPORT (Updated for multi-store) ---

            /** Exports ALL data (projects and items) to a JSON file. */
            const exportData = async () => {
                try {
                    const trans = db.transaction([PROJECT_STORE, RESOURCE_STORE], 'readonly');
                    const projStore = trans.objectStore(PROJECT_STORE);
                    const itemStore = trans.objectStore(RESOURCE_STORE);

                    const [projects, items] = await Promise.all([
                        new Promise(resolve => { projStore.getAll().onsuccess = (e) => resolve(e.target.result); }),
                        new Promise(resolve => { itemStore.getAll().onsuccess = (e) => resolve(e.target.result); })
                    ]);

                    const exportObject = { projects, items, exportTimestamp: new Date().toISOString() };
                    const data = JSON.stringify(exportObject, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `project_manager_data_ALL_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('All data successfully exported.', 'success');
                } catch (e) {
                    showToast(`Export error: ${e.message}`, 'danger');
                }
            };
            
            /** Imports data from a JSON file (non-destructive merge) */
            const importData = (file) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.projects || !importedData.items) {
                            throw new Error('JSON file format invalid (must contain "projects" and "items" arrays).');
                        }

                        const newProjectMap = new Map(); // Map old project ID to new project ID
                        const transaction = db.transaction([PROJECT_STORE, RESOURCE_STORE], 'readwrite');
                        const projStore = transaction.objectStore(PROJECT_STORE);
                        const itemStore = transaction.objectStore(RESOURCE_STORE);
                        let importedProjectCount = 0;
                        let importedItemCount = 0;

                        // 1. Import Projects (non-destructive)
                        await new Promise((resolve, reject) => {
                            let i = 0;
                            const importNextProject = () => {
                                if (i < importedData.projects.length) {
                                    const oldProject = importedData.projects[i];
                                    const newProject = { 
                                        name: oldProject.name, 
                                        timestamp: new Date().toISOString() 
                                    };
                                    delete newProject.id; 

                                    const addReq = projStore.add(newProject);
                                    addReq.onsuccess = (event) => {
                                        newProjectMap.set(oldProject.id, event.target.result);
                                        importedProjectCount++;
                                        i++;
                                        importNextProject();
                                    };
                                    addReq.onerror = (e) => reject(e.target.error);
                                } else {
                                    resolve();
                                }
                            };
                            importNextProject();
                        });

                        // 2. Import Items (linking to new project IDs)
                        importedData.items.forEach(item => {
                            const newProjectId = newProjectMap.get(item.projectId);
                            if (newProjectId !== undefined) {
                                const newItem = {
                                    title: item.title,
                                    description: item.description,
                                    rate: item.rate || 0, // Include rate from import
                                    plannedQty: item.plannedQty,
                                    actualQty: item.actualQty,
                                    page: item.page,
                                    projectId: newProjectId, // Link using the new ID
                                    timestamp: new Date().toISOString(), 
                                };
                                delete newItem.id;
                                itemStore.add(newItem).onsuccess = () => {
                                    importedItemCount++;
                                };
                            }
                        });

                        transaction.oncomplete = () => {
                            showToast(`Successfully imported and merged ${importedProjectCount} projects and ${importedItemCount} resources.`, 'success');
                            activatePage('projects'); 
                        };

                        transaction.onerror = (event) => {
                            showToast(`Import error during transaction: ${event.target.error}`, 'danger');
                        };

                    } catch (error) {
                        console.error('Import process failed:', error);
                        showToast(`Import failed: ${error.message}`, 'danger');
                    }
                };
                reader.readAsText(file);
            };


            // --- EVENT LISTENERS ---

            // Project Form Submission (Create/Update Project)
            projectForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const projectData = {
                    name: projectNameInput.value,
                    id: projectIdInput.value ? parseInt(projectIdInput.value) : null
                };
                saveProject(projectData);
            });

            // Cancel Project Edit
            projectCancelBtn.addEventListener('click', resetProjectForm);

            // Project Action Delegation (List)
            projectList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const projectId = parseInt(target.getAttribute('data-id'));
                const projectName = target.getAttribute('data-name');
                const actionType = target.getAttribute('data-type');

                if (target.classList.contains('activate-project-btn')) {
                    loadProject(projectId, projectName);
                    loadProjects(); // Re-render list to show active status
                    activatePage('kpis'); // Switch to the KPIs of the activated project
                } else if (target.classList.contains('edit-project-btn')) {
                    const transaction = db.transaction([PROJECT_STORE], 'readonly');
                    const store = transaction.objectStore(PROJECT_STORE);
                    store.get(projectId).onsuccess = (event) => {
                        populateProjectFormForEdit(event.target.result);
                    };
                } else if (target.classList.contains('duplicate-project-btn')) {
                    duplicateProject(projectId);
                } else if (actionType === 'project' && target.classList.contains('delete-btn')) {
                    openModal(projectId, 'project');
                }
            });

            // Resource Form Submission (Create/Update Resource)
            resourceForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (currentProjectId === null) {
                     showToast('Please select or create a project first.', 'danger');
                     return;
                }
                const itemData = {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    plannedQty: document.getElementById('planned-qty').value,
                    actualQty: document.getElementById('actual-qty').value,
                    rate: document.getElementById('rate').value, 
                    page: currentPage,
                    id: document.getElementById('item-id').value ? parseInt(document.getElementById('item-id').value) : null
                };
                saveItem(itemData);
            });

            // Cancel Resource Edit
            cancelBtn.addEventListener('click', resetResourceForm);

            // Resource Item Action Delegation (Table)
            itemsList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const id = parseInt(target.getAttribute('data-id'));
                if (isNaN(id)) return;

                if (target.classList.contains('edit-btn')) {
                    const transaction = db.transaction([RESOURCE_STORE], 'readonly');
                    const store = transaction.objectStore(RESOURCE_STORE);
                    store.get(id).onsuccess = (event) => {
                        populateFormForEdit(event.target.result);
                    };
                } else if (target.classList.contains('delete-btn')) {
                    openModal(id, 'resource');
                } else if (target.classList.contains('duplicate-btn')) {
                    duplicateResourceItem(id);
                }
            });

            // Delete Modal Handler
            modalDeleteBtn.addEventListener('click', () => {
                if (currentDeleteId) {
                    if (currentDeleteId.type === 'project') {
                        deleteProject(currentDeleteId.id);
                    } else if (currentDeleteId.type === 'resource') {
                        deleteResourceItem(currentDeleteId.id);
                    }
                }
            });
            modalCancelBtn.addEventListener('click', closeModal);
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) closeModal(); 
            });

            // Search Filter
            searchInput.addEventListener('input', loadItems);

            // Page Navigation
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const page = tab.getAttribute('data-page');
                    activatePage(page);
                });
            });

            // Data Export/Import
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-file').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importData(e.target.files[0]);
                    e.target.value = ''; 
                }
            });


            // --- INITIALIZATION & Page Activation Logic ---

            /** Activates a new page and loads/filters data. */
            const activatePage = (page) => {
                currentPage = page;
                document.querySelectorAll('.page-tab').forEach(tab => {
                    tab.setAttribute('data-active', tab.getAttribute('data-page') === page);
                });
                
                app.classList.remove('print-mode');
                projectManagerView.classList.add('hidden');
                kpisView.classList.add('hidden');
                resourceManagerView.classList.add('hidden');
                
                reportViewContent.classList.add('hidden'); 
                
                // Update resource form title/context
                if (RESOURCE_PAGES.includes(page)) {
                    formTitle.innerHTML = `<i data-lucide="plus-circle" class="w-6 h-6 inline-block mr-2 text-blue-400"></i> Add New ${pageNames[page].replace(' Resources', '')} Resource`;
                }

                if (page === 'projects') {
                    projectManagerView.classList.remove('hidden');
                    loadProjects();
                    resetResourceForm(); 
                } else if (page === 'kpis') {
                    kpisView.classList.remove('hidden');
                    calculateKPIsAndRenderView();
                    resetResourceForm();
                } else if (page === 'report') {
                    reportViewContent.classList.remove('hidden');
                    app.classList.add('print-mode');
                    generatePrintReport();
                    resetResourceForm();
                } else if (RESOURCE_PAGES.includes(page)) {
                    resourceManagerView.classList.remove('hidden');
                    loadItems();
                    resetResourceForm();
                }
            };
            
            // Initial DB Load
            initDB()
                .then(() => {
                    // Start on the Project Manager page
                    activatePage('projects');
                })
                .catch(e => {
                    console.error("App failed to initialize:", e);
                    document.getElementById('loading-spinner').innerHTML = `<p class="text-red-400">Application failed to initialize database. Please check console.</p>`;
                });
        });
    </script>

</body>
</html>