<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prompt Generator with IndexedDB</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; }
  #container { display: flex; height: 100vh; }
  #builder, #library { padding: 20px; box-sizing: border-box; overflow-y: auto; }
  #builder { flex: 2; background-color: #fff; border-right: 1px solid #e0e0e0; }
  #library { flex: 1; background-color: #fafafa; }
  h2 { margin-top: 0; color: #333; }
  label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #555; }
  textarea { width: 100%; height: 90px; margin-top: 5px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 14px; box-sizing: border-box; resize: vertical; }
  select, input[type=text] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  button { width: 100%; padding: 12px; margin-top: 15px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 4px; transition: background-color 0.2s; }
  button:hover { background-color: #218838; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  .prompt-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 12px 8px; cursor: pointer; transition: background-color 0.2s; }
  .prompt-item:hover { background-color: #f0f0f0; }
  .prompt-title { font-weight: 500; color: #333; }
  .delete-button { color: #dc3545; background: none; border: none; cursor: pointer; font-size: 20px; font-weight: bold; width: auto; padding: 0 5px; margin: 0; }
  .delete-button:hover { color: #c82333; }
</style>
</head>
<body>

<div id="container">
  <div id="builder">
    <h2>Prompt Builder</h2>
    <label for="templateSelect">Select Template:</label>
    <select id="templateSelect"></select>

    <label for="titleInput">Prompt Title:</label>
    <input type="text" id="titleInput" placeholder="E.g., 'Blog Post Idea Generator'" />

    <div id="promptForm"></div>

    <button id="savePromptBtn">Save Prompt</button>
    <button id="copyMarkdownBtn">Copy Markdown</button>
  </div>

  <div id="library">
    <h2>Saved Prompts</h2>
    <div id="promptList"></div>
  </div>
</div>

<script>
  let db;
  const dbName = 'PromptDB_v2';
  const templateStoreName = 'promptTemplates';
  const savedStoreName = 'savedPrompts';

  function openDB() {
    const request = indexedDB.open(dbName, 1);

    request.onerror = (event) => console.error('Database error:', event.target.errorCode);
    request.onsuccess = (event) => {
      db = event.target.result;
      initApp();
    };

    request.onupgradeneeded = (event) => {
      db = event.target.result;
      if (!db.objectStoreNames.contains(templateStoreName)) {
        const templateOS = db.createObjectStore(templateStoreName, { keyPath: 'id', autoIncrement: true });
        templateOS.createIndex('name', 'name', { unique: true });
      }
      if (!db.objectStoreNames.contains(savedStoreName)) {
        const promptOS = db.createObjectStore(savedStoreName, { keyPath: 'id', autoIncrement: true });
        promptOS.createIndex('title', 'title', { unique: false });
        promptOS.createIndex('createdAt', 'createdAt', { unique: false });
      }
    };
  }

  function initApp() {
    checkDefaultTemplate().then(() => {
      loadTemplates();
      loadSavedPrompts();
      attachEventListeners();
    });
  }

  function checkDefaultTemplate() {
    return new Promise(resolve => {
      const tx = db.transaction(templateStoreName, 'readonly');
      const store = tx.objectStore(templateStoreName);
      const countRequest = store.count();
      countRequest.onsuccess = () => {
        if (countRequest.result === 0) {
          const defaultTemplate = { name: 'Special Prompting Structure', fields: ['Role', 'Objective', 'Context', 'Instructions', 'Notes'] };
          const addTx = db.transaction(templateStoreName, 'readwrite');
          addTx.objectStore(templateStoreName).add(defaultTemplate);
          addTx.oncomplete = resolve;
        } else {
          resolve();
        }
      };
      countRequest.onerror = resolve;
    });
  }

  function loadTemplates() {
    const store = db.transaction(templateStoreName, 'readonly').objectStore(templateStoreName);
    store.getAll().onsuccess = (event) => {
      const templates = event.target.result;
      const select = document.getElementById('templateSelect');
      select.innerHTML = '';
      templates.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.name;
        select.appendChild(option);
      });
      if (templates.length > 0) {
        select.dispatchEvent(new Event('change'));
      }
    };
  }

  function renderFormFields(fields) {
    const form = document.getElementById('promptForm');
    form.innerHTML = '';
    fields.forEach(field => {
      const label = document.createElement('label');
      label.textContent = field + ':';
      label.htmlFor = 'field_' + field;

      const textarea = document.createElement('textarea');
      textarea.id = 'field_' + field;
      textarea.placeholder = 'Enter ' + field + '...';

      form.appendChild(label);
      form.appendChild(textarea);
    });
  }

  function savePrompt() {
    const title = document.getElementById('titleInput').value.trim();
    if (!title) {
      alert('Please enter a title for the prompt.');
      return;
    }
    const templateId = parseInt(document.getElementById('templateSelect').value, 10);
    const promptData = {};
    document.querySelectorAll('#promptForm textarea').forEach(textarea => {
      const fieldName = textarea.id.replace('field_', '');
      promptData[fieldName] = textarea.value.trim();
    });
    const promptObj = { templateId, title, promptData, createdAt: Date.now() };

    const tx = db.transaction(savedStoreName, 'readwrite');
    tx.objectStore(savedStoreName).add(promptObj);
    tx.oncomplete = () => {
      loadSavedPrompts();
      clearForm();
    };
  }

  function loadSavedPrompts() {
    const store = db.transaction(savedStoreName, 'readonly').objectStore(savedStoreName);
    store.getAll().onsuccess = (event) => {
      const prompts = event.target.result.sort((a, b) => b.createdAt - a.createdAt);
      const container = document.getElementById('promptList');
      container.innerHTML = '';
      prompts.forEach(p => {
        const div = document.createElement('div');
        div.className = 'prompt-item';
        div.addEventListener('click', () => loadPrompt(p));

        const titleSpan = document.createElement('span');
        titleSpan.className = 'prompt-title';
        titleSpan.textContent = p.title;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-button';
        deleteBtn.innerHTML = '&times;'; // Using HTML entity for 'x'
        deleteBtn.title = 'Delete';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deletePrompt(p.id);
        });
        
        div.appendChild(titleSpan);
        div.appendChild(deleteBtn);
        container.appendChild(div);
      });
    };
  }
  
  function loadPrompt(prompt) {
    document.getElementById('titleInput').value = prompt.title;
    document.getElementById('templateSelect').value = prompt.templateId;
    
    const store = db.transaction(templateStoreName, 'readonly').objectStore(templateStoreName);
    store.get(prompt.templateId).onsuccess = (event) => {
        const template = event.target.result;
        if (template) {
            renderFormFields(template.fields);
            Object.entries(prompt.promptData).forEach(([k, v]) => {
                const textarea = document.getElementById('field_' + k);
                if (textarea) textarea.value = v;
            });
        }
    };
  }

  function deletePrompt(id) {
    if (!confirm('Are you sure you want to delete this prompt?')) return;
    const tx = db.transaction(savedStoreName, 'readwrite');
    tx.objectStore(savedStoreName).delete(id);
    tx.oncomplete = loadSavedPrompts;
  }

  function clearForm() {
    document.getElementById('titleInput').value = '';
    document.getElementById('promptForm').innerHTML = '';
    document.getElementById('templateSelect').dispatchEvent(new Event('change'));
  }

  function copyMarkdown() {
    const title = document.getElementById('titleInput').value.trim();
    if (!title) {
        alert('Please load or create a prompt first.');
        return;
    }
    const store = db.transaction(templateStoreName, 'readonly').objectStore(templateStoreName);
    const templateId = parseInt(document.getElementById('templateSelect').value, 10);
    store.get(templateId).onsuccess = (event) => {
        const template = event.target.result;
        if (!template) return;
        let markdown = `# ${title}\\n\\n`;
        template.fields.forEach(field => {
            const textarea = document.getElementById('field_' + field);
            if (textarea) {
                markdown += `## **${field}:**\\n${textarea.value.trim()}\\n\\n`;
            }
        });
        navigator.clipboard.writeText(markdown).then(() => {
            alert('Markdown prompt copied to clipboard!');
        });
    };
  }

  function attachEventListeners() {
    document.getElementById('templateSelect').addEventListener('change', (e) => {
        const templateId = parseInt(e.target.value, 10);
        const store = db.transaction(templateStoreName, 'readonly').objectStore(templateStoreName);
        store.get(templateId).onsuccess = (event) => {
            const template = event.target.result;
            if (template) renderFormFields(template.fields);
        };
    });
    document.getElementById('savePromptBtn').addEventListener('click', savePrompt);
    document.getElementById('copyMarkdownBtn').addEventListener('click', copyMarkdown);
  }

  // Initialize App
  openDB();
</script>

</body>
</html>
