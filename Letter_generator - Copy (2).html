<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Letter Generator</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        nav {
            display: flex;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        nav button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 16px;
            transition: background 0.3s;
        }

        nav button:hover {
            background: #0056b3;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1 {
            color: #007bff;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        h3 { margin-top: 0; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group, .setting-group {
            flex: 1;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input[type="file"], input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #fileStatus, #fileName {
            margin-top: 10px;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            border: none;
            background: #28a745;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background 0.3s;
        }

        .controls + button {
            margin-top: 20px;
        }

        button:hover {
            background: #218838;
        }
        
        .delete-button {
            background-color: #dc3545;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        .letter-output {
            border: 1px solid #ddd;
            padding: 40px;
            min-height: 500px;
            background-color: #fff;
            border-radius: 4px;
            line-height: 1.6;
            color: #000;
        }

        .editor-layout {
            display: flex;
            gap: 20px;
        }

        .placeholder-container {
            flex: 1;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            align-self: flex-start;
        }

        #placeholder-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .placeholder-tag {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .placeholder-tag:hover {
            background-color: #0056b3;
        }

        .editor-container { flex: 3; }

        input#templateName {
            margin-bottom: 10px;
        }

        .editor-buttons, .data-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .editor-buttons button, .data-buttons button { margin-top: 0; }

        @media print {
            body, .app-container {
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                background: none !important;
            }

            nav, #generatorView h1, #generatorView .controls, #generatorView > button, #templateEditorView, #settingsView {
                display: none !important;
            }

            #letter-output {
                position: static;
                width: 100%;
                height: auto;
                border: none !important;
                box-shadow: none !important;
                padding: 0;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav>
            <button onclick="showView('generatorView')">Letter Generator</button>
            <button onclick="showView('templateEditorView')">Template Editor</button>
            <button onclick="showView('settingsView')">Settings & Data</button>
        </nav>

        <!-- Main View for Generating Letters -->
        <div id="generatorView" class="view">
            <h1>Generate Letter</h1>
            <div class="controls">
                <div class="control-group">
                    <label for="templateSelector">Select Template:</label>
                    <select id="templateSelector" onchange="generateLetter()"></select>
                </div>
                <div class="control-group">
                    <label for="dataSelector">Select Data Row:</label>
                    <select id="dataSelector" onchange="generateLetter()"></select>
                </div>
            </div>
             <hr>
            <h3>Manual Placeholder Inputs</h3>
            <div id="manualInputs"></div>
            <button onclick="generateLetterManualFromPlaceholders()">Generate with Manual Inputs</button>
            <hr>
            <button onclick="printLetter()">Print Letter</button>
            <div id="letter-output" class="letter-output">Select a template and data row.</div>
        </div>

        <!-- View for Editing Templates -->
        <div id="templateEditorView" class="view">
            <h1>Template Editor</h1>
            <div class="editor-layout">
                <div class="editor-container">
                    <label for="templateName">Template Name:</label>
                    <input type="text" id="templateName" placeholder="Enter a name for this template">
                    <div id="templateEditor"></div>
                    <div class="editor-buttons">
                        <button onclick="saveTemplate()">Save Template</button>
                        <button class="delete-button" onclick="deleteTemplate()">Delete Template</button>
                        <button onclick="loadTemplateForEditing()">Load Selected Template</button>
                        <button onclick="scanPlaceholdersFromTemplate()">Scan for Placeholders</button>
                    </div>
                </div>
                <div class="placeholder-container">
                    <h3>Available Placeholders</h3>
                    <div id="placeholder-list"></div>
                </div>
            </div>
        </div>

        <!-- View for Settings and Data Upload -->
        <div id="settingsView" class="view">
            <h1>Settings & Data</h1>
            <div class="setting-group">
                <label for="fileInput">Upload Excel File (.xlsx, .xls, .csv):</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                <div id="fileName">No file selected</div>
                <div id="fileStatus">0 rows loaded.</div>
            </div>
             <div class="setting-group">
                <h3>Manage Data & Templates</h3>
                <div class="data-buttons">
                    <button onclick="exportTemplates()">Export All Templates (Backup)</button>
                    <button class="delete-button" onclick="clearExcelData()">Clear Saved Excel Data</button>
                    <button class="delete-button" onclick="resetApplication()">Reset Application</button>
                </div>
            </div>
        </div>

        <!-- Hidden container for templates -->
        <div id="templates" style="display: none;"></div>
    </div>

    <!-- External JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Application Logic -->
    <script>
        // --- GLOBAL VARIABLES ---
        let excelData = [], excelHeaders = [];
        let quill = null;
        const customPlaceholders = new Set();

        // --- UTILITY & CORE LOGIC ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString.replace(/-/g, '/'));
            if (isNaN(date.getTime())) return dateString;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            if (viewId === 'templateEditorView') {
                initializeQuillEditor();
            }
        }

        function getSavedTemplates() {
            return JSON.parse(localStorage.getItem('customTemplates')) || {};
        }

        // --- INITIALIZATION ---
        function initializeQuillEditor() {
            if (!quill) {
                quill = new Quill('#templateEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            ['bold', 'italic', 'underline'],
                            [{ 'align': [] }],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            ['link', 'image'],
                            ['clean']
                        ]
                    }
                });
            }
        }

        // --- DATA HANDLING (UPLOAD & LOCAL STORAGE) ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('fileName').textContent = "No file selected";
                return;
            }
            document.getElementById('fileName').textContent = `File: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    excelHeaders = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' })[0] || [];
                    excelData = XLSX.utils.sheet_to_json(ws, { header: excelHeaders, raw: false, defval: '', range: 1 });
                    
                    // **NEW**: Save data to local storage
                    const dataToSave = { headers: excelHeaders, data: excelData, fileName: file.name };
                    localStorage.setItem('excelDataSource', JSON.stringify(dataToSave));
                    alert('Excel data has been saved to your browser for future sessions.');

                    updateUIAfterDataLoad(file.name);
                } catch (err) {
                    console.error("Error reading Excel file:", err);
                    alert("An error occurred. Please check if it's a valid Excel/CSV file.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('excelDataSource');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    excelData = parsedData.data || [];
                    excelHeaders = parsedData.headers || [];
                    const fileName = parsedData.fileName || 'Loaded from local storage';
                    updateUIAfterDataLoad(fileName);
                } catch (e) {
                    console.error("Failed to parse saved data:", e);
                    localStorage.removeItem('excelDataSource');
                }
            }
        }
        
        function updateUIAfterDataLoad(fileName) {
            document.getElementById('fileName').textContent = `File: ${fileName}`;
            document.getElementById('fileStatus').textContent = `${excelData.length} rows loaded.`;
            populateDataSelector();
            displayPlaceholders();
            generateLetter();
        }

        function clearExcelData() {
            if (confirm('Are you sure you want to clear the saved Excel data?')) {
                localStorage.removeItem('excelDataSource');
                excelData = [];
                excelHeaders = [];
                updateUIAfterDataLoad('No file selected');
                document.getElementById('fileStatus').textContent = '0 rows loaded.';
                alert('Saved Excel data has been cleared.');
            }
        }


        // --- UI & LETTER GENERATION ---
        function displayPlaceholders() {
            const list = document.getElementById('placeholder-list');
            list.innerHTML = '';
            excelHeaders.forEach(h => {
                if (!h) return;
                const tag = document.createElement('span');
                tag.className = 'placeholder-tag';
                tag.textContent = `{{${h}}}`;
                tag.onclick = () => {
                    if (quill) {
                        quill.insertText(quill.getSelection(true).index, tag.textContent);
                    } else {
                        alert("Please click 'Template Editor' first to activate the editor.");
                    }
                };
                list.appendChild(tag);
            });
        }

        function populateDataSelector() {
            const selector = document.getElementById('dataSelector');
            selector.innerHTML = '';
            excelData.forEach((row, index) => {
                selector.add(new Option(row[excelHeaders[0]] || `Row ${index + 1}`, index));
            });
            selector.value = "";
        }

        function generateLetter() {
            const outputDiv = document.getElementById('letter-output');
            const dataIndex = document.getElementById('dataSelector').value;
            const templateId = document.getElementById('templateSelector').value;
            const templateDiv = document.getElementById(templateId);

            if (!templateDiv) {
                outputDiv.innerHTML = 'Select a template.';
                return;
            }
            if (!excelData.length) {
                outputDiv.innerHTML = 'Upload an Excel file in Settings.';
                return;
            }
            if (dataIndex === "") {
                outputDiv.innerHTML = 'Select a data row.';
                return;
            }
            
            let content = templateDiv.innerHTML;
            const row = excelData[dataIndex];
            excelHeaders.forEach(header => {
                if (header && row.hasOwnProperty(header)) {
                    const placeholder = new RegExp(`{{${header}}}`, 'g');
                    let value = row[header] || '';
                    if (header.toLowerCase() === 'dated') value = formatDate(value);
                    content = content.replace(placeholder, value);
                }
            });
            outputDiv.classList.add('ql-editor');
            outputDiv.innerHTML = content;
        }

        function scanPlaceholdersFromTemplate() {
            if (!quill) {
                alert('Please open Template Editor to scan placeholders.');
                return;
            }
            const text = quill.getText();
            const regex = /{{(.*?)}}/g;
            customPlaceholders.clear();
            let match;
            while ((match = regex.exec(text)) !== null) {
                if (match[1]) {
                    customPlaceholders.add(match[1].trim());
                }
            }
            alert(`Found placeholders: ${Array.from(customPlaceholders).join(', ')}`);
            createManualInputsFromPlaceholders();
        }

        function createManualInputsFromPlaceholders() {
            const manualInputsContainer = document.getElementById('manualInputs');
            manualInputsContainer.innerHTML = '';
            customPlaceholders.forEach(ph => {
                const label = document.createElement('label');
                label.textContent = ph + ':';
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `manual_${ph}`;
                input.placeholder = `Enter value for {{${ph}}}`;
                manualInputsContainer.appendChild(label);
                manualInputsContainer.appendChild(input);
            });
        }

        function generateLetterManualFromPlaceholders() {
            const outputDiv = document.getElementById('letter-output');
            const templateId = document.getElementById('templateSelector').value;
            const templateDiv = document.getElementById(templateId);
            if (!templateDiv) {
                outputDiv.innerHTML = 'Select a template.';
                return;
            }
            let content = templateDiv.innerHTML;
            customPlaceholders.forEach(ph => {
                const inputElement = document.getElementById(`manual_${ph}`);
                const manualInputValue = inputElement ? inputElement.value : '';
                const placeholder = new RegExp(`{{${ph}}}`, 'g');
                content = content.replace(placeholder, manualInputValue);
            });
            outputDiv.classList.add('ql-editor');
            outputDiv.innerHTML = content;
        }

        // --- TEMPLATE MANAGEMENT ---
        function saveTemplate() {
            if (!quill) {
                alert("Template editor is not active.");
                return;
            }
            const name = document.getElementById('templateName').value.trim();
            const htmlContent = quill.root.innerHTML;
            if (!name || (quill.getLength() <= 1)) {
                alert('Please provide a template name and content.');
                return;
            }
            const templates = getSavedTemplates();
            templates[name] = { html: htmlContent, placeholders: Array.from(customPlaceholders) };
            localStorage.setItem('customTemplates', JSON.stringify(templates));
            alert(`Template "${name}" saved!`);
            loadAllTemplates();
        }

        function deleteTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) { alert('Load a template to delete it.'); return; }
            const templates = getSavedTemplates();
            if (!templates[name]) { alert(`Template "${name}" not found.`); return; }
            if (confirm(`Are you sure you want to delete "${name}"?`)) {
                delete templates[name];
                localStorage.setItem('customTemplates', JSON.stringify(templates));
                alert(`Template "${name}" deleted.`);
                document.getElementById('templateName').value = '';
                if (quill) quill.root.innerHTML = '';
                loadAllTemplates();
            }
        }
        
        function loadAllTemplates() {
            const selector = document.getElementById('templateSelector');
            selector.innerHTML = '';
            const container = document.getElementById('templates');
            container.innerHTML = '';
            const templates = getSavedTemplates();
            Object.keys(templates).forEach(name => {
                selector.add(new Option(name, `custom-${name}`));
                const div = document.createElement('div');
                div.id = `custom-${name}`;
                div.innerHTML = templates[name].html;
                container.appendChild(div);
            });
            if (selector.options.length === 0) {
                selector.add(new Option("-- No Custom Templates --", ""));
            }
            customPlaceholders.clear();
            createManualInputsFromPlaceholders();
            generateLetter();
        }

        function loadTemplateForEditing() {
            const selectedId = document.getElementById('templateSelector').value;
            initializeQuillEditor();
            if (!selectedId || !selectedId.startsWith('custom-')) {
                document.getElementById('templateName').value = '';
                if (quill) quill.root.innerHTML = '';
                customPlaceholders.clear();
                createManualInputsFromPlaceholders();
                return;
            }
            const name = selectedId.replace('custom-', '');
            const templates = getSavedTemplates();
            if (templates[name]) {
                document.getElementById('templateName').value = name;
                if (quill) quill.root.innerHTML = templates[name].html || '';
                customPlaceholders.clear();
                if (templates[name].placeholders) {
                    templates[name].placeholders.forEach(ph => customPlaceholders.add(ph));
                }
                createManualInputsFromPlaceholders();
            }
        }
        
        function exportTemplates() {
            const templates = getSavedTemplates();
            if (Object.keys(templates).length === 0) {
                alert("No templates to export.");
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(templates, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const timestamp = new Date().toISOString().replace(/:/g, '-');
            downloadAnchorNode.setAttribute("download", `templates_backup_${timestamp}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        function resetApplication() {
            if (confirm("Are you sure? This will download a backup of your templates and then clear ALL saved templates and data.")) {
                exportTemplates();
                localStorage.clear();
                window.location.reload();
            }
        }
        
        function printLetter() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print</title>');
            printWindow.document.write('<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">');
            printWindow.document.write('<style>body { font-family: sans-serif; } .ql-editor { padding: 40px; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(document.getElementById('letter-output').innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        // --- DOCUMENT READY ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            showView('generatorView');
            loadSavedData(); // **NEW**: Load saved Excel data first
            loadAllTemplates(); // Then load templates
        });
    </script>
</body>
</html>
