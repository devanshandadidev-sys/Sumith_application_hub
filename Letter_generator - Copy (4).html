<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Letter Generator</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        nav {
            display: flex;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        nav button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 16px;
            transition: background 0.3s;
        }

        nav button:hover {
            background: #0056b3;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1 {
            color: #007bff;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        h3 { margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        hr { border: 0; border-top: 2px solid #eee; margin: 20px 0; }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group, .setting-group {
            flex: 1;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        select, input[type="file"], input[type="text"], input[type="url"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #fileStatus, #fileName {
            margin-top: 10px;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            border: none;
            background: #28a745;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #218838;
        }
        
        .delete-button {
            background-color: #dc3545;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        .letter-output {
            border: 1px solid #ddd;
            padding: 40px;
            min-height: 500px;
            background-color: #fff;
            border-radius: 4px;
            color: #000;
        }

        .editor-layout {
            display: flex;
            gap: 20px;
        }

        .placeholder-container {
            flex: 1;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            align-self: flex-start;
        }

        #placeholder-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .placeholder-tag {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .placeholder-tag:hover {
            background-color: #0056b3;
        }

        .editor-container { flex: 3; }

        input#templateName {
            margin-bottom: 10px;
        }

        .editor-buttons, .data-buttons {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .editor-buttons button, .data-buttons button { margin-top: 0; }

        @media print {
            body, .app-container { margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; background: none !important; }
            nav, #generatorView h1, #generatorView .controls, #generatorView > button, #templateEditorView, #settingsView, #generatorView hr { display: none !important; }
            #letter-output { position: static; width: 100%; height: auto; border: none !important; box-shadow: none !important; padding: 0; margin: 0; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav>
            <button onclick="showView('generatorView')">Letter Generator</button>
            <button onclick="showView('templateEditorView')">Template Editor</button>
            <button onclick="showView('settingsView')">Settings & Data</button>
        </nav>

        <div id="generatorView" class="view">
            <h1>Generate Letter</h1>
            <div class="controls">
                <div class="control-group">
                    <label for="templateSelector">Select Template:</label>
                    <select id="templateSelector" onchange="generateLetter()"></select>
                </div>
                <div class="control-group">
                    <label for="dataSelector">Select Data Row:</label>
                    <select id="dataSelector" onchange="generateLetter()"></select>
                </div>
            </div>
             <hr>
            <h3>Manual Placeholder Inputs</h3>
            <div id="manualInputs"></div>
            <button onclick="generateLetterManualFromPlaceholders()">Generate with Manual Inputs</button>
            <hr>
            <button onclick="printLetter()">Print Letter</button>
            <div id="letter-output" class="letter-output ql-editor">Select a template and data row.</div>
        </div>

        <div id="templateEditorView" class="view">
            <h1>Template Editor</h1>
            <div class="editor-layout">
                <div class="editor-container">
                    <label for="templateName">Template Name:</label>
                    <input type="text" id="templateName" placeholder="Enter a name for this template">
                    <div id="templateEditor"></div>
                    <div class="editor-buttons">
                        <button onclick="saveTemplate()">Save Template</button>
                        <button class="delete-button" onclick="deleteTemplate()">Delete Template</button>
                        <button onclick="loadTemplateForEditing()">Load Selected Template</button>
                        <button onclick="scanPlaceholdersFromTemplate()">Scan for Placeholders</button>
                    </div>
                </div>
                <div class="placeholder-container">
                    <h3>Available Placeholders</h3>
                    <div id="placeholder-list"></div>
                </div>
            </div>
        </div>

        <div id="settingsView" class="view">
            <h1>Settings & Data</h1>
            <div class="setting-group">
                <h3>Data Source</h3>
                <label for="fileInput">Upload Excel File (.xlsx, .xls, .csv):</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                <div id="fileName">No file selected</div>
                <div id="fileStatus">0 rows loaded.</div>
            </div>
             <hr>
             <div class="setting-group">
                <h3>Print Font Settings</h3>
                <label for="fontSelector">Select a Font for Printing:</label>
                <select id="fontSelector">
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Arial">Arial</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Verdana">Verdana</option>
                </select>
                <label for="googleFontUrl" style="margin-top: 15px;">Or, use a Google Font (paste URL here):</label>
                <input type="url" id="googleFontUrl" placeholder="e.g., https://fonts.googleapis.com/css2?family=Roboto&display=swap">
                <button onclick="saveFontSettings()" style="margin-top: 10px;">Save Font Settings</button>
            </div>
             <hr>
             <div class="setting-group">
                <h3>Manage Data & Templates</h3>
                <div class="data-buttons">
                    <button onclick="exportTemplates()">Export All Templates (Backup)</button>
                    <button class="delete-button" onclick="clearExcelData()">Clear Saved Excel Data</button>
                    <button class="delete-button" onclick="resetApplication()">Reset Application</button>
                </div>
            </div>
        </div>

        <div id="templates" style="display: none;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // --- GLOBAL VARIABLES ---
        let excelData = [], excelHeaders = [];
        let quill = null;
        const customPlaceholders = new Set();

        // --- UTILITY & CORE LOGIC ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString.replace(/-/g, '/'));
            if (isNaN(date.getTime())) return dateString;
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            if (viewId === 'templateEditorView') initializeQuillEditor();
        }

        function getSavedTemplates() { return JSON.parse(localStorage.getItem('customTemplates')) || {}; }

        // --- INITIALIZATION ---
        function initializeQuillEditor() {
            if (!quill) {
                quill = new Quill('#templateEditor', {
                    theme: 'snow',
                    modules: { toolbar: [ [{ 'header': [1, 2, 3, 4, 5, 6, false] }], ['bold', 'italic', 'underline'], [{ 'align': [] }], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link', 'image'], ['clean'] ] }
                });
            }
        }

        // --- DATA & SETTINGS HANDLING ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) { document.getElementById('fileName').textContent = "No file selected"; return; }
            document.getElementById('fileName').textContent = `File: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    excelHeaders = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, defval: '' })[0] || [];
                    excelData = XLSX.utils.sheet_to_json(ws, { header: excelHeaders, raw: false, defval: '', range: 1 });
                    
                    const dataToSave = { headers: excelHeaders, data: excelData, fileName: file.name };
                    try {
                        localStorage.setItem('excelDataSource', JSON.stringify(dataToSave));
                        alert('Excel data has been saved to your browser.');
                    } catch (e) {
                        if (e.name === 'QuotaExceededError') {
                            alert('Storage Error: Could not save Excel data because your browser storage is full. Please clear some data or templates and try again.');
                        }
                    }
                    updateUIAfterDataLoad(file.name);
                } catch (err) {
                    console.error("Error reading Excel file:", err);
                    alert("An error occurred. Please check the file format.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('excelDataSource');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    excelData = parsedData.data || [];
                    excelHeaders = parsedData.headers || [];
                    updateUIAfterDataLoad(parsedData.fileName || 'Loaded from storage');
                } catch (e) {
                    console.error("Failed to parse saved data:", e);
                    localStorage.removeItem('excelDataSource');
                }
            }
        }
        
        function updateUIAfterDataLoad(fileName) {
            document.getElementById('fileName').textContent = `File: ${fileName}`;
            document.getElementById('fileStatus').textContent = `${excelData.length} rows loaded.`;
            populateDataSelector();
            displayPlaceholders();
            generateLetter();
        }

        function clearExcelData() {
            if (confirm('Are you sure you want to clear the saved Excel data?')) {
                localStorage.removeItem('excelDataSource');
                excelData = [];
                excelHeaders = [];
                updateUIAfterDataLoad('No file selected');
                document.getElementById('fileStatus').textContent = '0 rows loaded.';
                alert('Saved Excel data has been cleared.');
            }
        }

        function saveFontSettings() {
            const selectedFont = document.getElementById('fontSelector').value;
            const googleFontUrl = document.getElementById('googleFontUrl').value.trim();
            const fontSettings = { font: selectedFont, url: googleFontUrl };
            localStorage.setItem('printFontSettings', JSON.stringify(fontSettings));
            alert('Font settings saved!');
        }

        function loadFontSettings() {
            const savedSettings = localStorage.getItem('printFontSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    document.getElementById('fontSelector').value = settings.font || 'Times New Roman';
                    document.getElementById('googleFontUrl').value = settings.url || '';
                } catch(e) {
                    console.error('Could not load font settings.');
                }
            }
        }


        // --- UI & LETTER GENERATION ---
        function displayPlaceholders() {
            const list = document.getElementById('placeholder-list');
            list.innerHTML = '';
            excelHeaders.forEach(h => {
                if (!h) return;
                const tag = document.createElement('span');
                tag.className = 'placeholder-tag';
                tag.textContent = `{{${h}}}`;
                tag.onclick = () => quill ? quill.insertText(quill.getSelection(true).index, tag.textContent) : alert("Activate the editor first.");
                list.appendChild(tag);
            });
        }

        function populateDataSelector() {
            const selector = document.getElementById('dataSelector');
            selector.innerHTML = '';
            excelData.forEach((row, index) => selector.add(new Option(row[excelHeaders[0]] || `Row ${index + 1}`, index)));
            selector.value = "";
        }

        function generateLetter() {
            const outputDiv = document.getElementById('letter-output');
            const dataIndex = document.getElementById('dataSelector').value;
            const templateId = document.getElementById('templateSelector').value;
            const templateDiv = document.getElementById(templateId);

            if (!templateDiv) { outputDiv.innerHTML = 'Select a template.'; return; }
            if (!excelData.length) { outputDiv.innerHTML = 'Upload an Excel file in Settings.'; return; }
            if (dataIndex === "") { outputDiv.innerHTML = 'Select a data row.'; return; }
            
            let content = templateDiv.innerHTML;
            const row = excelData[dataIndex];
            excelHeaders.forEach(header => {
                if (header && row.hasOwnProperty(header)) {
                    const placeholder = new RegExp(`{{${header}}}`, 'g');
                    let value = row[header] || '';
                    if (header.toLowerCase() === 'dated') value = formatDate(value);
                    content = content.replace(placeholder, value);
                }
            });
            outputDiv.innerHTML = content;
        }

        function scanPlaceholdersFromTemplate() {
            if (!quill) { alert('Please open Template Editor to scan placeholders.'); return; }
            const text = quill.getText();
            const regex = /{{(.*?)}}/g;
            customPlaceholders.clear();
            let match;
            while ((match = regex.exec(text)) !== null) {
                if (match[1]) customPlaceholders.add(match[1].trim());
            }
            alert(`Found placeholders: ${Array.from(customPlaceholders).join(', ')}`);
            createManualInputsFromPlaceholders();
        }

        function createManualInputsFromPlaceholders() {
            const manualInputsContainer = document.getElementById('manualInputs');
            manualInputsContainer.innerHTML = '';
            customPlaceholders.forEach(ph => {
                const label = document.createElement('label');
                label.textContent = ph + ':';
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `manual_${ph}`;
                input.placeholder = `Enter value for {{${ph}}}`;
                manualInputsContainer.appendChild(label);
                manualInputsContainer.appendChild(input);
            });
        }

        function generateLetterManualFromPlaceholders() {
            const outputDiv = document.getElementById('letter-output');
            const templateId = document.getElementById('templateSelector').value;
            const templateDiv = document.getElementById(templateId);
            if (!templateDiv) { outputDiv.innerHTML = 'Select a template.'; return; }
            let content = templateDiv.innerHTML;
            customPlaceholders.forEach(ph => {
                const inputElement = document.getElementById(`manual_${ph}`);
                const manualInputValue = inputElement ? inputElement.value : '';
                content = content.replace(new RegExp(`{{${ph}}}`, 'g'), manualInputValue);
            });
            outputDiv.innerHTML = content;
        }

        // --- TEMPLATE MANAGEMENT ---
        function saveTemplate() {
            if (!quill) { alert("Template editor is not active."); return; }
            const name = document.getElementById('templateName').value.trim();
            const htmlContent = quill.root.innerHTML;
            if (!name || (quill.getLength() <= 1)) { alert('Please provide a template name and content.'); return; }
            const templates = getSavedTemplates();
            templates[name] = { html: htmlContent, placeholders: Array.from(customPlaceholders) };
            
            try {
                localStorage.setItem('customTemplates', JSON.stringify(templates));
                alert(`Template "${name}" saved!`);
                loadAllTemplates();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('Storage Error: Could not save template. Your browser storage is full. Please remove large images or delete old templates and try again.');
                } else {
                    alert('An unknown error occurred while saving the template.');
                    console.error(e);
                }
            }
        }

        function deleteTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) { alert('Load a template to delete it.'); return; }
            const templates = getSavedTemplates();
            if (!templates[name]) { alert(`Template "${name}" not found.`); return; }
            if (confirm(`Are you sure you want to delete "${name}"?`)) {
                delete templates[name];
                localStorage.setItem('customTemplates', JSON.stringify(templates));
                alert(`Template "${name}" deleted.`);
                document.getElementById('templateName').value = '';
                if (quill) quill.root.innerHTML = '';
                loadAllTemplates();
            }
        }
        
        function loadAllTemplates() {
            const selector = document.getElementById('templateSelector');
            selector.innerHTML = '';
            const container = document.getElementById('templates');
            container.innerHTML = '';
            const templates = getSavedTemplates();
            Object.keys(templates).forEach(name => {
                selector.add(new Option(name, `custom-${name}`));
                const div = document.createElement('div');
                div.id = `custom-${name}`;
                div.innerHTML = templates[name].html;
                container.appendChild(div);
            });
            if (selector.options.length === 0) selector.add(new Option("-- No Templates --", ""));
            customPlaceholders.clear();
            createManualInputsFromPlaceholders();
            generateLetter();
        }

        function loadTemplateForEditing() {
            const selectedId = document.getElementById('templateSelector').value;
            initializeQuillEditor();
            if (!selectedId.startsWith('custom-')) {
                document.getElementById('templateName').value = '';
                if (quill) quill.root.innerHTML = '';
                customPlaceholders.clear();
                createManualInputsFromPlaceholders();
                return;
            }
            const name = selectedId.replace('custom-', '');
            const templates = getSavedTemplates();
            if (templates[name]) {
                document.getElementById('templateName').value = name;
                if (quill) quill.root.innerHTML = templates[name].html || '';
                customPlaceholders.clear();
                if (templates[name].placeholders) templates[name].placeholders.forEach(ph => customPlaceholders.add(ph));
                createManualInputsFromPlaceholders();
            }
        }
        
        function exportTemplates() {
            const templates = getSavedTemplates();
            if (Object.keys(templates).length === 0) { alert("No templates to export."); return; }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(templates, null, 2));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = `templates_backup_${new Date().toISOString().replace(/:/g, '-')}.json`;
            a.click();
        }
        
        function resetApplication() {
            if (confirm("Are you sure? This will backup your templates and then clear ALL saved data.")) {
                exportTemplates();
                localStorage.clear();
                window.location.reload();
            }
        }
        
        function printLetter() {
            const contentToPrint = document.getElementById('letter-output').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print Letter</title>');
            
            const fontSettings = JSON.parse(localStorage.getItem('printFontSettings')) || { font: 'Times New Roman', url: '' };
            const selectedFont = fontSettings.font;
            const googleFontUrl = fontSettings.url;

            printWindow.document.write('<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">');
            
            if(googleFontUrl) {
                printWindow.document.write(`<link href="${googleFontUrl}" rel="stylesheet">`);
            }

            // **UPDATED**: Corrected styles for multi-page printing
            printWindow.document.write(`
                <style>
                    html, body {
                        height: auto !important;
                        overflow: visible !important; /* Allow content to overflow for printing */
                        margin: 40px; 
                        background: #fff;
                    }
                    .ql-editor {
                        width: 100%;
                        height: auto !important;
                        padding: 0;
                        border: none;
                        overflow: visible !important;
                        font-family: '${selectedFont}', serif !important;
                    }
                </style>
            `);
            
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="ql-editor">' + contentToPrint + '</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            printWindow.onload = () => {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        }


        // --- DOCUMENT READY ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            showView('generatorView');
            loadSavedData();
            loadAllTemplates();
            loadFontSettings();
        });
    </script>
</body>
</html>
