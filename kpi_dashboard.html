<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weighted KPI-Driven Talent Dashboard</title>
    <style>
        :root {
            --primary-bg: #f8f9fa; --secondary-bg: #ffffff; --text-color: #212529;
            --border-color: #dee2e6; --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff; --accent-hover: #0056b3;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--primary-bg); color: var(--text-color); }
        .container { width: 100%; max-width: 1700px; display: flex; gap: 20px; margin: auto; }
        .sidebar, .main-content { background-color: var(--secondary-bg); border-radius: 8px; box-shadow: 0 2px 4px var(--shadow-color); padding: 20px; }
        .sidebar { width: 400px; flex-shrink: 0; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; }
        h1, h2, h3, h4, h5 { color: var(--accent-color); border-bottom: 2px solid var(--border-color); margin: 0 0 15px 0; padding-bottom: 10px; }
        
        .form-section { background-color: #f0f2f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .form-section input, .form-section select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        
        .sidebar-btn, button { padding: 10px 15px; border: 1px solid var(--accent-color); background-color: var(--accent-color); color: white; cursor: pointer; border-radius: 4px; width: 100%; }
        button:hover { background-color: var(--accent-hover); }

        #team-list, #kpi-library-list { list-style: none; margin: 10px 0; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 5px; }
        #team-list li, #kpi-library-list li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        #team-list li:last-child, #kpi-library-list li:last-child { border-bottom: none; }
        #team-list li:hover, #kpi-library-list li:hover { background-color: #e9ecef; }
        #team-list li.active { background-color: var(--accent-color); color: white; }

        #nine-box-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .nine-box-cell { border: 1px solid var(--border-color); padding: 8px; min-height: 70px; font-size: 0.8em; }
        
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-item { background-color: var(--primary-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .matrix-container { position: relative; width: 100%; height: 280px; border: 1px solid #ccc; background: white; margin-top: 15px; }
        .matrix-line { position: absolute; background: #ccc; }
        .matrix-line.vertical { width: 1px; height: 100%; left: 50%; top: 0; }
        .matrix-line.horizontal { height: 1px; width: 100%; top: 50%; left: 0; }
        .axis-label { position: absolute; font-weight: bold; color: #555; }
        .vertical-label { top: 5px; left: 50%; transform: translateX(-50%); }
        .horizontal-label { top: 50%; right: 5px; transform: translateY(-50%); }
        #matrix-dot { position: absolute; width: 20px; height: 20px; background: var(--accent-color); border-radius: 50%; border: 2px solid white; transition: all 0.3s ease; }
        #strategy-box { margin-top: 10px; padding: 15px; border-radius: 5px; color: white; }
        .assigned-kpi-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; border-radius: 6px; background: white; }
        @media print {
            body > *:not(#print-container) { display: none; }
            #print-container { display: block; }
        }
    </style>
</head>
<body>
<div class="container">
    <aside class="sidebar">
        <section>
            <h2>Team Members</h2>
            <form id="add-member-form" class="form-section" style="padding:10px;"><div class="form-group"><label for="new-member-name">Member Name</label><input type="text" id="new-member-name" required></div><button type="submit">Add</button></form>
            <ul id="team-list"></ul>
        </section>
        <section>
            <h2>KPI Library</h2>
            <form id="add-kpi-to-library-form" class="form-section" style="padding:10px;">
                <div class="form-group"><label for="new-kpi-library-name">KPI Name</label><input type="text" id="new-kpi-library-name" required></div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1;"><label>Axis</label><select id="new-kpi-library-axis"><option value="capability">Capability</option><option value="commitment">Commitment</option><option value="potential">Potential</option></select></div>
                    <div class="form-group" style="flex:1;"><label>Direction</label><select id="new-kpi-library-direction"><option value="higher">Higher Better</option><option value="lower">Lower Better</option></select></div>
                    <div class="form-group" style="flex:1;"><label>Weight</label><input type="number" id="new-kpi-library-weight" min="1" max="5" value="1" required></div>
                </div>
                <button type="submit">Add to Library</button>
            </form>
            <ul id="kpi-library-list"></ul>
        </section>
        <div>
            <h2>9-Box Grid</h2>
            <div id="nine-box-grid"></div>
        </div>
        <div style="margin-top:auto; display:flex; gap:10px;"><button id="print-report-btn">Print Report</button><button id="export-data-btn">Export Data</button></div>
    </aside>
    <main class="main-content">
        <div id="placeholder-view"><h2>Select a team member to get started.</h2></div>
        <div id="member-details" style="display: none;">
            <h1 id="member-name-header"></h1>
            <div class="details-grid">
                <div class="grid-item">
                    <h2>Calculated Performance</h2>
                    <div id="calculated-scores"></div>
                    <div class="matrix-container">
                        <div class="matrix-line vertical"></div><div class="matrix-line horizontal"></div>
                        <span class="axis-label vertical-label">Capability</span><span class="axis-label horizontal-label">Commitment</span>
                        <div id="matrix-dot"></div>
                    </div>
                    <div id="strategy-box"></div>
                </div>
                <div class="grid-item">
                    <h2>Assigned KPIs</h2>
                    <div id="assigned-kpis-container"></div>
                    <form id="assign-kpi-form" class="form-section">
                        <h4>Assign New KPI</h4>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <div class="form-group" style="flex:2;"><label>KPI from Library</label><select id="assign-kpi-select" required></select></div>
                            <div class="form-group" style="flex:1;"><label>Target</label><input type="number" id="assign-kpi-target" required></div>
                            <button type="submit" style="width:auto; height: 38px;">Assign</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const state = { team: [], kpiLibrary: [], activeMemberId: null };
    const nineBoxStrategies = {
        '3A':{t:'Future Leader',c:'#2a9d8f',s:'Challenge & accelerate.'}, '3B':{t:'High Potential',c:'#2a9d8f',s:'Develop skills, assign stretch roles.'}, '3C':{t:'Enigma',c:'#e9c46a',s:'Investigate blockers.'},
        '2A':{t:'Core Player',c:'#2a9d8f',s:'Reward & involve in mentoring.'}, '2B':{t:'Solid Performer',c:'#f4a261',s:'Maintain engagement, enhance skills.'}, '2C':{t:'Inconsistent',c:'#e9c46a',s:'Directly manage, clarify expectations.'},
        '1A':{t:'Workhorse',c:'#f4a261',s:'Value expertise, keep engaged.'}, '1B':{t:'Average',c:'#e76f51',s:'Manage closely, train, assess fit.'}, '1C':{t:'Risk',c:'#e76f51',s:'Implement PIP.'}
    };
    
    const dom = { teamList: document.getElementById('team-list'), kpiLibraryList: document.getElementById('kpi-library-list'), assignKpiSelect: document.getElementById('assign-kpi-select'), placeholder: document.getElementById('placeholder-view'), details: document.getElementById('member-details'), nineBoxGrid: document.getElementById('nine-box-grid') };

    const saveData = () => localStorage.setItem('talentAppFinalDataV5', JSON.stringify(state));
    const loadData = () => { const data = localStorage.getItem('talentAppFinalDataV5'); if (data) Object.assign(state, JSON.parse(data)); };

    const calculateKpiScore = (kpi, assignedKpi, month) => {
        const entry = assignedKpi.history.find(h => h.month === month);
        if (!entry || typeof entry.actual !== 'number' || assignedKpi.target === 0) return 0;
        let score = kpi.direction === 'higher' ? (entry.actual / assignedKpi.target) * 100 : (entry.actual === 0 ? 100 : (2 - (entry.actual / assignedKpi.target)) * 100);
        return Math.min(Math.max(score, 0), 100);
    };

    const calculateAxisScore = (assignedKpis, axis, month) => {
        if (!assignedKpis) return 0;
        let weightedScoreSum = 0, totalWeight = 0;
        assignedKpis.forEach(ak => {
            const kpi = state.kpiLibrary.find(lk => lk.id === ak.libraryId);
            if (kpi && kpi.axis === axis) {
                const score = calculateKpiScore(kpi, ak, month);
                const weight = kpi.weight || 1;
                weightedScoreSum += score * weight;
                totalWeight += weight;
            }
        });
        return totalWeight > 0 ? Math.round(weightedScoreSum / totalWeight) : 0;
    };

    const updateAll = () => { saveData(); renderTeamList(); renderKpiLibraryList(); renderNineBoxGrid(); renderMainContent(); };
    const setActiveMember = id => { state.activeMemberId = id; updateAll(); };

    function renderTeamList() {
        dom.teamList.innerHTML = '';
        state.team.forEach(member => {
            const li = document.createElement('li'); li.textContent = member.name; li.dataset.id = member.id;
            if (member.id === state.activeMemberId) li.classList.add('active');
            li.onclick = () => setActiveMember(member.id);
            dom.teamList.appendChild(li);
        });
    }

    function renderKpiLibraryList() {
        dom.kpiLibraryList.innerHTML = '';
        state.kpiLibrary.forEach(kpi => {
            const li = document.createElement('li'); li.textContent = `${kpi.name} (W: ${kpi.weight})`;
            dom.kpiLibraryList.appendChild(li);
        });
        dom.assignKpiSelect.innerHTML = state.kpiLibrary.map(kpi => `<option value="${kpi.id}">${kpi.name}</option>`).join('');
    }

    function renderNineBoxGrid() {
        const grid = {}; Object.keys(nineBoxStrategies).forEach(k => grid[k] = { ...nineBoxStrategies[k], members: [] });
        const currentMonth = new Date().toISOString().slice(0, 7);
        state.team.forEach(member => {
            const cap = calculateAxisScore(member.assignedKpis, 'capability', currentMonth); const com = calculateAxisScore(member.assignedKpis, 'commitment', currentMonth); const pot = calculateAxisScore(member.assignedKpis, 'potential', currentMonth);
            const perf = (cap + com) / 2; const seg = (pot > 66 ? '3' : pot > 33 ? '2' : '1') + (perf > 66 ? 'A' : perf > 33 ? 'B' : 'C');
            grid[seg].members.push(member.name);
        });
        dom.nineBoxGrid.innerHTML = Object.keys(grid).map(k => `<div class="nine-box-cell" style="border-top:5px solid ${grid[k].c}"><h5>${grid[k].t}</h5><ul>${grid[k].members.map(n=>`<li>${n}</li>`).join('')}</ul></div>`).join('');
    }

    function renderMainContent() {
        const member = state.team.find(m => m.id === state.activeMemberId);
        dom.placeholder.style.display = member ? 'none' : 'flex'; dom.details.style.display = member ? 'block' : 'none';
        if (!member) return;
        document.getElementById('member-name-header').textContent = member.name;
        updateMemberUIDetails(); renderAssignedKpis();
    }
    
    function updateMemberUIDetails() {
        const member = state.team.find(m => m.id === state.activeMemberId); if (!member) return;
        const currentMonth = new Date().toISOString().slice(0, 7);
        const cap = calculateAxisScore(member.assignedKpis, 'capability', currentMonth); const com = calculateAxisScore(member.assignedKpis, 'commitment', currentMonth); const pot = calculateAxisScore(member.assignedKpis, 'potential', currentMonth);
        const perf = (cap + com) / 2; const seg = (pot > 66 ? '3' : pot > 33 ? '2' : '1') + (perf > 66 ? 'A' : perf > 33 ? 'B' : 'C');
        const info = nineBoxStrategies[seg];
        
        document.getElementById('calculated-scores').innerHTML = `<p><strong>Scores:</strong> Cap: ${cap} | Com: ${com} | Pot: ${pot}</p>`;
        const dot = document.getElementById('matrix-dot'); dot.style.left = `${com}%`; dot.style.top = `${100 - cap}%`; dot.style.transform = `translate(-50%, -50%) scale(${0.8 + (pot/100)})`;
        const strategyBox = document.getElementById('strategy-box'); strategyBox.style.background = info.c; strategyBox.innerHTML = `<h3>${info.t}</h3><p>${info.s}</p>`;
    }

    function renderAssignedKpis() {
        const container = document.getElementById('assigned-kpis-container'); container.innerHTML = '';
        const member = state.team.find(m => m.id === state.activeMemberId); if (!member || !member.assignedKpis) return;
        member.assignedKpis.forEach(ak => {
            const kpi = state.kpiLibrary.find(k => k.id === ak.libraryId); if (!kpi) return;
            const item = document.createElement('div'); item.className = 'assigned-kpi-item';
            const currentMonth = new Date().toISOString().slice(0, 7); const currentScore = Math.round(calculateKpiScore(kpi, ak, currentMonth));
            item.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><h5>${kpi.name} (Target: ${ak.target}, W: ${kpi.weight})</h5><button class="delete-btn" data-id="${ak.id}" style="width:auto;background:transparent;border:none;color:#dc3545;">&times;</button></div><small>Current Month Score: ${currentScore}%</small><form class="log-actual-form" data-id="${ak.id}" style="display:flex;gap:10px;margin-top:10px;"><input type="month" value="${currentMonth}" required><input type="number" placeholder="Log Actual" required><button type="submit" style="width:auto;">Log</button></form><div style="font-size:0.8em;margin-top:5px;word-break:break-all;">History: ${ak.history.map(h=>`${h.month}:${h.actual}`).join(', ')}</div>`;
            item.querySelector('.delete-btn').onclick = () => { member.assignedKpis = member.assignedKpis.filter(a => a.id !== ak.id); updateAll(); };
            item.querySelector('.log-actual-form').onsubmit = e => { e.preventDefault(); const month = e.target.querySelector('input[type=month]').value; const actual = parseFloat(e.target.querySelector('input[type=number]').value); if (!month || isNaN(actual)) return; const existing = ak.history.find(h => h.month === month); if (existing) existing.actual = actual; else ak.history.push({month, actual}); ak.history.sort((a,b) => a.month.localeCompare(b.month)); e.target.reset(); updateAll(); };
            container.appendChild(item);
        });
    }
    
    function printReport() {
        let reportHTML = '<h1>Talent Management Report</h1>'; const currentMonth = new Date().toISOString().slice(0, 7);
        state.team.forEach(member => {
            const cap=calculateAxisScore(member.assignedKpis,'capability',currentMonth), com=calculateAxisScore(member.assignedKpis,'commitment',currentMonth), pot=calculateAxisScore(member.assignedKpis,'potential',currentMonth);
            const perf = (cap + com) / 2, seg = (pot > 66 ? '3' : pot > 33 ? '2' : '1') + (perf > 66 ? 'A' : perf > 33 ? 'B' : 'C'), info = nineBoxStrategies[seg];
            reportHTML += `<div style="page-break-inside:avoid;border:1px solid #ccc;padding:15px;margin-bottom:20px;"><h2>${member.name} - ${info.t}</h2><p><strong>Scores:</strong> Cap:${cap} | Com:${com} | Pot:${pot}</p><p><strong>Strategy:</strong> ${info.s}</p><h4>KPIs for ${currentMonth}:</h4><ul>`;
            if (member.assignedKpis && member.assignedKpis.length > 0) { member.assignedKpis.forEach(ak => { const kpi = state.kpiLibrary.find(k => k.id === ak.libraryId), entry = ak.history.find(h => h.month === currentMonth); reportHTML += `<li>${kpi.name} (T:${ak.target}, A:${entry ? entry.actual : 'N/A'}, W:${kpi.weight})</li>`; }); } else { reportHTML += '<li>No KPIs.</li>'; }
            reportHTML += '</ul></div>';
        });
        const printWindow = window.open('', '_blank'); printWindow.document.write(`<html><head><title>Print Report</title><style>body{font-family:sans-serif;} h2{color:#007bff;}</style></head><body>${reportHTML}</body></html>`); printWindow.document.close(); printWindow.print();
    }
    
    document.getElementById('add-member-form').addEventListener('submit', e => { e.preventDefault(); const input = document.getElementById('new-member-name'); if(!input.value.trim()) return; state.team.push({id: Date.now(), name: input.value.trim(), assignedKpis:[]}); input.value = ''; updateAll(); });
    document.getElementById('add-kpi-to-library-form').addEventListener('submit', e => { e.preventDefault(); const name = document.getElementById('new-kpi-library-name').value.trim(); if (!name) return; state.kpiLibrary.push({id: Date.now(), name, axis: document.getElementById('new-kpi-library-axis').value, direction: document.getElementById('new-kpi-library-direction').value, weight: parseInt(document.getElementById('new-kpi-library-weight').value) || 1 }); e.target.reset(); updateAll(); });
    document.getElementById('assign-kpi-form').addEventListener('submit', e => { e.preventDefault(); const member = state.team.find(m => m.id === state.activeMemberId); if (!member) return; const libraryId = parseInt(dom.assignKpiSelect.value), target = parseFloat(document.getElementById('assign-kpi-target').value); if (isNaN(libraryId) || isNaN(target)) return; if (!member.assignedKpis) member.assignedKpis = []; member.assignedKpis.push({id: Date.now(), libraryId, target, history:[]}); e.target.reset(); updateAll(); });
    
    document.getElementById('print-report-btn').addEventListener('click', printReport);
    document.getElementById('export-data-btn').addEventListener('click', () => { const dataStr = JSON.stringify(state, null, 2), blob = new Blob([dataStr], {type:"application/json"}), url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'talent_data.json'; a.click(); URL.revokeObjectURL(url); });

    loadData();
    updateAll();
});
</script>
</body>
</html>
