<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Resource Quantifier & Verifier</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for dark mode and smooth transitions */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Gray-600 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #1f2937; /* Gray-800 */
        }
        /* Hide scrollbar on modal open */
        .modal-open {
            overflow: hidden;
        }
    </style>
</head>

<body class="h-full antialiased text-gray-100">

    <div id="app" class="min-h-full flex flex-col">

        <header class="bg-gray-800 shadow-lg sticky top-0 z-20">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <h1 class="text-3xl font-bold text-blue-400 mb-4">Project Resource Control</h1>
                <div class="flex space-x-2 sm:space-x-4 border-b border-gray-700 pb-1 overflow-x-auto">
                    <button data-page="dashboard" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500" data-active="true">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline-block mr-1"></i> Dashboard
                    </button>
                    <button data-page="manpower" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="users" class="w-4 h-4 inline-block mr-1"></i> Manpower
                    </button>
                    <button data-page="material" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="brick-wall" class="w-4 h-4 inline-block mr-1"></i> Material
                    </button>
                    <button data-page="vehicles" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="truck" class="w-4 h-4 inline-block mr-1"></i> V/E & Tools
                    </button>
                    <button data-page="overheads" class="page-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors duration-200 border-b-2 border-transparent text-gray-400 hover:text-gray-100 data-[active=true]:text-blue-400 data-[active=true]:border-blue-500">
                        <i data-lucide="trending-up" class="w-4 h-4 inline-block mr-1"></i> Overheads
                    </button>
                </div>
            </nav>
        </header>

        <main class="flex-grow max-w-7xl mx-auto p-4 sm:px-6 lg:px-8 flex flex-col gap-6">

            <section id="dashboard-view" class="w-full space-y-8 p-4 bg-gray-900 rounded-xl hidden">
                <h2 class="text-3xl font-bold text-gray-100 border-b border-gray-700 pb-3">Project Financial KPIs</h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="gauge" class="w-8 h-8 text-blue-400"></i>
                            <h3 class="text-lg font-semibold text-gray-300">Cost Performance Index (CPI)</h3>
                        </div>
                        <p id="kpi-cpi" class="text-4xl font-extrabold mt-3 text-blue-400">1.00</p>
                        <p id="kpi-cpi-status" class="text-sm mt-1 text-gray-400">On Target (Budget Efficiency)</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="trending-up" class="w-8 h-8 text-yellow-400"></i>
                            <h3 class="text-lg font-semibold text-gray-300">Total Cost Variance (CV)</h3>
                        </div>
                        <p id="kpi-cv" class="text-4xl font-extrabold mt-3 text-yellow-400">0.00</p>
                        <p id="kpi-cv-status" class="text-sm mt-1 text-gray-400">Planned Qty - Actual Qty</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="percent" class="w-8 h-8 text-green-400"></i>
                            <h3 class="text-lg font-semibold text-gray-300">Overall Utilization</h3>
                        </div>
                        <p id="kpi-utilization" class="text-4xl font-extrabold mt-3 text-green-400">0%</p>
                        <p class="text-sm mt-1 text-gray-400">Total Actual / Total Planned</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="alert-triangle" class="w-8 h-8 text-red-400"></i>
                            <h3 class="text-lg font-semibold text-gray-300">Exceeded Resources</h3>
                        </div>
                        <p id="kpi-exceeded" class="text-4xl font-extrabold mt-3 text-red-400">0</p>
                        <p class="text-sm mt-1 text-gray-400">Items where Actual > Planned</p>
                    </div>

                </div>

                <div class="pt-6">
                    <h3 class="text-xl font-semibold text-gray-200 mb-4">Breakdown by Category</h3>
                    <div id="category-breakdown" class="space-y-4">
                        <p class="text-gray-500 italic text-center p-4">Loading category data...</p>
                    </div>
                </div>

            </section>

            <div id="resource-manager-view" class="flex flex-col md:flex-row gap-6">
                <section id="control-panel" class="md:w-full md:max-w-sm flex-shrink-0 bg-gray-800 rounded-xl shadow-2xl p-6 h-fit sticky top-20">
                    <h2 id="form-title" class="text-2xl font-semibold mb-4 text-gray-100"><i data-lucide="plus-circle" class="w-6 h-6 inline-block mr-2 text-blue-400"></i> Add New Resource</h2>
                    <form id="resource-form" class="space-y-4">
                        <input type="hidden" id="item-id">
                        <input type="hidden" id="item-page">

                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300">Resource Name</label>
                            <input type="text" id="title" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., Concrete Mixer, Site Engineer, Cement Bag" maxlength="100" required>
                            <p id="title-error" class="text-sm text-red-400 mt-1 hidden"></p>
                        </div>

                        <div>
                            <label for="planned-qty" class="block text-sm font-medium text-gray-300">Planned Quantity (Qty/Hrs)</label>
                            <input type="number" id="planned-qty" min="0" step="any" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 50 (Bags), 120 (Hours), 1 (Unit)" required>
                        </div>

                        <div>
                            <label for="actual-qty" class="block text-sm font-medium text-gray-300">Actual Used Quantity</label>
                            <input type="number" id="actual-qty" min="0" step="any" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 55 (Bags), 130 (Hours), 1 (Unit)" required>
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300">Unit / Details</label>
                            <textarea id="description" rows="3" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., M3, Tons, Hours/Day. Add any verification notes."></textarea>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-900 transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-500 disabled:cursor-not-allowed">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                            <span id="submit-text">Add Resource</span>
                        </button>
                        <button type="button" id="cancel-btn" class="w-full flex justify-center items-center py-2 px-4 border border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-900 transition duration-150 hidden">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i> Cancel Edit
                        </button>
                    </form>

                    <div class="mt-8 pt-6 border-t border-gray-700 space-y-3">
                        <h3 class="text-lg font-semibold text-gray-200">Data Management</h3>
                        <button id="export-btn" class="w-full flex justify-center items-center py-2 px-4 border border-yellow-500 rounded-lg shadow-sm text-sm font-medium text-yellow-400 bg-gray-800 hover:bg-gray-700 transition duration-150 transform hover:scale-[1.01]">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export Data (JSON)
                        </button>

                        <label for="import-file" class="w-full flex justify-center items-center py-2 px-4 border border-green-500 rounded-lg shadow-sm text-sm font-medium text-green-400 bg-gray-800 hover:bg-gray-700 cursor-pointer transition duration-150 transform hover:scale-[1.01]">
                            <i data-lucide="upload" class="w-4 h-4 mr-2"></i> Import Data (Merge JSON)
                            <input type="file" id="import-file" accept=".json" class="hidden">
                        </label>
                    </div>
                </section>

                <section id="list-panel" class="flex-grow w-full">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div class="relative w-full sm:w-3/4">
                            <input type="text" id="search-input" placeholder="Search resources by name or unit..." class="w-full p-3 pl-10 bg-gray-800 border border-gray-700 rounded-xl text-gray-100 focus:ring-blue-500 focus:border-blue-500 transition duration-150 placeholder-gray-500">
                            <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                        </div>
                    </div>

                    <div id="items-list" class="space-y-4 custom-scrollbar overflow-y-auto max-h-[80vh]">
                        <div id="loading-spinner" class="flex justify-center items-center p-8 text-blue-400">
                            <i data-lucide="loader" class="w-8 h-8 animate-spin mr-2"></i>
                            <span>Loading Resources...</span>
                        </div>
                        <p id="no-items-message" class="text-center text-gray-500 italic p-8 hidden">
                            No resources found for this category. Use the form on the left to add one!
                        </p>
                    </div>
                </section>
            </div>

        </main>

    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2">
        </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none" aria-modal="true" role="dialog">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-all duration-300">
            <div class="text-center">
                <i data-lucide="alert-triangle" class="w-10 h-10 mx-auto text-red-500 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-100 mb-2">Confirm Deletion</h3>
                <p class="text-sm text-gray-400">Are you sure you want to delete this resource? This action cannot be undone.</p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">Cancel</button>
                <button id="modal-delete-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">Delete Permanently</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS AND CONFIGURATION ---
            const DB_NAME = 'ProjectManagerDB';
            const STORE_NAME = 'items';
            const DB_VERSION = 1;
            const PAGES = ['dashboard', 'manpower', 'material', 'vehicles', 'overheads'];
            let db;
            let currentEditId = null;
            let currentDeleteId = null;
            let currentPage = 'dashboard'; // Default page is now Dashboard

            // --- DOM ELEMENTS ---
            const form = document.getElementById('resource-form');
            const submitBtn = document.getElementById('submit-btn');
            const submitText = document.getElementById('submit-text');
            const cancelBtn = document.getElementById('cancel-btn');
            const itemsList = document.getElementById('items-list');
            const formTitle = document.getElementById('form-title');
            const titleInput = document.getElementById('title');
            const titleError = document.getElementById('title-error');
            const itemIdInput = document.getElementById('item-id');
            const itemPageInput = document.getElementById('item-page');
            const searchInput = document.getElementById('search-input');
            const deleteModal = document.getElementById('delete-modal');
            const modalDeleteBtn = document.getElementById('modal-delete-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const noItemsMessage = document.getElementById('no-items-message');
            
            // Dashboard Elements
            const dashboardView = document.getElementById('dashboard-view');
            const resourceManagerView = document.getElementById('resource-manager-view');
            const categoryBreakdown = document.getElementById('category-breakdown');


            // --- UI HELPER FUNCTIONS ---

            /**
             * Displays a color-coded toast notification.
             * @param {string} message - The message to display.
             * @param {'success'|'danger'|'warning'} type - The type of notification.
             */
            const showToast = (message, type) => {
                const colors = {
                    success: { bg: 'bg-green-600', icon: 'check-circle' },
                    danger: { bg: 'bg-red-600', icon: 'alert-triangle' },
                    warning: { bg: 'bg-yellow-600', icon: 'alert-circle' }
                };
                const config = colors[type] || colors.success;

                const toast = document.createElement('div');
                toast.className = `flex items-center p-4 rounded-lg shadow-xl text-white ${config.bg} transform translate-x-full transition-transform duration-300`;
                toast.innerHTML = `
                    <i data-lucide="${config.icon}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
                    <div class="text-sm font-medium">${message}</div>
                `;

                lucide.createIcons(); // Initialize the icon

                document.getElementById('toast-container').appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                    toast.classList.add('translate-x-0');
                }, 10);

                // Auto-hide after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-full');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };

            /**
             * Renders the list of items to the DOM.
             * @param {Array} items - The list of item objects.
             */
            const renderItems = (items) => {
                itemsList.innerHTML = '';
                loadingSpinner.classList.add('hidden');
                noItemsMessage.classList.add('hidden');

                const filteredItems = items.filter(item => item.page === currentPage);

                if (filteredItems.length === 0) {
                    noItemsMessage.classList.remove('hidden');
                    return;
                }

                // Sort by timestamp descending (newest first)
                filteredItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                filteredItems.forEach(item => {
                    const plannedQty = parseFloat(item.plannedQty) || 0;
                    const actualQty = parseFloat(item.actualQty) || 0;
                    const isExceeded = actualQty > plannedQty;
                    const difference = (actualQty - plannedQty).toFixed(2);
                    const diffColor = isExceeded ? 'text-red-400' : 'text-green-400';
                    const diffIcon = isExceeded ? 'arrow-up' : 'check';
                    const exceedingText = isExceeded ? `Exceeded by ${difference}` : `Under/On Plan (${difference})`;

                    const card = document.createElement('div');
                    card.className = 'item-card bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-gray-700 transition duration-300 hover:border-blue-500 space-y-3';
                    if (isExceeded) {
                        card.classList.add('border-l-red-500'); // Highlight exceeded items
                        card.classList.remove('hover:border-blue-500');
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-100">${item.title}</h3>
                            <div class="flex space-x-2">
                                <button data-id="${item.id}" class="duplicate-btn p-2 text-gray-400 hover:text-yellow-400 transition transform hover:scale-110" title="Duplicate">
                                    <i data-lucide="copy" class="w-5 h-5"></i>
                                </button>
                                <button data-id="${item.id}" class="edit-btn p-2 text-gray-400 hover:text-blue-400 transition transform hover:scale-110" title="Edit">
                                    <i data-lucide="pencil" class="w-5 h-5"></i>
                                </button>
                                <button data-id="${item.id}" class="delete-btn p-2 text-gray-400 hover:text-red-400 transition transform hover:scale-110" title="Delete">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm font-medium border-t border-b border-gray-700 py-3">
                            <div>
                                <p class="text-gray-400">Planned Qty</p>
                                <p class="text-gray-100 text-lg">${plannedQty}</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Actual Used</p>
                                <p class="text-gray-100 text-lg">${actualQty}</p>
                            </div>
                            <div class="col-span-2 md:col-span-1 border-t md:border-t-0 pt-3 md:pt-0 border-gray-700 md:border-l md:pl-4">
                                <p class="text-gray-400">QS Verification Status</p>
                                <p class="flex items-center ${diffColor} text-lg font-bold">
                                    <i data-lucide="${diffIcon}" class="w-5 h-5 mr-1"></i>
                                    ${exceedingText}
                                </p>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-300 line-clamp-2">
                           <span class="font-semibold text-blue-300">Unit/Details:</span> ${item.description || 'N/A'}
                        </p>

                        <p class="text-xs text-gray-500 mt-2">
                            Last Modified: ${new Date(item.timestamp).toLocaleString()}
                        </p>
                    `;
                    itemsList.appendChild(card);
                });

                lucide.createIcons(); // Initialize icons in the new cards
            };

            /**
             * Populates the form fields for editing an item.
             * @param {object} item - The item object to edit.
             */
            const populateFormForEdit = (item) => {
                currentEditId = item.id;
                formTitle.innerHTML = `<i data-lucide="edit" class="w-6 h-6 inline-block mr-2 text-yellow-400"></i> Edit Resource (ID: ${item.id})`;
                titleInput.value = item.title;
                document.getElementById('planned-qty').value = item.plannedQty;
                document.getElementById('actual-qty').value = item.actualQty;
                document.getElementById('description').value = item.description;
                itemIdInput.value = item.id;
                itemPageInput.value = item.page;

                submitText.textContent = 'Update Resource';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                cancelBtn.classList.remove('hidden');

                // Scroll to the form
                document.getElementById('control-panel').scrollIntoView({ behavior: 'smooth' });
            };

            /** Resets the form and UI state after an operation. */
            const resetForm = () => {
                currentEditId = null;
                form.reset();
                formTitle.innerHTML = `<i data-lucide="plus-circle" class="w-6 h-6 inline-block mr-2 text-blue-400"></i> Add New Resource`;
                itemIdInput.value = '';
                itemPageInput.value = currentPage; // Important: Set page to current active page

                submitText.textContent = 'Add Resource';
                submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                cancelBtn.classList.add('hidden');
                titleError.classList.add('hidden');
                titleInput.classList.remove('border-red-500');
            };

            /**
             * Activates a new page tab and loads/filters data, or loads dashboard.
             * @param {string} page - The name of the page to activate.
             */
            const activatePage = (page) => {
                currentPage = page;
                document.querySelectorAll('.page-tab').forEach(tab => {
                    const isActive = tab.getAttribute('data-page') === page;
                    tab.setAttribute('data-active', isActive);
                });
                
                // Toggle view sections
                if (page === 'dashboard') {
                    resourceManagerView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    calculateKPIsAndRenderDashboard();
                } else {
                    dashboardView.classList.add('hidden');
                    resourceManagerView.classList.remove('hidden');
                    resetForm();
                    loadItems(); // Load resource list for resource pages
                }
            };

            // --- INDEXEDDB SETUP ---

            /** Initializes the IndexedDB. */
            const initDB = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onerror = (event) => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        showToast(`DB error: ${event.target.errorCode}`, 'danger');
                        reject('Database error');
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        console.log("DB initialized successfully.");
                        resolve();
                    };

                    // Schema migration/creation
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                            // Optionally create an index for quick lookups
                            objectStore.createIndex('page', 'page', { unique: false });
                            console.log("Object store created successfully.");
                        }
                    };
                });
            };

            // --- KPI & DASHBOARD LOGIC ---

            /** Fetches all data, calculates KPIs, and updates the dashboard. */
            const calculateKPIsAndRenderDashboard = async () => {
                let allItems = [];
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = (event) => {
                        allItems = event.target.result;
                        
                        let totalPlannedQty = 0;
                        let totalActualQty = 0;
                        let exceededCount = 0;
                        const breakdown = {};

                        // Initialize breakdown for all resource pages
                        const resourcePages = PAGES.filter(p => p !== 'dashboard');
                        resourcePages.forEach(page => {
                            breakdown[page] = { planned: 0, actual: 0, exceeded: 0 };
                        });

                        allItems.forEach(item => {
                            const planned = parseFloat(item.plannedQty) || 0;
                            const actual = parseFloat(item.actualQty) || 0;

                            totalPlannedQty += planned;
                            totalActualQty += actual;

                            if (actual > planned) {
                                exceededCount++;
                            }

                            if (breakdown[item.page]) {
                                breakdown[item.page].planned += planned;
                                breakdown[item.page].actual += actual;
                                if (actual > planned) {
                                    breakdown[item.page].exceeded++;
                                }
                            }
                        });

                        // 1. Calculate Core KPIs
                        const costVariance = totalPlannedQty - totalActualQty; // CV
                        const costPerformanceIndex = totalPlannedQty === 0 ? 1.0 : totalPlannedQty / totalActualQty; // CPI
                        const utilization = totalPlannedQty === 0 ? 0 : (totalActualQty / totalPlannedQty) * 100;

                        // 2. Render Core KPIs
                        document.getElementById('kpi-cpi').textContent = costPerformanceIndex.toFixed(2);
                        document.getElementById('kpi-cv').textContent = costVariance.toFixed(2);
                        document.getElementById('kpi-utilization').textContent = `${utilization.toFixed(1)}%`;
                        document.getElementById('kpi-exceeded').textContent = exceededCount;

                        // Set CPI Status Text & Color
                        const cpiStatus = document.getElementById('kpi-cpi-status');
                        if (costPerformanceIndex > 1.05) {
                            cpiStatus.textContent = 'Excellent! Running under budget.';
                            document.getElementById('kpi-cpi').classList.add('text-green-400');
                            document.getElementById('kpi-cpi').classList.remove('text-blue-400', 'text-red-400');
                        } else if (costPerformanceIndex >= 0.95) {
                            cpiStatus.textContent = 'On Target (Budget Efficiency)';
                            document.getElementById('kpi-cpi').classList.add('text-blue-400');
                            document.getElementById('kpi-cpi').classList.remove('text-green-400', 'text-red-400');
                        } else {
                            cpiStatus.textContent = 'Warning! Running over budget.';
                            document.getElementById('kpi-cpi').classList.add('text-red-400');
                            document.getElementById('kpi-cpi').classList.remove('text-blue-400', 'text-green-400');
                        }

                        // 3. Render Breakdown
                        renderCategoryBreakdown(breakdown);

                    };

                    request.onerror = (event) => {
                        console.error("Dashboard load error:", event.target.error);
                        showToast(`Failed to load dashboard data: ${event.target.error}`, 'danger');
                    };

                } catch (e) {
                    console.error("Dashboard calculation error:", e);
                    showToast(`Critical dashboard error: ${e.message}`, 'danger');
                }
            };
            
            /** Renders the detailed breakdown for each resource category. */
            const renderCategoryBreakdown = (breakdown) => {
                categoryBreakdown.innerHTML = '';
                const pageNames = {
                    'manpower': 'Manpower', 
                    'material': 'Material', 
                    'vehicles': 'Vehicles & Equipment', 
                    'overheads': 'Overheads'
                };

                const resourcePages = PAGES.filter(p => p !== 'dashboard');

                resourcePages.forEach(page => {
                    const data = breakdown[page];
                    const planned = data.planned;
                    const actual = data.actual;
                    const totalResources = data.planned + data.actual;
                    const utilizationPercent = planned === 0 ? 0 : (actual / planned) * 100;
                    const utilizationStatus = utilizationPercent > 100 ? 'text-red-400' : 'text-green-400';
                    const icon = (page === 'manpower') ? 'users' : (page === 'material' ? 'brick-wall' : (page === 'vehicles' ? 'truck' : 'trending-up'));

                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-5 rounded-xl shadow-lg flex justify-between items-center transition duration-300 hover:bg-gray-700';
                    card.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <i data-lucide="${icon}" class="w-8 h-8 text-blue-400"></i>
                            <div>
                                <h4 class="text-xl font-bold text-gray-100">${pageNames[page]}</h4>
                                <p class="text-sm text-gray-400">${data.exceeded} resources exceeded their planned quantity.</p>
                            </div>
                        </div>
                        <div class="text-right space-y-1">
                            <p class="text-sm font-medium text-gray-300">Planned: <span class="text-blue-400">${planned.toFixed(2)}</span></p>
                            <p class="text-sm font-medium text-gray-300">Actual: <span class="${utilizationStatus}">${actual.toFixed(2)}</span></p>
                            <p class="text-lg font-bold ${utilizationStatus}">${utilizationPercent.toFixed(1)}% Usage</p>
                        </div>
                    `;
                    categoryBreakdown.appendChild(card);
                });
                lucide.createIcons();
            };


            // --- CRUD OPERATIONS (Unchanged from previous version) ---

            /**
             * Saves a new item or updates an existing one.
             * @param {object} itemData - The data object for the item.
             */
            const saveItem = async (itemData) => {
                submitBtn.disabled = true;
                const originalText = submitText.textContent;
                submitText.textContent = currentEditId ? 'Updating...' : 'Saving...';
                
                // Client-side validation
                if (!itemData.title.trim()) {
                    titleError.textContent = 'Resource Name is required.';
                    titleError.classList.remove('hidden');
                    titleInput.classList.add('border-red-500');
                    submitBtn.disabled = false;
                    submitText.textContent = originalText;
                    showToast('Validation failed: Resource Name missing.', 'warning');
                    return;
                } else {
                    titleError.classList.add('hidden');
                    titleInput.classList.remove('border-red-500');
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                const item = {
                    title: itemData.title.trim(),
                    description: itemData.description.trim(),
                    plannedQty: parseFloat(itemData.plannedQty) || 0,
                    actualQty: parseFloat(itemData.actualQty) || 0,
                    page: itemData.page || currentPage, // Ensure page is set
                    timestamp: new Date().toISOString(),
                };

                let request;
                let isUpdate = false;

                if (currentEditId) {
                    // Update operation
                    item.id = currentEditId; // Keep the original ID
                    request = store.put(item);
                    isUpdate = true;
                } else {
                    // Create operation
                    request = store.add(item);
                }

                request.onsuccess = () => {
                    showToast(`Resource ${isUpdate ? 'Updated' : 'Added'} successfully!`, 'success');
                    resetForm();
                    loadItems(); // Refresh the list
                };

                request.onerror = (event) => {
                    console.error("Save error:", event.target.error);
                    showToast(`Failed to save resource: ${event.target.error}`, 'danger');
                };

                transaction.oncomplete = () => {
                    submitBtn.disabled = false;
                    submitText.textContent = isUpdate ? 'Update Resource' : 'Add Resource';
                    if (!isUpdate) resetForm(); // Only reset form completely after successful ADD
                };
                transaction.onerror = () => {
                     submitBtn.disabled = false;
                     submitText.textContent = isUpdate ? 'Update Resource' : 'Add Resource';
                }
            };

            /** Loads all items from the DB and renders them. */
            const loadItems = async () => {
                try {
                    loadingSpinner.classList.remove('hidden');
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = (event) => {
                        // Apply the current search filter before rendering
                        const allItems = event.target.result;
                        const searchTerm = searchInput.value.toLowerCase().trim();
                        const filteredItems = searchTerm
                            ? allItems.filter(item =>
                                (item.title && item.title.toLowerCase().includes(searchTerm)) ||
                                (item.description && item.description.toLowerCase().includes(searchTerm))
                            )
                            : allItems;

                        renderItems(filteredItems);
                    };

                    request.onerror = (event) => {
                        console.error("Load error:", event.target.error);
                        showToast(`Failed to load items: ${event.target.error}`, 'danger');
                        loadingSpinner.classList.add('hidden');
                    };
                } catch (e) {
                    console.error("Load catch error:", e);
                    showToast(`Critical load error: ${e.message}`, 'danger');
                    loadingSpinner.classList.add('hidden');
                }
            };

            /**
             * Deletes an item by its ID.
             * @param {number} id - The ID of the item to delete.
             */
            const deleteItem = (id) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => {
                    showToast('Resource deleted successfully.', 'success');
                    closeModal();
                    loadItems(); // Refresh the list
                    if (currentEditId === id) resetForm(); // Clear form if we deleted the item being edited
                };

                request.onerror = (event) => {
                    console.error("Delete error:", event.target.error);
                    showToast(`Failed to delete resource: ${event.target.error}`, 'danger');
                    closeModal();
                };
            };

            /**
             * Duplicates an item by its ID.
             * @param {number} id - The ID of the item to duplicate.
             */
            const duplicateItem = async (id) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(id);

                    request.onsuccess = () => {
                        const originalItem = request.result;
                        if (originalItem) {
                            // Create a new object without the 'id' (auto-increment) and with new timestamp
                            const newItem = {
                                title: `COPY: ${originalItem.title}`,
                                description: originalItem.description,
                                plannedQty: originalItem.plannedQty,
                                actualQty: originalItem.actualQty,
                                page: originalItem.page,
                                timestamp: new Date().toISOString(),
                            };

                            const writeTransaction = db.transaction([STORE_NAME], 'readwrite');
                            const writeStore = writeTransaction.objectStore(STORE_NAME);
                            const addRequest = writeStore.add(newItem);

                            addRequest.onsuccess = () => {
                                showToast(`Resource duplicated successfully.`, 'warning');
                                loadItems();
                            };
                            addRequest.onerror = (event) => {
                                console.error("Duplicate save error:", event.target.error);
                                showToast(`Failed to duplicate: ${event.target.error}`, 'danger');
                            };
                        }
                    };
                } catch (e) {
                    console.error("Duplicate item error:", e);
                    showToast(`Critical duplication error: ${e.message}`, 'danger');
                }
            };


            // --- MODAL CONTROL ---

            /** Opens the delete confirmation modal. */
            const openModal = (id) => {
                currentDeleteId = id;
                document.body.classList.add('modal-open');
                deleteModal.classList.remove('opacity-0', 'pointer-events-none');
                deleteModal.querySelector('div').classList.remove('scale-95');
                deleteModal.querySelector('div').classList.add('scale-100');
            };

            /** Closes the delete confirmation modal. */
            const closeModal = () => {
                currentDeleteId = null;
                document.body.classList.remove('modal-open');
                deleteModal.querySelector('div').classList.remove('scale-100');
                deleteModal.querySelector('div').classList.add('scale-95');
                deleteModal.classList.add('opacity-0', 'pointer-events-none');
            };

            // --- DATA IMPORT/EXPORT ---

            /** Exports all data to a JSON file. */
            const exportData = async () => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const data = JSON.stringify(request.result, null, 2);
                        const blob = new Blob([data], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `project_resource_data_${new Date().toISOString().slice(0, 10)}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showToast('Data successfully exported.', 'success');
                    };
                    request.onerror = () => {
                        showToast('Failed to read data for export.', 'danger');
                    };
                } catch (e) {
                    showToast(`Export error: ${e.message}`, 'danger');
                }
            };

            /** Imports data from a JSON file (non-destructive merge). */
            const importData = (file) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) {
                            throw new Error('JSON file format invalid (must be an array).');
                        }

                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        let importedCount = 0;

                        // Non-destructive merge: Add each item with a new ID and timestamp
                        importedData.forEach(item => {
                            const newItem = {
                                title: item.title,
                                description: item.description,
                                plannedQty: item.plannedQty,
                                actualQty: item.actualQty,
                                page: item.page || 'manpower', // Default page if missing
                                timestamp: new Date().toISOString(), // Ensure new timestamp
                            };
                            // The 'id' field is removed, forcing IndexedDB to auto-increment a new one.
                            delete newItem.id;
                            store.add(newItem).onsuccess = () => {
                                importedCount++;
                            };
                        });

                        transaction.oncomplete = () => {
                            showToast(`Successfully imported and merged ${importedCount} records.`, 'success');
                            activatePage(currentPage); // Re-activate current page (which could be the dashboard)
                        };

                        transaction.onerror = (event) => {
                            showToast(`Import error during transaction: ${event.target.error}`, 'danger');
                        };

                    } catch (error) {
                        console.error('Import process failed:', error);
                        showToast(`Import failed: ${error.message}`, 'danger');
                    }
                };
                reader.readAsText(file);
            };

            // --- EVENT LISTENERS ---

            // Form Submission (Create/Update)
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemData = {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    plannedQty: document.getElementById('planned-qty').value,
                    actualQty: document.getElementById('actual-qty').value,
                    page: currentPage,
                    id: itemIdInput.value ? parseInt(itemIdInput.value) : null
                };
                saveItem(itemData);
            });

            // Cancel Edit
            cancelBtn.addEventListener('click', resetForm);

            // Item Action Delegation (Edit/Delete/Duplicate)
            itemsList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const id = parseInt(target.getAttribute('data-id'));
                if (isNaN(id)) return;

                if (target.classList.contains('edit-btn')) {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    store.get(id).onsuccess = (event) => {
                        populateFormForEdit(event.target.result);
                    };
                } else if (target.classList.contains('delete-btn')) {
                    openModal(id);
                } else if (target.classList.contains('duplicate-btn')) {
                    duplicateItem(id);
                }
            });

            // Delete Modal Handlers
            modalDeleteBtn.addEventListener('click', () => {
                if (currentDeleteId !== null) {
                    deleteItem(currentDeleteId);
                }
            });
            modalCancelBtn.addEventListener('click', closeModal);
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) closeModal(); // Close when clicking backdrop
            });

            // Search Filter
            searchInput.addEventListener('input', loadItems);

            // Page Navigation
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const page = tab.getAttribute('data-page');
                    activatePage(page);
                });
            });

            // Data Export/Import
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-file').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importData(e.target.files[0]);
                    e.target.value = ''; // Clear file input
                }
            });


            // --- INITIALIZATION ---
            initDB()
                .then(() => {
                    // Start on the dashboard page
                    activatePage('dashboard');
                })
                .catch(e => {
                    console.error("App failed to initialize:", e);
                    document.getElementById('loading-spinner').innerHTML = `<p class="text-red-400">Application failed to initialize database. Please check console.</p>`;
                });
        });
    </script>

</body>
</html>