<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Diagram Data Manager - Live View</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for dark mode */
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: #1f2937; } /* bg-gray-800 */
        body::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } /* bg-gray-600 */
        body::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* bg-gray-500 */
        
        /* Modal Transition Styles */
        .modal-transition-enter { opacity: 0; transform: scale(0.9); }
        .modal-transition-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms ease-out, transform 200ms ease-out; }
        .modal-transition-leave { opacity: 1; transform: scale(1); }
        .modal-transition-leave-active { opacity: 0; transform: scale(0.9); transition: opacity 150ms ease-in, transform 150ms ease-in; }

        /* Custom error message positioning */
        .input-error-message { top: 100%; left: 0; }

        /* --- DIAGRAM SPECIFIC STYLES --- */
        .diagram-node {
            border: 2px solid #3b82f6; /* primary-500 */
            background-color: #1f2937; /* gray-800 */
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .diagram-content {
            padding-top: 1rem;
            padding-left: 0.5rem;
            margin-top: 0.5rem;
        }

        .diagram-title {
            font-weight: 700;
            color: #d1d5db; /* gray-300 */
            padding: 0.25rem 0.5rem;
            background-color: #111827; /* gray-900 */
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        /* Connector Line Styles */
        .diagram-content {
            border-left: 3px solid #60a5fa; /* blue-400 */
        }
        
        .connector-line {
            position: absolute;
            left: -1rem; /* Adjust based on padding */
            top: 0;
            bottom: 0;
            width: 3px;
            z-index: 10;
        }

        /* Continuous Line */
        .connector-continuous { border-color: #60a5fa; } 
        /* Dotted Line */
        .connector-dotted { border-color: #f59e0b; border-style: dotted; } 

        /* --- PRINT STYLES --- */
        @media print {
            /* Hide everything except the diagram view */
            body > * { display: none !important; }
            #view-diagram { 
                display: block !important; 
                position: absolute !important;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            #view-diagram h2, #view-diagram p.text-gray-400.mb-6 { display: none !important; }
            #diagram-view-content {
                background-color: white !important;
                color: black !important;
                border: none !important;
            }
            .diagram-node {
                border-color: #333 !important; /* Darker border for print */
                background-color: #f0f0f0 !important; /* Lighter background for print */
                color: black !important;
            }
            .diagram-title {
                background-color: #ccc !important;
                color: black !important;
            }
            .diagram-content {
                border-left-color: #666 !important;
            }
        }

    </style>
    <script>
        // Configure Tailwind CSS for dark mode and specific palette
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            500: '#3b82f6', // blue-500
                            600: '#2563eb', // blue-600
                        },
                        // Custom toast colors for better contrast in dark mode
                        success: '#10b981', // emerald-500
                        danger: '#ef4444', // red-500
                        warning: '#f59e0b', // amber-500
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">
    
    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-primary-500 flex items-center">
            <i data-lucide="blocks" class="w-8 h-8 mr-3"></i> Block Diagram Data Manager
        </h1>

        <div class="mb-6 flex justify-between items-center border-b border-gray-700">
            <div class="flex space-x-2">
                <button id="tab-list" onclick="switchView('list')" class="px-4 py-2 text-sm font-medium border-b-2 border-primary-500 text-primary-500 transition duration-150">
                    <i data-lucide="list-ordered" class="w-4 h-4 inline-block mr-1"></i> List View (CRUD)
                </button>
                <button id="tab-diagram" onclick="switchView('diagram')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-200 transition duration-150">
                    <i data-lucide="layout-grid" class="w-4 h-4 inline-block mr-1"></i> Diagram View (Live)
                </button>
            </div>
             <button id="print-btn" onclick="printDiagram()" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-300 bg-gray-700 hover:bg-gray-600 transition duration-150 hidden">
                <i data-lucide="printer" class="w-4 h-4 inline-block mr-1"></i> Print Diagram
            </button>
        </div>

        <div id="view-list" class="block">
             <div class="flex flex-col md:flex-row gap-8">
                
                <div class="md:w-1/3 md:max-w-sm flex-shrink-0 sticky top-4 h-full">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl">
                        <h2 id="form-title" class="text-xl font-semibold mb-4 text-gray-200">Create New Block</h2>
                        <form id="item-form">
                            <input type="hidden" id="edit-id">

                            <div class="mb-4 relative">
                                <label for="title" class="block text-sm font-medium text-gray-400 mb-1">Block Title <span class="text-danger">*</span></label>
                                <input type="text" id="title" maxlength="100" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-500 focus:ring-primary-500 focus:border-primary-500 transition duration-150" placeholder="e.g., RA2L1 MCU" required>
                                <p id="title-error" class="input-error-message absolute text-xs text-danger mt-1"></p>
                            </div>

                            <div class="mb-4">
                                <label for="description" class="block text-sm font-medium text-gray-400 mb-1">Function Description</label>
                                <textarea id="description" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-500 focus:ring-primary-500 focus:border-primary-500 transition duration-150" placeholder="Details about the block's role..."></textarea>
                            </div>

                            <div class="mb-4">
                                <label for="parent_id" class="block text-sm font-medium text-gray-400 mb-1">Parent Block (Hierarchy)</label>
                                <select id="parent_id" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                                    <option value="" class="bg-gray-800">No Parent (Top Level)</option>
                                    </select>
                            </div>
                            
                            <div class="mb-6">
                                <label for="connector_mode" class="block text-sm font-medium text-gray-400 mb-1">Parent Connection Type</label>
                                <select id="connector_mode" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                                    <option value="both_arrow" class="bg-gray-800">Two-Way (Both Arrow) ↔️</option>
                                    <option value="one_arrow" class="bg-gray-800">One-Way (One Arrow) →</option>
                                    <option value="continuous" class="bg-gray-800">Continuous Line ─</option>
                                    <option value="dotted" class="bg-gray-800">Dotted Line ┄</option>
                                </select>
                            </div>

                            <button id="submit-btn" type="submit" class="w-full px-4 py-3 font-semibold rounded-lg shadow-lg bg-primary-600 hover:bg-primary-500 text-white flex items-center justify-center transition duration-200 ease-in-out transform hover:scale-[1.02]">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i> 
                                <span id="submit-text">Add Block</span>
                            </button>

                            <button type="button" id="cancel-edit-btn" class="w-full mt-3 px-4 py-2 font-semibold rounded-lg text-gray-400 hover:text-gray-100 hover:bg-gray-700 transition duration-200 ease-in-out hidden" onclick="resetForm()">
                                Cancel Edit
                            </button>
                        </form>
                    </div>

                    <div class="mt-6 p-6 bg-gray-800 rounded-xl shadow-2xl">
                        <h3 class="text-lg font-semibold mb-4 text-gray-200">Data Utilities</h3>
                        <div class="flex flex-col space-y-3">
                            <button id="export-btn" class="flex items-center justify-center w-full px-4 py-2 text-sm font-medium rounded-lg text-yellow-300 bg-gray-700 hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02]">
                                <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export All Data (JSON)
                            </button>
                            
                            <div class="flex items-center justify-between space-x-2">
                                <input type="file" id="import-file-input" accept="application/json" class="hidden">
                                <label for="import-file-input" class="cursor-pointer flex-grow text-center px-4 py-2 text-sm font-medium rounded-lg text-green-300 bg-gray-700 hover:bg-gray-600 transition duration-150 transform hover:scale-[1.02]">
                                    <i data-lucide="upload" class="w-4 h-4 inline-block mr-2"></i> Import Data (Merge)
                                </label>
                                <button onclick="clearAllDataConfirmation()" class="p-2 text-red-400 hover:text-red-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150 transform hover:scale-[1.05]" title="Clear All Data">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md:flex-1">
                    <div class="mb-6 sticky top-4 z-10 bg-gray-900 pt-1 pb-4">
                        <div class="flex items-center space-x-4">
                            <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Search blocks by title or description..." class="flex-1 p-3 bg-gray-800 border-b-2 border-gray-700 rounded-lg text-gray-100 placeholder-gray-500 focus:border-primary-500 focus:ring-0 transition duration-150">
                        </div>
                    </div>

                    <div id="items-list" class="space-y-4">
                        <p id="no-items-message" class="text-gray-500 text-lg italic text-center p-10 hidden">No blocks found. Start by creating one!</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-diagram" class="hidden p-4 bg-gray-800 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-semibold mb-4 text-gray-200 border-b border-gray-700 pb-2">Live Hierarchical Diagram</h2>
            <p class="text-gray-400 mb-6">This view shows the nesting based on the **Parent Block** relationship you defined, using the selected connector types.</p>
            <div id="diagram-view-content" class="p-4 bg-gray-900 rounded-lg min-h-[300px]">
                <p id="no-diagram-message" class="text-gray-500 text-lg italic text-center p-10 hidden">Add blocks in the List View to see the diagram.</p>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3">
        </div>

    <div id="delete-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden transition-opacity duration-300">
        <div id="delete-modal" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm modal-transition-enter">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-100">Confirm Deletion</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Are you sure you want to delete this block? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-150">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 font-semibold rounded-lg bg-danger hover:bg-red-600 text-white transition duration-150">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL CONSTANTS ---
        const DB_NAME = 'DiagramDB';
        const STORE_NAME = 'items';
        const DB_VERSION = 2; // Increased DB version to add 'connector_mode' field
        let db;
        let allItems = []; // Cache for all records
        
        // --- DOM Elements ---
        const form = document.getElementById('item-form');
        const titleInput = document.getElementById('title');
        const descriptionInput = document.getElementById('description');
        const parentIdSelect = document.getElementById('parent_id');
        const connectorModeSelect = document.getElementById('connector_mode'); // NEW
        const editIdInput = document.getElementById('edit-id');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const itemsList = document.getElementById('items-list');
        const formTitle = document.getElementById('form-title');
        const searchInput = document.getElementById('search-input');
        const titleError = document.getElementById('title-error');
        const exportBtn = document.getElementById('export-btn');
        const importInput = document.getElementById('import-file-input');
        const noItemsMessage = document.getElementById('no-items-message');
        
        // --- VIEW ELEMENTS ---
        const viewList = document.getElementById('view-list');
        const viewDiagram = document.getElementById('view-diagram');
        const tabList = document.getElementById('tab-list');
        const tabDiagram = document.getElementById('tab-diagram');
        const printBtn = document.getElementById('print-btn'); // NEW
        const diagramViewContent = document.getElementById('diagram-view-content');
        const noDiagramMessage = document.getElementById('no-diagram-message');

        // --- MODAL Elements ---
        const modalBackdrop = document.getElementById('delete-modal-backdrop');
        const modal = document.getElementById('delete-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // --- IndexedDB SETUP ---
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (e) => {
                console.error('Database failed to open:', e);
                showToast('Critical DB Error: Database failed to initialize.', 'danger');
            };

            request.onsuccess = (e) => {
                db = e.target.result;
                console.log('Database opened successfully');
                loadItems();
            };

            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (e.oldVersion < 1) {
                    // Initial setup (Version 1)
                    db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
                
                // Upgrade to Version 2: Add 'connector_mode' to existing items on load/save, or handle migration if necessary
                if (e.oldVersion < 2) {
                     // No schema change needed as IndexedDB stores schema-less objects.
                     // The new field 'connector_mode' will be added on the next save/create operation.
                }

                console.log('Database upgrade complete');
            };
        }

        // --- IndexedDB CRUD FUNCTIONS ---

        function getStore(mode) {
            const transaction = db.transaction([STORE_NAME], mode);
            return transaction.objectStore(STORE_NAME);
        }

        /**
         * C - Create/Update an item in the database.
         * Data structure now includes: id, title, description, timestamp, parent_id, connector_mode
         * @param {object} item - The data object to save.
         */
        function saveItem(item) {
            const isUpdate = item.hasOwnProperty('id'); 
            const action = isUpdate ? 'Update' : 'Add';

            try {
                const store = getStore('readwrite');
                const request = isUpdate ? store.put(item) : store.add(item); 

                request.onsuccess = () => {
                    const message = `Block successfully ${isUpdate ? 'updated' : 'added'}.`;
                    showToast(message, 'success');
                    resetForm();
                    loadItems(); 
                };

                request.onerror = (e) => {
                    console.error(`${action} failed:`, e);
                    showToast(`Failed to ${action.toLowerCase()} block.`, 'danger');
                };
            } catch (e) {
                console.error('Transaction error:', e);
                showToast('A database transaction failed.', 'danger');
            } finally {
                setFormProcessing(false);
            }
        }
        
        function loadItems() {
            if (!db) return;

            try {
                const store = getStore('readonly');
                const request = store.getAll();

                request.onsuccess = (e) => {
                    allItems = e.target.result.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    renderItems(allItems);
                    populateParentOptions(allItems);
                    renderDiagram(); 
                };

                request.onerror = (e) => {
                    console.error('Load failed:', e);
                    showToast('Failed to load blocks from database.', 'danger');
                    noItemsMessage.classList.remove('hidden');
                };
            } catch (e) {
                console.error('Transaction error:', e);
                showToast('A database transaction failed during load.', 'danger');
                noItemsMessage.classList.remove('hidden');
            }
        }

        function editItem(id) {
            const item = allItems.find(i => i.id === id);
            if (!item) {
                showToast('Block not found for editing.', 'warning');
                return;
            }

            // Populate form
            editIdInput.value = item.id;
            titleInput.value = item.title;
            descriptionInput.value = item.description;
            parentIdSelect.value = item.parent_id || ""; 
            // NEW: Populate connector mode, default to 'both_arrow' if undefined
            connectorModeSelect.value = item.connector_mode || "both_arrow"; 
            
            // Change form state
            formTitle.textContent = `Edit Block ID: ${item.id}`;
            submitText.textContent = 'Update Block';
            submitBtn.classList.remove('bg-primary-600', 'hover:bg-primary-500');
            submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-500');
            cancelEditBtn.classList.remove('hidden');
            
            populateParentOptions(allItems); 
            
            titleInput.focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteItem(id) {
            try {
                const store = getStore('readwrite');
                const request = store.delete(id);

                request.onsuccess = () => {
                    showToast('Block successfully deleted.', 'success');
                    const hasChildren = allItems.some(item => item.parent_id === id);
                    if (hasChildren) {
                         showToast('Warning: Children of this block are now top-level (parent_id was reset).', 'warning', 5000);
                    }
                    loadItems();
                    resetForm();
                };

                request.onerror = (e) => {
                    console.error('Delete failed:', e);
                    showToast('Failed to delete block.', 'danger');
                };
            } catch (e) {
                console.error('Transaction error:', e);
                showToast('A database transaction failed during deletion.', 'danger');
            }
        }
        
        function duplicateItem(id) {
            const originalItem = allItems.find(i => i.id === id);
            if (!originalItem) {
                showToast('Block not found for duplication.', 'warning');
                return;
            }

            const newItem = {
                title: originalItem.title + ' (Copy)',
                description: originalItem.description,
                parent_id: originalItem.parent_id,
                connector_mode: originalItem.connector_mode, // Include connector mode in duplicate
                timestamp: new Date().toISOString()
            };
            
            saveItem(newItem); 
            showToast('Block duplicated successfully.', 'success');
        }

        // --- FORM AND VALIDATION ---

        form.onsubmit = (e) => {
            e.preventDefault();
            titleError.textContent = ''; 

            const title = titleInput.value.trim();
            const description = descriptionInput.value.trim();
            const parentId = parentIdSelect.value ? parseInt(parentIdSelect.value) : null; 
            const connectorMode = connectorModeSelect.value; // NEW: Get connector mode
            const editId = editIdInput.value ? parseInt(editIdInput.value) : null;
            
            if (!title) {
                titleError.textContent = 'Title cannot be empty.';
                titleInput.focus();
                return;
            }
            
            setFormProcessing(true);

            const now = new Date().toISOString();
            
            const item = {
                title: title,
                description: description,
                parent_id: parentId,
                connector_mode: connectorMode, // NEW: Add connector mode to item
                timestamp: now
            };
            
            if (editId) {
                item.id = editId;
                const original = allItems.find(i => i.id === editId);
                if (original) {
                    item.timestamp = original.timestamp;
                }
            }

            saveItem(item);
        };

        function resetForm() {
            form.reset();
            editIdInput.value = '';
            titleError.textContent = '';
            formTitle.textContent = 'Create New Block';
            submitText.textContent = 'Add Block';
            submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500');
            submitBtn.classList.add('bg-primary-600', 'hover:bg-primary-500');
            cancelEditBtn.classList.add('hidden');
            
            populateParentOptions(allItems);
            connectorModeSelect.value = "both_arrow"; // Reset connector mode
        }
        
        function setFormProcessing(isProcessing) {
            submitBtn.disabled = isProcessing;
            submitText.textContent = isProcessing ? 'Processing...' : (editIdInput.value ? 'Update Block' : 'Add Block');
            submitBtn.classList.toggle('opacity-75', isProcessing);
            submitBtn.classList.toggle('cursor-not-allowed', isProcessing);
        }
        
        // --- UI RENDERING AND HELPERS ---

        function switchView(view) {
            if (view === 'list') {
                viewList.classList.remove('hidden');
                viewDiagram.classList.add('hidden');
                printBtn.classList.add('hidden'); // Hide print button in list view
                tabList.classList.add('border-primary-500', 'text-primary-500');
                tabList.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-200');
                tabDiagram.classList.remove('border-primary-500', 'text-primary-500');
                tabDiagram.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-200');
            } else {
                viewList.classList.add('hidden');
                viewDiagram.classList.remove('hidden');
                printBtn.classList.remove('hidden'); // Show print button in diagram view
                tabDiagram.classList.add('border-primary-500', 'text-primary-500');
                tabDiagram.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-200');
                tabList.classList.remove('border-primary-500', 'text-primary-500');
                tabList.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-200');
            }
        }
        
        /**
         * Triggers the browser's print function for the diagram view.
         */
        function printDiagram() {
            window.print();
        }


        function renderItems(itemsToRender) {
            itemsList.innerHTML = ''; 
            
            if (itemsToRender.length === 0) {
                noItemsMessage.classList.remove('hidden');
                return;
            }
            noItemsMessage.classList.add('hidden');

            itemsToRender.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-primary-600 hover:shadow-primary-700/50 transition duration-200';
                
                const parent = item.parent_id ? allItems.find(i => i.id === item.parent_id) : null;
                const parentName = parent ? `<span class="text-xs font-medium text-gray-400">Parent: <span class="text-primary-400">${parent.title} (#${item.parent_id})</span></span>` : '<span class="text-xs font-medium text-gray-500">Top Level Block</span>';
                
                const connectorLabel = item.parent_id ? `<span class="ml-4 text-xs font-medium text-yellow-500">${getConnectorIcon(item.connector_mode)} ${getConnectorLabel(item.connector_mode)}</span>` : '';


                const date = new Date(item.timestamp).toLocaleString();
                const snippet = item.description ? item.description.substring(0, 150) + (item.description.length > 150 ? '...' : '') : 'No description.';

                itemEl.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl font-bold text-gray-100 flex-1">${item.title} <span class="text-sm font-normal text-gray-500 ml-2">#${item.id}</span></h3>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editItem(${item.id})" class="text-yellow-400 hover:text-yellow-300 p-2 rounded-full hover:bg-gray-700 transition transform hover:scale-105" title="Edit">
                                <i data-lucide="square-pen" class="w-5 h-5"></i>
                            </button>
                            <button onclick="duplicateItem(${item.id})" class="text-green-400 hover:text-green-300 p-2 rounded-full hover:bg-gray-700 transition transform hover:scale-105" title="Duplicate">
                                <i data-lucide="copy" class="w-5 h-5"></i>
                            </button>
                            <button onclick="deleteConfirmation(${item.id}, '${item.title}')" class="text-danger hover:text-red-400 p-2 rounded-full hover:bg-gray-700 transition transform hover:scale-105" title="Delete">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-gray-300 mb-3">${snippet}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span class="flex items-center">${parentName} ${connectorLabel}</span>
                        <span class="text-gray-400">${date}</span>
                    </div>
                `;
                itemsList.appendChild(itemEl);
            });
            
            lucide.createIcons();
        }

        function populateParentOptions(items) {
            parentIdSelect.innerHTML = '<option value="" class="bg-gray-800">No Parent (Top Level)</option>';
            const currentEditId = editIdInput.value ? parseInt(editIdInput.value) : null;
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `#${item.id}: ${item.title}`;
                option.className = 'bg-gray-800'; 
                
                if (currentEditId === item.id) {
                    option.disabled = true;
                    option.textContent += ' (Cannot be parent of self)';
                }
                
                parentIdSelect.appendChild(option);
            });
            
            if (currentEditId) {
                 const currentItem = allItems.find(i => i.id === currentEditId);
                 if (currentItem) {
                    parentIdSelect.value = currentItem.parent_id || ""; 
                 }
            }
        }
        
        // --- CONNECTOR HELPER FUNCTIONS (NEW) ---

        function getConnectorIcon(mode) {
            switch(mode) {
                case 'both_arrow': return '↔️';
                case 'one_arrow': return '→';
                case 'continuous': return '─';
                case 'dotted': return '┄';
                default: return '';
            }
        }

        function getConnectorLabel(mode) {
            switch(mode) {
                case 'both_arrow': return 'Two-Way';
                case 'one_arrow': return 'One-Way';
                case 'continuous': return 'Continuous';
                case 'dotted': return 'Dotted';
                default: return 'Default';
            }
        }
        
        // --- DIAGRAM VIEW LOGIC ---

        function buildTree(list) {
            const map = {};
            const tree = [];

            list.forEach(item => {
                map[item.id] = { 
                    ...item, 
                    connector_mode: item.connector_mode || 'both_arrow', // Ensure mode exists
                    children: [] 
                };
            });

            Object.values(map).forEach(node => {
                if (node.parent_id) {
                    const parent = map[node.parent_id];
                    if (parent) {
                        parent.children.push(node);
                    } else {
                        tree.push(node);
                    }
                } else {
                    tree.push(node);
                }
            });

            return tree;
        }

        /**
         * Recursively generates the HTML for a node and its children (nested).
         * Includes connector icons based on the child's connector_mode.
         * @param {object} node - The current node in the tree.
         * @returns {string} - The HTML string for the node structure.
         */
        function generateNodeHtml(node) {
            const hasChildren = node.children.length > 0;
            const borderStyle = node.parent_id === null ? 'border-primary-500' : 'border-blue-700';
            const shadowStyle = node.parent_id === null ? 'shadow-xl' : 'shadow-md';

            // Base node container
            let html = `
                <div class="diagram-node ${borderStyle} ${shadowStyle}">
                    <div class="diagram-title flex items-center">
                        ${node.title} <span class="text-xs text-gray-500 ml-2">#${node.id}</span>
                    </div>
                    <p class="text-sm text-gray-400 mt-1">${node.description || 'No description'}</p>
            `;

            // If there are children, create a container for them
            if (hasChildren) {
                html += '<div class="diagram-content pl-4 mt-4 pt-4">';
                
                // Recurse for children
                node.children.forEach(child => {
                    // Determine connector class for the child's wrapper
                    const { arrow, lineStyle } = getConnectorClasses(child.connector_mode);
                    
                    html += `
                        <div class="relative group">
                            <div class="absolute left-[-1.5rem] top-0 bottom-0 flex flex-col items-center justify-center text-primary-400 z-20 w-6">
                                ${arrow}
                            </div>
                            <div class="absolute left-0 top-0 bottom-0 w-1 ${lineStyle} transition duration-300"></div>
                            
                            ${generateNodeHtml(child)}
                        </div>
                    `;
                });
                
                html += '</div>'; // Close diagram-content
            }

            html += '</div>'; // Close diagram-node
            return html;
        }

        /**
         * Returns Tailwind classes and icons based on the connector mode.
         * @param {string} mode - The connector mode.
         * @returns {object} - {arrow: string (lucide icon html), lineStyle: string (tailwind classes)}
         */
        function getConnectorClasses(mode) {
            // Note: Since the recursive rendering places the 'connector-line' on the left border of the parent's container, 
            // we primarily use icons and custom CSS for the different styles.
            
            let arrowHtml = '';
            let lineClass = 'border-l border-blue-600'; // Default line style
            
            switch(mode) {
                case 'both_arrow':
                    // Arrows on both sides of the center point
                    arrowHtml = '<i data-lucide="chevrons-up-down" class="w-4 h-4 text-blue-400 -translate-y-4"></i><i data-lucide="chevrons-up-down" class="w-4 h-4 text-blue-400 translate-y-4"></i>';
                    break;
                case 'one_arrow':
                    // Arrow pointing towards the child (downwards in this representation)
                    arrowHtml = '<i data-lucide="chevron-down" class="w-4 h-4 text-blue-400"></i>';
                    break;
                case 'dotted':
                    // Custom CSS handles the border-style for dotted
                    lineClass = 'border-l border-dashed border-yellow-500';
                    break;
                case 'continuous':
                default:
                    // Continuous line (default look)
                    lineClass = 'border-l border-solid border-green-500'; 
                    break;
            }
            
            return { arrow: arrowHtml, lineStyle: lineClass };
        }


        function renderDiagram() {
            diagramViewContent.innerHTML = '';
            
            if (allItems.length === 0) {
                noDiagramMessage.classList.remove('hidden');
                return;
            }
            noDiagramMessage.classList.add('hidden');

            const tree = buildTree(allItems);
            let diagramHtml = '';

            if (tree.length === 0 && allItems.length > 0) {
                diagramHtml = '<p class="text-red-500">Error: Could not determine top-level blocks.</p>';
            } else {
                tree.forEach(topNode => {
                    diagramHtml += generateNodeHtml(topNode);
                });
            }

            diagramViewContent.innerHTML = diagramHtml;
            lucide.createIcons(); // Re-render icons for diagram view
        }


        // --- SEARCH/FILTER LOGIC (UNCHANGED) ---

        searchInput.oninput = (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderItems(allItems); 
                return;
            }

            const filteredItems = allItems.filter(item => {
                const titleMatch = item.title.toLowerCase().includes(searchTerm);
                const descriptionMatch = item.description.toLowerCase().includes(searchTerm);
                return titleMatch || descriptionMatch;
            });

            renderItems(filteredItems);
        };

        // --- TOAST NOTIFICATIONS (UNCHANGED) ---

        function showToast(message, type, duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const colorMap = {
                success: 'bg-success border-success',
                danger: 'bg-danger border-danger',
                warning: 'bg-warning border-warning'
            };
            const iconMap = {
                success: 'check-circle',
                danger: 'alert-triangle',
                warning: 'alert-octagon'
            };

            const toast = document.createElement('div');
            toast.className = `flex items-center p-4 rounded-lg shadow-xl text-white border-l-4 ${colorMap[type]} transition-opacity duration-300 transform opacity-0 translate-y-2`;
            toast.innerHTML = `
                <i data-lucide="${iconMap[type]}" class="w-5 h-5 mr-3"></i>
                <span class="text-sm font-medium">${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            lucide.createIcons(); 

            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300); 
            }, duration);
        }

        // --- MODAL LOGIC (UNCHANGED) ---

        let modalAction;
        
        function deleteConfirmation(id, title) {
            modalTitle.textContent = 'Confirm Block Deletion';
            modalMessage.innerHTML = `Are you sure you want to permanently delete the block: <span class="font-semibold text-primary-400">${title} (#${id})</span>?`;
            modalAction = () => { deleteItem(id); closeModal(); };
            modalConfirmBtn.onclick = modalAction;
            modalConfirmBtn.textContent = 'Delete Block';
            modalConfirmBtn.className = 'px-4 py-2 font-semibold rounded-lg bg-danger hover:bg-red-600 text-white transition duration-150';
            openModal();
        }

        function clearAllDataConfirmation() {
            modalTitle.textContent = 'WARNING: Clear All Data';
            modalMessage.innerHTML = '<span class="font-bold text-danger">This will permanently erase ALL data in the database.</span> Are you absolutely sure you want to proceed?';
            modalAction = () => { clearAllData(); closeModal(); };
            modalConfirmBtn.onclick = modalAction;
            modalConfirmBtn.textContent = 'Erase All Data';
            modalConfirmBtn.className = 'px-4 py-2 font-semibold rounded-lg bg-red-700 hover:bg-red-800 text-white transition duration-150';
            openModal();
        }

        function openModal() {
            document.body.style.overflow = 'hidden'; 
            modalBackdrop.classList.remove('hidden', 'opacity-0');
            modalBackdrop.classList.add('opacity-100');
            modal.classList.remove('modal-transition-leave-active', 'modal-transition-leave');
            modal.classList.add('modal-transition-enter');
            setTimeout(() => modal.classList.add('modal-transition-enter-active'), 10);
        }

        function closeModal() {
            document.body.style.overflow = ''; 
            modal.classList.remove('modal-transition-enter-active', 'modal-transition-enter');
            modal.classList.add('modal-transition-leave');
            setTimeout(() => modal.classList.add('modal-transition-leave-active'), 10);
            setTimeout(() => {
                modalBackdrop.classList.add('hidden', 'opacity-0');
                modalBackdrop.classList.remove('opacity-100');
            }, 200); 
        }
        
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                closeModal();
            }
        });

        // --- DATA UTILITIES (EXPORT/IMPORT/CLEAR) (UNCHANGED) ---

        function clearAllData() {
            try {
                const store = getStore('readwrite');
                const request = store.clear();
                request.onsuccess = () => {
                    showToast('All database records have been cleared.', 'danger');
                    loadItems(); 
                    resetForm();
                };
                request.onerror = (e) => {
                    console.error('Clear failed:', e);
                    showToast('Failed to clear all data.', 'danger');
                };
            } catch (e) {
                console.error('Transaction error:', e);
                showToast('A database transaction failed during clear.', 'danger');
            }
        }

        exportBtn.onclick = () => {
            if (!db) {
                showToast('Database not ready.', 'warning');
                return;
            }
            try {
                const store = getStore('readonly');
                const request = store.getAll();
                request.onsuccess = (e) => {
                    const data = e.target.result;
                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `DiagramDB_Export_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Data exported successfully.', 'success');
                };
                request.onerror = (e) => {
                    console.error('Export failed:', e);
                    showToast('Failed to read data for export.', 'danger');
                };
            } catch (e) {
                console.error('Transaction error:', e);
                showToast('A database transaction failed during export.', 'danger');
            }
        };

        importInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('JSON format is not a valid array of items.');
                    }
                    performImport(importedData);
                } catch (error) {
                    console.error('Import processing error:', error);
                    showToast(`Import failed: Invalid file format. ${error.message}`, 'danger', 7000);
                }
            };
            reader.onerror = () => {
                showToast('File read error during import.', 'danger');
            };
            reader.readAsText(file);
            importInput.value = null; 
        };
        
        function performImport(importedItems) {
            if (!db) return;
            const newItems = importedItems.map(item => ({
                title: String(item.title || 'Untitled Import').substring(0, 100).trim(),
                description: String(item.description || '').trim(),
                parent_id: typeof item.parent_id === 'number' ? item.parent_id : null,
                connector_mode: item.connector_mode || 'both_arrow', // Preserve/default connector mode
                timestamp: new Date().toISOString() 
            }));

            if (newItems.length === 0) {
                 showToast('Import file contained no valid items.', 'warning');
                 return;
            }
            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                let itemsAdded = 0;
                newItems.forEach(item => {
                    delete item.id; 
                    const request = store.add(item); 
                    request.onsuccess = () => { itemsAdded++; };
                });
                transaction.oncomplete = () => {
                    showToast(`Import successful! ${itemsAdded} blocks merged into the database.`, 'success', 5000);
                    loadItems();
                };
                transaction.onerror = (e) => {
                    console.error('Import transaction error:', e);
                    showToast('Database error during import. No data was added.', 'danger');
                };
            } catch (e) {
                console.error('Transaction initiation error:', e);
                showToast('A database transaction failed during import initiation.', 'danger');
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initDB();
            lucide.createIcons();
            switchView('list');
        });
        
        titleInput.onblur = () => {
            titleInput.value = titleInput.value.trim();
        };

    </script>
</body>
</html>