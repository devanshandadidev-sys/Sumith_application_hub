<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Cost Analysis Dashboard (INR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            '50': '#eff6ff', '100': '#dbeafe', '200': '#bfdbfe', '300': '#93c5fd', '400': '#60a5fa', '500': '#3b82f6', '600': '#2563eb', '700': '#1d4ed8', '800': '#1e40af', '900': '#1e3a8a', '950': '#172554'
                        },
                        planned: '#2563eb', // Blue
                        actual: '#f59e0b',  // Amber
                        
                        // New KPI Colors
                        good: '#10b981', // Emerald-500
                        bad: '#ef4444',  // Red-500
                        neutral: '#9ca3af', // Gray-400
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 md:p-8">

    <header class="mb-8 border-b border-gray-700 pb-4">
        <h1 class="text-3xl md:text-4xl font-extrabold text-primary-400 flex items-center">
            <i data-lucide="award" class="w-8 h-8 mr-3"></i>
            Professional Project Cost Analysis
        </h1>
        <p class="text-gray-400 mt-1">Key Performance Indicators (KPIs) for financial control in **INR** using IndexedDB.</p>
    </header>

    <div id="summary-metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div class="bg-gray-800 p-6 rounded-xl shadow-xl border-l-4 border-primary-500">
            <p class="text-sm font-medium text-gray-400 uppercase">Total Planned Cost</p>
            <p id="planned-cost-sum" class="text-3xl font-bold mt-1 text-primary-300">₹0.00</p>
            <div class="text-xs text-gray-500 mt-2 flex items-center">
                 <i data-lucide="piggy-bank" class="w-4 h-4 mr-1"></i> Budget at Completion
            </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-xl shadow-xl border-l-4 border-amber-500">
            <p class="text-sm font-medium text-gray-400 uppercase">Total Actual Cost</p>
            <p id="actual-cost-sum" class="text-3xl font-bold mt-1 text-amber-300">₹0.00</p>
            <div class="text-xs text-gray-500 mt-2 flex items-center">
                 <i data-lucide="wallet" class="w-4 h-4 mr-1"></i> Actual Expenditure
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl shadow-xl border-l-4" id="cpi-card">
            <p class="text-sm font-medium text-gray-400 uppercase">Cost Performance Index (CPI)</p>
            <p id="cpi-value" class="text-3xl font-bold mt-1 text-neutral">N/A</p>
            <div class="text-xs text-gray-500 mt-2 flex items-center">
                 <i data-lucide="activity" id="cpi-icon" class="w-4 h-4 mr-1 text-neutral"></i> Efficiency (Goal: > 1.0)
            </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-xl shadow-xl border-l-4" id="cvp-card">
            <p class="text-sm font-medium text-gray-400 uppercase">Cost Variance % (CV%)</p>
            <p id="cvp-value" class="text-3xl font-bold mt-1 text-neutral">N/A</p>
            <div class="text-xs text-gray-500 mt-2 flex items-center">
                 <i data-lucide="percent" id="cvp-icon" class="w-4 h-4 mr-1 text-neutral"></i> Budget Status (Goal: 0%)
            </div>
        </div>
    </div>

    <section class="mb-10">
        <h2 class="text-2xl font-bold text-gray-100 mb-4 flex items-center">
            <i data-lucide="bar-chart-2" class="w-6 h-6 mr-2 text-primary-400"></i>
            Planned vs. Actual Cost Breakdown
        </h2>

        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
            <canvas id="costBreakdownChart"></canvas>
        </div>
    </section>

    <section>
        <h2 class="text-2xl font-bold text-gray-100 mb-4 flex items-center">
            <i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-primary-400"></i>
            Detailed Cost Items
        </h2>
        <div class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-700 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Item</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Category</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Planned Cost (₹)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Actual Cost (₹)</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider">Variance (₹)</th>
                    </tr>
                </thead>
                <tbody id="items-table-body" class="divide-y divide-gray-800">
                    </tbody>
            </table>
            <p id="table-empty-state" class="text-center py-6 text-gray-500 italic hidden">
                No cost items with rate and quantity found in IndexedDB.
            </p>
        </div>
    </section>

    <script>
        // --- INDEXEDDB CONFIGURATION ---
        const DB_NAME = 'ProjectManagerDB';
        const STORE_NAME = 'items';
        const DB_VERSION = 2;
        let db;

        let processedData = [];
        let summary = {
            totalPlanned: 0,
            totalActual: 0,
            breakdown: {} 
        };
        
        // --- UTILITY FUNCTIONS ---
        
        /**
         * Initializes the IndexedDB connection.
         */
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        /**
         * Fetches all items from IndexedDB.
         * @returns {Promise<Array>} A promise that resolves with the array of items.
         */
        async function fetchAllItems() {
            if (!db) {
                try {
                    db = await initDB();
                } catch (error) {
                    console.error("Failed to connect to DataManagerDB. Dashboard will be empty.", error);
                    return [];
                }
            }

            return new Promise((resolve) => {
                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = () => {
                        resolve(request.result);
                    };

                    request.onerror = (event) => {
                        console.error('IndexedDB fetch error:', event.target.error);
                        resolve([]);
                    };
                } catch (error) {
                    console.error('Transaction creation failed:', error);
                    resolve([]);
                }
            });
        }

        /**
         * Formats a number as an Indian Rupee currency string (INR).
         * Uses 'en-IN' locale for Indian numbering system (lakhs/crores).
         * @param {number} amount - The number to format.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
            }).format(amount);
        }
        
        /**
         * Formats a number as a percentage string.
         */
        function formatPercent(value) {
            return (value * 100).toFixed(2) + '%';
        }


        // --- CORE LOGIC & CALCULATIONS ---

        /**
         * Fetches data, processes it, calculates costs and KPIs, and initiates rendering.
         */
        async function calculateCosts() {
            const items = await fetchAllItems();

            let totalPlanned = 0;
            let totalActual = 0;
            const breakdown = {};
            const projectItems = [];

            items.forEach(item => {
                // Filter and calculate based on necessary cost fields
                if (item.rate && item.plannedQty !== undefined && item.actualQty !== undefined) {
                    
                    const plannedCost = (item.rate * (item.plannedQty || 0));
                    const actualCost = (item.rate * (item.actualQty || 0));
                    const variance = plannedCost - actualCost;
                    
                    const processedItem = {
                        title: item.title,
                        page: item.page || 'Uncategorized', 
                        plannedCost: plannedCost,
                        actualCost: actualCost,
                        variance: variance
                    };
                    projectItems.push(processedItem);

                    totalPlanned += plannedCost;
                    totalActual += actualCost;

                    const category = processedItem.page;
                    if (!breakdown[category]) {
                        breakdown[category] = { planned: 0, actual: 0 };
                    }
                    breakdown[category].planned += plannedCost;
                    breakdown[category].actual += actualCost;
                }
            });
            
            // Calculate KPIs
            const costVariance = totalPlanned - totalActual;
            const cpi = totalActual > 0 ? (totalPlanned / totalActual) : 0; 
            const cvp = totalPlanned > 0 ? (costVariance / totalPlanned) : 0; 

            processedData = projectItems;
            summary = {
                totalPlanned,
                totalActual,
                costVariance,
                cpi,
                cvp,
                breakdown
            };

            renderDashboard();
        }
        
        // --- RENDERING FUNCTIONS ---
        
        /**
         * Updates the summary metrics and KPIs in the dashboard.
         */
        function renderSummaryMetrics() {
            // Standard Totals
            document.getElementById('planned-cost-sum').textContent = formatCurrency(summary.totalPlanned);
            document.getElementById('actual-cost-sum').textContent = formatCurrency(summary.totalActual);
            
            // CPI (Cost Performance Index)
            const cpiValue = document.getElementById('cpi-value');
            const cpiCard = document.getElementById('cpi-card');
            const cpiIcon = document.getElementById('cpi-icon');
            
            cpiValue.textContent = summary.cpi.toFixed(2);
            
            // Reset classes
            cpiValue.classList.remove('text-good', 'text-bad', 'text-neutral');
            cpiCard.classList.remove('border-good', 'border-bad', 'border-gray-500');
            cpiIcon.classList.remove('text-good', 'text-bad', 'text-neutral');
            cpiIcon.setAttribute('data-lucide', 'activity'); // Default icon
            
            if (summary.totalActual === 0) {
                 cpiValue.textContent = 'N/A';
                 cpiValue.classList.add('text-neutral');
                 cpiCard.classList.add('border-l-4', 'border-gray-500');
                 cpiIcon.classList.add('text-gray-500');
            } else if (summary.cpi >= 1.0) {
                cpiValue.classList.add('text-good');
                cpiCard.classList.add('border-l-4', 'border-good');
                cpiIcon.setAttribute('data-lucide', 'thumbs-up');
                cpiIcon.classList.add('text-good');
            } else {
                cpiValue.classList.add('text-bad');
                cpiCard.classList.add('border-l-4', 'border-bad');
                cpiIcon.setAttribute('data-lucide', 'alert-triangle');
                cpiIcon.classList.add('text-bad');
            }

            // CV% (Cost Variance Percentage)
            const cvpValue = document.getElementById('cvp-value');
            const cvpCard = document.getElementById('cvp-card');
            const cvpIcon = document.getElementById('cvp-icon');
            
            cvpValue.textContent = formatPercent(summary.cvp);
            
            // Reset classes
            cvpValue.classList.remove('text-good', 'text-bad', 'text-neutral');
            cvpCard.classList.remove('border-good', 'border-bad', 'border-gray-500');
            cvpIcon.classList.remove('text-good', 'text-bad', 'text-neutral');
            cvpIcon.setAttribute('data-lucide', 'percent'); // Default icon
            
            if (summary.totalPlanned === 0) {
                cvpValue.textContent = 'N/A';
                cvpValue.classList.add('text-neutral');
                cvpCard.classList.add('border-l-4', 'border-gray-500');
                cvpIcon.classList.add('text-gray-500');
            } else if (summary.cvp >= 0) {
                cvpValue.classList.add('text-good');
                cvpCard.classList.add('border-l-4', 'border-good');
                cvpIcon.setAttribute('data-lucide', 'trending-up');
                cvpIcon.classList.add('text-good');
            } else {
                cvpValue.classList.add('text-bad');
                cvpCard.classList.add('border-l-4', 'border-bad');
                cvpIcon.setAttribute('data-lucide', 'trending-down');
                cvpIcon.classList.add('text-bad');
            }
            
            lucide.createIcons();
        }

        /**
         * Generates the Chart.js graph for category breakdown.
         */
        function renderChart() {
            const breakdown = summary.breakdown;
            const labels = Object.keys(breakdown);
            const plannedData = labels.map(key => breakdown[key].planned);
            const actualData = labels.map(key => breakdown[key].actual);

            const ctx = document.getElementById('costBreakdownChart').getContext('2d');
            
            if (window.costChart) {
                window.costChart.destroy();
            }

            window.costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Planned Cost (INR)',
                            data: plannedData,
                            backgroundColor: '#3b82f6', 
                            borderColor: '#1d4ed8', 
                            borderWidth: 1,
                            borderRadius: 4,
                        },
                        {
                            label: 'Actual Cost (INR)',
                            data: actualData,
                            backgroundColor: '#f59e0b', 
                            borderColor: '#d97706', 
                            borderWidth: 1,
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5, 
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost (INR)',
                                color: '#9ca3af' 
                            },
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' } 
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e5e7eb' 
                            }
                        },
                        tooltip: {
                             callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        // Use INR format for tooltip
                                        label += formatCurrency(context.parsed.y); 
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the detailed items table.
         */
        function renderTable() {
            const tbody = document.getElementById('items-table-body');
            const emptyState = document.getElementById('table-empty-state');
            tbody.innerHTML = '';

            if (processedData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            processedData.forEach(item => {
                const varianceText = formatCurrency(Math.abs(item.variance));
                let varianceClass = 'text-gray-300';

                if (item.variance < 0) {
                    varianceClass = 'text-red-400 font-medium'; 
                } else if (item.variance > 0) {
                    varianceClass = 'text-green-400 font-medium'; 
                }

                const row = `
                    <tr class="hover:bg-gray-700 transition duration-150">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-200">${item.title}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-400 capitalize">${item.page}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-primary-300">${formatCurrency(item.plannedCost)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right text-amber-300">${formatCurrency(item.actualCost)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-right ${varianceClass}">${item.variance < 0 ? '-' : (item.variance > 0 ? '+' : '')}${varianceText.replace('₹', '')}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        /**
         * Main function to run all rendering steps.
         */
        function renderDashboard() {
            renderSummaryMetrics();
            renderChart();
            renderTable();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); 
            calculateCosts(); 
        });
    </script>
</body>
</html>