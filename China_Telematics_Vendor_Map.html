<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transight Trip Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f7fa; color: #333; }
        header { background: #005A9E; color: white; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 2.2em; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); letter-spacing: 1px; }
        .app-container, .report-container { max-width: 1800px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .dashboard { display: flex; flex-wrap: wrap; gap: 20px; }
        .panel { flex: 1; min-width: 450px; }
        .map-container { flex: 1.5; min-width: 500px; height: 80vh; border-radius: 8px; border: 1px solid #ccc; }
        h2, h3 { color: #2c3e50; padding-bottom: 5px; border-bottom: 1px solid #eee; }
        h3 { margin-top: 20px; }
        form input, form button { display: block; width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button, .file-upload-label { font-size: 14px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; margin-right: 5px; display: inline-block; text-align: center; }
        .btn-primary { background-color: #0078D4; color: white; }
        .btn-delete { background-color: #e74c3c; color: white; }
        .btn-secondary { background-color: #7f8c8d; color: white; }
        .file-upload-container { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 20px; border-radius: 5px; }
        .table-container { max-height: calc(80vh - 550px); overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        thead { background-color: #ecf0f1; position: sticky; top: 0; }
        .report-view { display: none; }
        .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #005A9E; padding-bottom: 10px; margin-bottom: 20px;}
        #trip-summary { background: #eaf5ff; border: 1px solid #bde0ff; padding: 15px; border-radius: 5px; margin-top: 20px; }
        #report-vendor-list { padding-left: 0; }
        #report-vendor-list li { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 10px; list-style: none; border-left: 5px solid #0078D4; cursor: grab; }
        #share-buttons { margin-top: 20px; }
        @media print {
            body { background: #fff; }
            .app-container, .report-header button, #share-buttons { display: none; }
            .report-container { box-shadow: none; margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="planner-view" class="app-container">
        <header><h1>Transight Trip Planner</h1></header>
        <main class="dashboard">
            <div class="panel">
                <h3>Manage Vendors</h3>
                <form id="vendor-form">
                    <input type="hidden" id="vendor-id" />
                    <input type="text" id="vendor-name" name="vendor-name" placeholder="Vendor Name" required />
                    <input type="text" id="vendor-component" name="vendor-component" placeholder="Component" required />
                    <input type="text" id="vendor-city" name="vendor-city" placeholder="City" required />
                    <input type="text" id="vendor-contact" name="vendor-contact" placeholder="Contact Info" />
                    <input type="text" id="vendor-address" name="vendor-address" placeholder="Full Address" />
                    <input type="text" id="vendor-landmark" name="vendor-landmark" placeholder="Nearby Landmark" />
                    <div>
                        <button type="button" id="geocode-btn" class="btn-secondary">Get Coordinates</button>
                        <span id="geocode-status"></span>
                    </div>
                    <input type="number" id="vendor-lat" name="vendor-lat" step="any" placeholder="Latitude" readonly />
                    <input type="number" id="vendor-lon" name="vendor-lon" step="any" placeholder="Longitude" readonly />
                    <button type="submit" class="btn-primary">Save Vendor</button>
                </form>

                <div class="file-upload-container">
                    <h3>Data Management</h3>
                    <button id="download-template-btn" class="btn-secondary">Download Template</button>
                    <input type="file" id="upload-excel" style="display: none;" accept=".xlsx, .xls"/>
                    <label for="upload-excel" class="btn-primary file-upload-label">Import Vendors</label>
                    <button id="export-vendors-btn" class="btn-primary">Export Vendors</button>
                </div>

                <h3>Current Vendor List</h3>
                <div class="table-container">
                    <table id="vendor-table">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Vendor</th>
                                <th>City</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button id="generate-report-btn" class="btn-primary">Generate English Report</button>
                <button id="generate-chinese-report-btn" class="btn-primary">Generate Chinese Report</button>
            </div>
            <div class="map-container" id="map"></div>
        </main>
    </div>
    <div id="report-view" class="report-view report-container">
        <header class="report-header">
            <h1 id="trip-title"></h1>
            <div>
                <button id="back-to-planner-btn" class="btn-secondary">Back to Planner</button>
                <button id="print-btn" class="btn-primary">Print Report</button>
            </div>
        </header>
        <div class="dashboard">
            <div class="panel">
                <h2 id="itinerary-title"></h2>
                <div id="trip-summary"></div>
                <ul id="report-vendor-list"></ul>
                <div id="share-buttons"></div>
            </div>
            <div id="report-map" class="map-container"></div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const VENDOR_STORAGE_KEY = 'transight_trip_planner_v4';
            let vendors = JSON.parse(localStorage.getItem(VENDOR_STORAGE_KEY)) || [];
            let markers = {}, reportMarkers = {}, routeControl = null, reportMap = null, sortable = null;

            const tileLayers = { en: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', zh: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' };
            const tileOptions = { en: { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 20 }, zh: { attribution: '&copy; OpenStreetMap' } };
            
            const mainMap = L.map('map').setView([35.8617, 104.1954], 4);
            L.tileLayer(tileLayers.en, tileOptions.en).addTo(mainMap);
            const osrmRouter = L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' });

            const vendorForm = document.getElementById('vendor-form'), vendorTableBody = document.querySelector('#vendor-table tbody'), geocodeBtn = document.getElementById('geocode-btn'), geocodeStatus = document.getElementById('geocode-status');

            const renderTable = () => {
                vendorTableBody.innerHTML = '';
                vendors.forEach(v => {
                    vendorTableBody.innerHTML += `<tr><td><input type="checkbox" class="vendor-select" data-vendor-id="${v.id}"></td><td>${v.name}</td><td>${v.city}</td><td><button onclick="window.editVendor('${v.id}')" class="btn-secondary">Edit</button><button onclick="window.deleteVendor('${v.id}')" class="btn-delete">Delete</button></td></tr>`;
                });
                updateMarkers(mainMap, markers, vendors);
            };

            const updateMarkers = (map, markerStore, target) => {
                Object.values(markerStore).forEach(m => m.remove());
                markerStore = {};
                target.forEach(v => {
                    if (v.lat && v.lon) {
                        markerStore[v.id] = L.marker([v.lat, v.lon]).addTo(map).bindTooltip(v.name, { permanent: true, direction: 'right', offset: [10, 0] }).openTooltip();
                    }
                });
            };

            const saveAndRefresh = () => {
                localStorage.setItem(VENDOR_STORAGE_KEY, JSON.stringify(vendors));
                renderTable();
            };

            window.editVendor = (id) => {
                const v = vendors.find(x => x.id === id);
                if (v) {
                    Object.keys(v).forEach(key => {
                        const formEl = vendorForm.elements[`vendor-${key}`];
                        if (formEl) {
                            formEl.value = v[key] || '';
                        }
                    });
                }
            };

            window.deleteVendor = (id) => {
                if (confirm('Are you sure you want to delete this vendor?')) {
                    vendors = vendors.filter(v => v.id !== id);
                    saveAndRefresh();
                }
            };

            async function geocodeCity(city) {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
                try {
                    const r = await fetch(url);
                    const d = await r.json();
                    if (d && d.length > 0) return { lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon) };
                } catch (e) {
                    console.error('Geocoding error:', e);
                }
                return null;
            }
            
            vendorForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = vendorForm['vendor-id'].value;
                const data = { id: id || Date.now().toString(), name: vendorForm['vendor-name'].value, component: vendorForm['vendor-component'].value, city: vendorForm['vendor-city'].value, contact: vendorForm['vendor-contact'].value, address: vendorForm['vendor-address'].value, landmark: vendorForm['vendor-landmark'].value, lat: parseFloat(vendorForm['vendor-lat'].value), lon: parseFloat(vendorForm['vendor-lon'].value) };
                if (!data.name || !data.city || isNaN(data.lat)) return alert('Name, City, and Coordinates are required.');
                const idx = vendors.findIndex(v => v.id === data.id);
                if (idx > -1) {
                    vendors[idx] = data;
                } else {
                    vendors.push(data);
                }
                saveAndRefresh();
                vendorForm.reset();
                geocodeStatus.textContent = '';
            });

            geocodeBtn.addEventListener('click', async () => {
                const city = vendorForm['vendor-city'].value.trim();
                if (!city) return;
                geocodeStatus.textContent = 'Geocoding...';
                const coords = await geocodeCity(city);
                if (coords) {
                    vendorForm['vendor-lat'].value = coords.lat;
                    vendorForm['vendor-lon'].value = coords.lon;
                    geocodeStatus.textContent = 'Found!';
                } else {
                    geocodeStatus.textContent = 'Not found.';
                }
            });

            document.getElementById('download-template-btn').addEventListener('click', () => {
                const ws = XLSX.utils.json_to_sheet([{ Name: 'Vendor', Component: 'Comp', City: 'City', Contact: '', Address: '', Landmark: '' }]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Vendors');
                XLSX.writeFile(wb, 'Vendor_Template.xlsx');
            });

            document.getElementById('upload-excel').addEventListener('change', async (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const d = new Uint8Array(evt.target.result);
                        const wb = XLSX.read(d, { type: 'array' });
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(ws);
                        alert(`Found ${json.length} vendors. Geocoding...`);
                        for (const item of json) {
                            const city = item.City || item.city;
                            let coords = null;
                            if (city) coords = await geocodeCity(city);
                            vendors.push({
                                id: Date.now().toString() + Math.random(),
                                name: item.Name || 'N/A',
                                component: item.Component || 'N/A',
                                city,
                                contact: item.Contact || '',
                                address: item.Address || '',
                                landmark: item.Landmark || '',
                                lat: coords?.lat,
                                lon: coords?.lon
                            });
                        }
                        saveAndRefresh();
                        alert('Upload complete!');
                    } catch (err) {
                        alert('Error processing file.');
                    }
                };
                reader.readAsArrayBuffer(f);
                e.target.value = '';
            });

            document.getElementById('export-vendors-btn').addEventListener('click', () => {
                if (vendors.length === 0) return alert('No vendors to export.');
                const ws = XLSX.utils.json_to_sheet(vendors);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Vendors');
                XLSX.writeFile(wb, 'Transight_Vendors_Export.xlsx');
            });

            const handleReportGeneration = (lang) => {
                const ids = Array.from(document.querySelectorAll('.vendor-select:checked')).map(cb => cb.dataset.vendorId);
                if (ids.length < 1) return alert('Select at least one vendor.');
                let selected = vendors.filter(v => ids.includes(v.id) && v.lat && v.lon);
                if (selected.length !== ids.length) alert('Some selected vendors are missing coordinates and were excluded.');
                if (selected.length > 1) selected = optimizeRoute(selected);
                document.getElementById('planner-view').style.display = 'none';
                document.getElementById('report-view').style.display = 'block';
                renderReport(selected, lang);
            };

            document.getElementById('generate-report-btn').addEventListener('click', () => handleReportGeneration('en'));
            document.getElementById('generate-chinese-report-btn').addEventListener('click', () => handleReportGeneration('zh'));
            document.getElementById('back-to-planner-btn').addEventListener('click', () => {
                document.getElementById('report-view').style.display = 'none';
                document.getElementById('planner-view').style.display = 'block';
            });
            document.getElementById('print-btn').addEventListener('click', () => window.print());

            function optimizeRoute(list) {
                if(list.length < 2) return list;
                let unvisited = [...list];
                let route = [unvisited.shift()];
                while (unvisited.length > 0) {
                    let lastLeg = route[route.length - 1];
                    let nearest = unvisited.reduce((prev, curr) => (L.latLng(lastLeg.lat, lastLeg.lon).distanceTo(L.latLng(prev.lat, prev.lon)) < L.latLng(lastLeg.lat, lastLeg.lon).distanceTo(L.latLng(curr.lat, curr.lon))) ? prev : curr);
                    route.push(nearest);
                    unvisited = unvisited.filter(v => v.id !== nearest.id);
                }
                return route;
            }

            const renderReport = (reportVendors, lang) => {
                const T = {
                    en: { title: `Transight Trip Report`, itinerary: "Itinerary (Drag to Reorder)", contact: "Contact", address: "Address", landmark: "Landmark", shareGoogle: "Share to Google Maps", shareAmap: "Share to Amap", summaryTitle: "Trip Summary", totalDistance: "Distance", totalDuration: "Duration", eta: "Est. Arrival", hours: "hr", minutes: "min" },
                    zh: { title: `Transight 行程报告`, itinerary: "行程顺序 (可拖动排序)", contact: "联系方式", address: "地址", landmark: "附近地标", shareGoogle: "分享到谷歌地图", shareAmap: "分享到高德地图", summaryTitle: "行程摘要", totalDistance: "总距离", totalDuration: "预计时长", eta: "预计到达", hours: "小时", minutes: "分钟" }
                }[lang];

                document.getElementById('trip-title').innerHTML = T.title;
                document.getElementById('itinerary-title').innerHTML = T.itinerary;

                const list = document.getElementById('report-vendor-list');
                list.innerHTML = '';
                reportVendors.forEach(v => {
                    list.innerHTML += `<li data-id="${v.id}"><strong>${v.name}</strong><br><strong>${T.contact}:</strong> ${v.contact||'N/A'}<br><strong>${T.address}:</strong> ${v.address||'N/A'}<br><strong>${T.landmark}:</strong> ${v.landmark||'N/A'}</li>`;
                });

                if (!reportMap) {
                    reportMap = L.map('report-map', { preferCanvas: true }).setView([35.8617, 104.1954], 5);
                }
                if (window.reportTileLayer) window.reportTileLayer.remove();
                window.reportTileLayer = L.tileLayer(tileLayers[lang], tileOptions[lang]).addTo(reportMap);

                drawReportRoute(reportVendors, T);

                if (sortable) sortable.destroy();
                sortable = new Sortable(list, {
                    animation: 150,
                    onEnd: () => {
                        const newOrder = Array.from(list.children).map(li => vendors.find(v => v.id === li.dataset.id));
                        renderReport(newOrder, lang);
                    }
                });
            };

            function drawReportRoute(routeVendors, T) {
                updateMarkers(reportMap, reportMarkers, routeVendors);
                if (routeControl) routeControl.remove();
                document.getElementById('trip-summary').innerHTML = '';
                document.getElementById('share-buttons').innerHTML = '';
                
                if (routeVendors.length > 1) {
                    const waypoints = routeVendors.map(v => L.latLng(v.lat, v.lon));
                    routeControl = L.Routing.control({
                        waypoints,
                        router: osrmRouter,
                        show: false,
                        addWaypoints: false,
                        lineOptions: { styles: [{ color: '#0078D4', opacity: 0.8, weight: 5 }] }
                    }).on('routesfound', e => {
                        displayTripSummary(e.routes[0].summary, T);
                        generateShareLinks(routeVendors, T);
                    }).addTo(reportMap);
                    reportMap.fitBounds(L.latLngBounds(waypoints), { padding: [50, 50] });
                } else if (routeVendors.length === 1) {
                    reportMap.setView([routeVendors[0].lat, routeVendors[0].lon], 12);
                }
                setTimeout(() => { if (reportMap) reportMap.invalidateSize(); }, 100);
            }

            function displayTripSummary(summary, T) {
                const distanceKm = (summary.totalDistance / 1000).toFixed(1);
                const duration = summary.totalTime;
                const hours = Math.floor(duration / 3600), minutes = Math.floor((duration % 3600) / 60);
                const arrival = new Date(Date.now() + duration * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('trip-summary').innerHTML = `<h3>${T.summaryTitle}</h3><p><strong>${T.totalDistance}:</strong> ${distanceKm} km<br><strong>${T.totalDuration}:</strong> ${hours} ${T.hours} ${minutes} ${T.minutes}<br><strong>${T.eta}:</strong> ${arrival}</p>`;
            }

            function generateShareLinks(routeVendors, T) {
                const shareDiv = document.getElementById('share-buttons');
                if (routeVendors.length < 1) return shareDiv.innerHTML = '';
                let googleUrl = `https://www.google.com/maps/dir/?api=1&origin=${routeVendors[0].lat},${routeVendors[0].lon}&destination=${routeVendors[routeVendors.length-1].lat},${routeVendors[routeVendors.length-1].lon}&waypoints=${routeVendors.slice(1,-1).map(v=>`${v.lat},${v.lon}`).join('|')}&travelmode=driving`;
                let amapUrl = `amapuri://route/plan/?dests=${routeVendors.map(v=>`${v.lon},${v.lat},${v.name}`).join(';')}&path=0&t=0&dev=0`;
                shareDiv.innerHTML = `<h3>Share Route</h3><a href="${googleUrl}" target="_blank" class="btn-primary">${T.shareGoogle}</a><a href="${amapUrl}" class="btn-primary">${T.shareAmap}</a>`;
            }

            if (vendors.length === 0) {
                vendors = [
                    { id: '1', name: 'Vendor A (GPS)', component: 'GPS Module', city: 'Shenzhen', contact: 'sales@vendora.cn', address: '123 Tech Rd', landmark: 'High-Tech Park', lat: 22.5431, lon: 114.0579 },
                    { id: '2', name: 'Vendor B (MCU)', component: 'Microcontroller', city: 'Shanghai', contact: '+86 21 8888 9999', address: '456 Innovation Ave', landmark: 'Finance Tower', lat: 31.2304, lon: 121.4737 },
                    { id: '3', name: 'Vendor C (GSM)', component: 'GSM Module', city: 'Guangzhou', contact: 'info@vendorc.com', address: '789 Trade Blvd', landmark: 'Canton Fair', lat: 23.1291, lon: 113.2644 }
                ];
            }
            saveAndRefresh();
        });
    </script>
</body>
</html>
